<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Squid's Blog</title>
  <meta name="author" content="Carin Meier">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://gigasquid.github.io/blog/page/10/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Squid's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://gigasquid.github.io/blog/page/10/">
  <meta property="og:title" content="Squid's Blog">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      
      <div id="banner-image">
        <div class="layer">
          <div id="banner-text">
            <h1 class="page-title">Squid's Blog</h1>
            <p class="page-desc">
              Random and Sometimes Useful Thoughts About Technology.<br>
            </p>
            <br>
            <br>
            <div class="page-links center">
              <ul class="index-nav">
                  <li ><a href="/blog/archives">Archives</a></li>
<li ><a href="/about">About</a></li>
<li ><a href="/books">Books</a></li>
<li ><a href="/speaking">Speaking</a></li>

              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Squid's Blog" />
    
    <meta itemprop="url" content="http://gigasquid.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-06-11T23:57:52+00:00"  data-updated="true" itemprop="datePublished dateCreated">Sat 11 Jun 2011, 11:57 PM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/06/11/super-easy-clojure-web-apps-with-heroku-cedar/" itemprop="url">Super Easy Clojure Web Apps With Heroku Cedar</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Deploying Clojure apps with a single command to the cloud is now possible with Heroku Cedar and let me tell you, it is pure joy.</p>

<p>I experimented with this the other day by creating a Compojure web application that compares the followers that two twitter users have in common.</p>

<p>Here is the secret sauce you need to push your apps to Heroku:</p>

<p>1) <strong>Procfile: </strong>
You need to create a file in the root of your directory that contains the way to start up your application:</p>

<pre><code> web: lein run -m ring-twitter-common.core
</code></pre>

<p>2) The application must have the project.clj setup correctly so that you can just run:</p>

<pre><code>lein deps
</code></pre>

<p>3) You need to install the <a href="https://github.com/heroku/heroku">Heroku gem</a></p>

<p>Once you have this setup you simply do:</p>

<pre><code>heroku create --stack cedar




git push heroku master
</code></pre>

<p>That&rsquo;s it. Your webapp will auto-magically be created, and deployed and be available for your viewing pleasure.</p>

<p>You can check out  my sample Twitter Heroku app here:
<a href="http://ring-twitter-common.herokuapp.com/">http://ring-twitter-common.herokuapp.com/</a></p>

<p>But wait, you say&hellip; wouldn&rsquo;t it be awesome if you could just write your Clojure app and say lein deploy and have it all work? Wouldn&rsquo;t it be super awesome if there was some command to generate a skeleton for your Compojure app? The solution is actually in the planning stages by James Reeves (weavejester)!  Hooray!</p>

<p><a href="http://groups.google.com/group/leiningen/browse_thread/thread/1f3fbb808542adc6">Leiningen Google Group Text</a></p>

<p>In summary:  Developing Clojure Web Apps just got easier and the future is only looking up :)</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-05-05T16:42:13+00:00"  data-updated="true" itemprop="datePublished dateCreated">Thu  5 May 2011,  4:42 PM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/05/05/mocking-ajax-calls-with-jasmine/" itemprop="url">Mocking Ajax Calls With Jasmine</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>I have been happily using <a href="https://github.com/pivotal/jasmine/">Jasmine</a> and <a href="https://github.com/velesin/jasmine-jquery">Jasmine-JQuery</a> on a project with great success. However, I was still unsure about how to handle mocking the ajax calls back to the server. It turns out the answer is already in Jasmine. Time to call out the spies!</p>

<p>There is a wiki page on spies <a href="https://github.com/pivotal/jasmine/wiki/Spies">https://github.com/pivotal/jasmine/wiki/Spies</a>, but I always enjoy a nice code sample.</p>

<p>In my source file I have an ajax call that I would like to mock that looks like this:
[gist id=957387]</p>

<p>Now in my spec file - I setup a spy on the ajax call and use andCallFake to mock the call. When the method is tested, the ajax call will be mocked and return through the success handler. You can pass data back through the fakeData var.
[gist id=957389]</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-05-01T14:02:39+00:00"  data-updated="true" itemprop="datePublished dateCreated">Sun  1 May 2011,  2:02 PM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/05/01/hacking-javascript-for-the-love-of-clojure/" itemprop="url">Hacking JavaScript for the Love of Clojure</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Lately, I have been working on the awesome open source project <a href="http://www.4clojure.com/">4Clojure.com</a>. The site helps you to learn Clojure by solving “koan” type problems in an interactive format. One of the enhancements that I was looking at putting in was a way to enter code in a text box and have it color highlight as type. I found the <a href="http://ace.ajax.org/">ACE project</a>, which looked like exactly what I wanted. However, sad panda, they didn&rsquo;t have a Clojure mode. Not deterred, I decided that I would try to take a crack at it. I ported most of the rules from the Clojure brush in Syntax Highlighter over and implemented some basic auto-indent.</p>

<p>The Github source has been added to the main project at Ace <a href="https://github.com/ajaxorg/ace">https://github.com/ajaxorg/ace</a>
You can see it in action on the 4Clojure.com site here: <a href="http://www.4clojure.com/problem/14">http://www.4clojure.com/problem/14</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-04-16T03:11:29+00:00"  data-updated="true" itemprop="datePublished dateCreated">Sat 16 Apr 2011,  3:11 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/04/16/yellow-belt-katas-for-ruby-and-clojure/" itemprop="url">Yellow Belt Katas for Ruby and Clojure</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>I have put a couple projects out on GitHub to help people get started with Clojure and Ruby.
The Katas are taken more or less from the Coding Kata site <a href="http://codingkata.org/katas/">http://codingkata.org/katas/</a>. The projects both include the basic project setup for you to get started with TDD beginner katas.</p>

<p>The Ruby project has tests in the form of rspec-given, which is quite fun. The Clojure project has tests in the form of Midje, which has a lovely syntax.</p>

<p>Please give them a try :)</p>

<p><a href="https://github.com/gigasquid/yellow_belt_ruby_katas">https://github.com/gigasquid/yellow_belt_ruby_katas</a>
<a href="https://github.com/gigasquid/yellow_belt_clojure_katas">https://github.com/gigasquid/yellow_belt_clojure_katas</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-04-12T02:02:05+00:00"  data-updated="true" itemprop="datePublished dateCreated">Tue 12 Apr 2011,  2:02 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/04/12/knights-who-say-monad/" itemprop="url">Knights Who Say Monad</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><img src="http://farm6.staticflickr.com/5539/9925781235_e80904a961_o.jpg"></p>

<p>(*Sketch By My Awesome Husband)</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-04-08T02:02:09+00:00"  data-updated="true" itemprop="datePublished dateCreated">Fri  8 Apr 2011,  2:02 AM</time>
        
           | <a href="/blog/2011/04/08/on-thinking-in-ruby-and-clojure/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://gigasquid.github.io/blog/2011/04/08/on-thinking-in-ruby-and-clojure/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/04/08/on-thinking-in-ruby-and-clojure/" itemprop="url">On Thinking in Ruby and Clojure</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Recently, I decided to work on a set of code Katas.  I couldn&rsquo;t decide whether to do them in Ruby or Clojure, so I decided to do them in both.  I did the Kata in Ruby first and then immediately followed up with the same one in Clojure.  It was an interesting exercise, not only for the learning of the languages, but to highlight how I thought about the problems differently depending on the language.</p>

<p>Ruby is a fantastic language.  It would delight and sometimes surprise me with how elegant and natural it was to solve problems.  When I approached the Kata, I found myself thinking, “How can I make this more readable?”.   Ruby never failed to please.</p>

<p>Clojure is also a wonderful language.  One of the things that I really enjoy about it is that it changed that way that I approach problems.  This was particularly evident when I turned to solve the same problem in Ruby that I just had in Clojure.  First and foremost, I thought about the data.  Then about how the data could be transformed.  The transformation isn&rsquo;t like the serial steps that you normally take to hold the data in your hand and bit by bit mold it into the result – like a sculptor with clay.  It is the kind of transformation that takes a rolled ball of yarn and transforms into a beautiful lace pattern.</p>

<p>The closest that I had come to this functional way of thinking was when I was doing some heavy SQL and database work.  I went to a talk by Jay Pipes on MySQL.  I remember him saying that to be really good at SQL, you needed to think in sets.  You couldn&rsquo;t effectively solve the queries with the regular programming for-loop construct.  You needed to think of the sets of data joining and intersecting and the transformations needed to be applied to the data elements.  The same focus on the data seemed to hold true for Clojure too.</p>

<p>I highly recommend both Ruby and Clojure as programming languages.  Each are dynamic, elegant and powerful and a lot of fun.  Next time you sit down to do a Kata, and can&rsquo;t decide what language to use, try them both – and let me know how you think&hellip;</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-03-01T02:43:29+00:00"  data-updated="true" itemprop="datePublished dateCreated">Tue  1 Mar 2011,  2:43 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/03/01/bowling-game-kata-in-clojure-with-stm-and-defrecord/" itemprop="url">Bowling Game Kata in Clojure With STM and Defrecord</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>We took our kids bowling for the first time the other day. I have to admit, that I am not a great bowler. I had only been bowling two or three times in my life previous to that event and I was very thankful that those bumpers were up. The computer program malfunctioned in the final frames of our last game. I realized then, that I really had no idea how to score bowling. Later that night, in my surfing, I came across a reference to the <a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata">Bowling Game Kata</a>.</p>

<p>Such Kata serendipity could not be ignored. I decided to implement it in Clojure using defrecords to mimic the object model with Frames and the Game and use STM to keep the state of the Game in an atom. Finally, the unit tests are using <a href="https://github.com/marick/Midje">Midje</a> facts – which has a syntax that I enjoy.</p>

<p>All in all, it was a great learning exercise and as a bonus&hellip; I know how to score a bowling game now!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-01-18T03:01:47+00:00"  data-updated="true" itemprop="datePublished dateCreated">Tue 18 Jan 2011,  3:01 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/01/18/vampire-slaying-in-clojure-with-stm-part-2/" itemprop="url">Vampire Slaying in Clojure With STM - Part 2</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>In Part 1, we used defrecords to create a vampire slayer named “Buffy” and a few vampires for her to kick around.  Today we are going to use Buffy and her vampires to explore STM (Software Transactional Memory) in Clojure for managing state.</p>

<p>Recap</p>

<pre><code>(defrecord Vampire [name, health])
(def vampire1 (Vampire. "Stu" 50))
(def vampire2 (Vampire. "Vance" 100))
(def vampire3 (Vampire. "Izzy" 75))

(defrecord Slayer [name, weapon])
(def kungfu 25)
(def buffy (Slayer. "Buffy" kungfu))

(defn hit [vampire, hitpoints]
  (- (:health vampire) hitpoints))

;vampires don't fight back but it takes time to kill them
(def combat-time 20)

(defn hit-vampire [vampire, slayer]
  (Thread/sleep (* combat-time 10))
  (assoc vampire :health (hit vampire (:weapon slayer))))

(defn kill-vampire [vampire, slayer]
  (if (&gt; (:health vampire) 1)
    (recur (hit-vampire vampire slayer) slayer)
    (assoc vampire :health 0)))
</code></pre>

<p>Let&rsquo;s take our vampires and stand them up in a line for Buffy to fight.  We are also going to create a function that just has Buffy killing a vampire, rather then a generic slayer.</p>

<pre><code>(def vampire-line [vampire1 vampire2 vampire3])

(defn buffy-kill-vampire [vampire]
  (kill-vampire vampire buffy))
</code></pre>

<p>Test Buffy killing vampire1</p>

<pre><code>(buffy-kill-vampire vampire1)
#:user.Vampire{:name "Stu", :health 0}
</code></pre>

<p>Now we can use the map function to apply the buffy-kill-vampire function to every vampire in our vampire line.</p>

<pre><code>(map buffy-kill-vampire vampire-line)
(#:user.Vampire{:name "Stu", :health 0} #:user.Vampire{:name "Vance", :health 0} #:user.Vampire{:name "Izzy", :health 0})
</code></pre>

<p>This is also a good time to bring up pmap (pmap f coll).  The pmap is the same as the map execpt that it applys the function to the collection in parallel.  It is useful when the time to process each function is computationally intensive.  To show the difference between map and pmap let&rsquo;s change the combat-time to be 200ms instead of 20ms and time each way.  We need a dorun to force the function to not be lazy.</p>

<pre><code>(def combat-time 200)

(time (dorun (map buffy-kill-vampire vampire-line)))
"Elapsed time: 18002.67764 msecs"

(time (dorun (pmap buffy-kill-vampire vampire-line)))
"Elapsed time: 8001.808821 msecs
</code></pre>

<p>Now if you notice, even though we have be killing the vampire line over and over again.  They don&rsquo;t stay dead</p>

<pre><code>vampire-line
[#:user.Vampire{:name "Stu", :health 50} #:user.Vampire{:name "Vance", :health 100} #:user.Vampire{:name "Izzy", :health 75}]
</code></pre>

<p>We need to involve some state so that our vampire-line will reflect the health of zero for all of the vampires once Buffy slays them.  In Clojure, state is handled by Software Transactional Memory (STM).  You can use Refs for coordinated and synchronous updates, Atoms for Uncoordinated and Synchronous updates, or Agents for asynchronous updates.  In our example, we are going to use the Atom, since it is lighter weight and we just want to maintain the state of the vampire-line.</p>

<p>Let&rsquo;s refine the vampire-line as an atom.  We</p>

<pre><code>(def vampire-line (atom [vampire1 vampire2 vampire3]))
</code></pre>

<p>We need to deference it now to know it&rsquo;s value</p>

<pre><code>@vampire-line
[#:user.Vampire{:name "Stu", :health 50} #:user.Vampire{:name "Vance", :health 100} #:user.Vampire{:name "Izzy", :health 75}]
</code></pre>

<p>Now we are going to redefine the buffy-destroy-all-vampires function to use the reset! function to update its value.  We also need to convert the result to a vector before calling reset!  Also note that we need to deference the vampire-line value when call using map.</p>

<pre><code>(defn buffy-destroy-all-vampires []
  (reset! vampire-line (vec (map buffy-kill-vampire @vampire-line))))
</code></pre>

<p>Now let&rsquo;s see what happens when Buffy kills them</p>

<pre><code> @vampire-line
[#:user.Vampire{:name "Stu", :health 0} #:user.Vampire{:name "Vance", :health 0} #:user.Vampire{:name "Izzy", :health 0}]

(buffy-destroy-all-vampires)
[#:user.Vampire{:name "Stu", :health 0} #:user.Vampire{:name "Vance", :health 0} #:user.Vampire{:name "Izzy", :health 0}]

 @vampire-line
[#:user.Vampire{:name "Stu", :health 0} #:user.Vampire{:name "Vance", :health 0} #:user.Vampire{:name "Izzy", :health 0}]
</code></pre>

<p>The vampires are finally dead and staying dead!  Score one for the good guys!</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2011-01-12T03:33:43+00:00"  data-updated="true" itemprop="datePublished dateCreated">Wed 12 Jan 2011,  3:33 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2011/01/12/vampire-slaying-with-clojure-part-1-defrecord/" itemprop="url">Vampire Slaying With Clojure - Part 1 Defrecord</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>It&rsquo;s time to learn more Clojure.  This time, Buffy the Vampire Slayer* is going to help us.</p>

<p>First things first, of course we need vampires!</p>

<p>Let&rsquo;s create a vampire data type with defrecord.  Our vampires are going to have two attributes, their name and the number of health points that they have.  This is of course, how Buffy is going to slay them.  If a vampire&rsquo;s health points goes to zero, then they are dead.  Well, they already are undead&hellip; so let&rsquo;s say they are slayed at that point and turn into dust.</p>

<p>Our first vampire&rsquo;s name is Stu and he has a health of 50.</p>

<pre><code>(defrecord Vampire [name, health]) 
(def vampire1 (Vampire. "Stu" 50))
</code></pre>

<p>When we type in the vampire1 value into the REPL we can see its values in a map format</p>

<pre><code> vampire1
#:user.Vampire{:name "Stu", :health 50}
</code></pre>

<p>Now we can access vampire1&rsquo;s name by using the keys defined in the defrecord.  Let&rsquo;s get his name.</p>

<pre><code>(:name vampire1)
"Stu"
</code></pre>

<p>And his health</p>

<pre><code>(:health vampire1)
50
</code></pre>

<p>Lovely.  But we are going to need more than one vampire for Buffy to fight.  Let&rsquo;s create some more.</p>

<pre><code>(def vampire1 (Vampire. "Stu" 50))
(def vampire2 (Vampire. "Vance" 100))
(def vampire3 (Vampire. "Izzy" 75))
</code></pre>

<p>Alright.  Our evil doers are ready for a fight.  Where is our hero?  We need to create a slayer structure using defrecord like before.  Our vampire slayer is going to have a name and a weapon that is worth a certain number of hit points.  Buffy is such a hard case that she is just going to use her bare hands.  We&rsquo;ll define her kungfu to be worth 25 hit points.</p>

<pre><code>(defrecord Slayer [name, weapon])
(def kungfu 25)
(def buffy (Slayer. "Buffy" kungfu))
</code></pre>

<p>Let&rsquo;s check to make sure Buffy is ready to go</p>

<pre><code>(:name buffy)
"Buffy"
(:weapon buffy)
25
</code></pre>

<p>We have our main characters.  Now we need a way for Buffy to hit the vampires.  A simple function will do.  We define a function that takes the vampire and the number of hitpoints and subtracts it from the vampire&rsquo;s health.  This gives us the new health of the vampire</p>

<pre><code>(defn hit [vampire, hitpoints]
  (- (:health vampire) hitpoints))

(hit vampire1 20)
30
</code></pre>

<p>Now let&rsquo;s take that one step further and create another function that allows the slayer to hit the vampire with his/her weapon.  We use out hit function and pass it the weapon of the slayer.  Then we change the value of the vampire&rsquo;s health to the new value with assoc.  The function returns a new vampire structure with the new decremented health.</p>

<pre><code>(defn hit-vampire [vampire, slayer]
  (assoc vampire :health (hit vampire (:weapon slayer))))

 (hit-vampire vampire1 buffy)
#:user.Vampire{:name "Stu", :health 25}
</code></pre>

<p>Our vampires are totally lame, they don&rsquo;t fight back, (at least in this code example), but it does take time for Buffy to kill them.  Let&rsquo;s define a time that it take for her to hit a vampire.</p>

<pre><code>(def combat-time 20)
</code></pre>

<p>We&rsquo;ll go back and redefine the hit-vampire function to include a sleep</p>

<pre><code>(defn hit-vampire [vampire, slayer]
  (Thread/sleep (* combat-time 10))
  (assoc vampire :health (hit vampire (:weapon slayer))))
</code></pre>

<p>Now we can see how much time it takes Buffy to hit vampire1</p>

<pre><code> (time (hit-vampire vampire1 buffy))
"Elapsed time: 200.454173 msecs"
#:user.Vampire{:name "Stu", :health 25}
</code></pre>

<p>This is nice, but we really want a way to define a function to recursively have the slayer keep hitting the vampire until it is dead.  If the health of the vampire is less than 1, then then we will set the vampire&rsquo;s health to 0 and return the vampire.  Note that we use recur in the function to denote the recursive call.</p>

<pre><code>(defn kill-vampire [vampire, slayer]
  (if (&gt; (:health vampire) 1)
    (recur (hit-vampire vampire slayer) slayer)
    (assoc vampire :health 0)))
</code></pre>

<p>Testing it out with Buffy killing Stu the vampire1</p>

<pre><code>(kill-vampire vampire1 buffy)
#:user.Vampire{:name "Stu", :health 0}
</code></pre>

<p>How long does it take Buffy to kill Stu? Not long.</p>

<pre><code>(time (kill-vampire vampire1 buffy))
"Elapsed time: 400.542595 msecs"
#:user.Vampire{:name "Stu", :health 0}
</code></pre>

<p>What about a tougher vampire like vampire2?</p>

<pre><code>vampire2
#:user.Vampire{:name "Vance", :health 100}

(time (kill-vampire vampire2 buffy))
"Elapsed time: 801.318529 msecs"
#:user.Vampire{:name "Vance", :health 0}
</code></pre>

<p>For fun, let&rsquo;s redefine Buffy and give her some Holy Water as a weapon and see what happens.</p>

<pre><code>(def holy-water 100)
(def buffy (Slayer. "Buffy" holy-water))

(time (kill-vampire vampire2 buffy))
"Elapsed time: 200.247375 msecs"
#:user.Vampire{:name "Vance", :health 0}
</code></pre>

<p>So there you have it.  We have explored defrecord and created some vampires for the express purpose of hitting.  Not a bad way to blow off steam at the end of the day.</p>

<p>Stay tuned for part 2, where Buffy will line up the vampires and kill them using Clojure&rsquo;s STM (Software Transaction Memory System) so they stay dead (or undead).</p>

<ul>
<li>If you are a lawyer and object to Buffy the Vampire Slayer appearing in an code snippets as a Clojure var, please contact me and I will change the name to Biffy or Tiffy.</li>
</ul>


<p>_Lego Vampire: <a href="http://www.flickr.com/photos/pasukaru76/4274684369_">http://www.flickr.com/photos/pasukaru76/4274684369_</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2010-12-08T04:06:50+00:00"  data-updated="true" itemprop="datePublished dateCreated">Wed  8 Dec 2010,  4:06 AM</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2010/12/08/123/" itemprop="url">Mutually Recursive Zombies on a Trampoline</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>It&rsquo;s late at night.  The kids are all tucked snuggly in their beds and I am ready to explore mutual recursion on my own in Clojure after doing some reading of <a href="http://pragprog.com/titles/shcloj/programming-clojure">Programming Clojure</a>.  What better subject to explore them with then zombies?  In this example we have two zombies – zombie1 and zombie2.   Let&rsquo;s represent each zombie as a sequence:</p>

<pre><code>(def zombie1 '("z1_head", "z1_r_arm" "z1_l_arm" "z1_torso" "z1_r_leg" "z1_l_leg"))

(def zombie2 '("z2_head", "z2_r_arm" "z2_l_arm" "z2_torso" "z2_r_leg" "z2_l_leg"))
</code></pre>

<p>zombie1 is ready to take a bite of zombie2&rsquo;s left leg, since it is nice and tasty there at the end.  Once zombie1 takes a bite, the body part will be added to its own sequence – but in the second position, so that the head is always first and ready to take another bite.  So, if zombie2 just stood still and let itself be eaten, after one bite, zombie1 would look like this</p>

<p>(z1_head,   z2_l_leg,   z1_r_arm,   z1_l_arm,   z1_torso,   z1_r_leg,   z1_l_leg)</p>

<p>But zombie2 is not just going to sit around and let itself be eaten, it is hungry too!  So it looks at zombie1&rsquo;s left leg hanging off there at the end and takes a bite whenever zombie1 takes a bite.</p>

<p>Let&rsquo;s define the functions.  Because they will be mutually recursive and call each, we need to declare the vars first:</p>

<pre><code>(declare zombie1_eats zombie2_eats)
</code></pre>

<p>Now let&rsquo;s define the zombie functions.  The zombie1_eats function will take 3 arguments, the first is the list that represents the eater (zombie1), the next is the list that represents the food (zombie2), and the last is the number of bites that zombie1 takes.  The function will return the list that represents zombie1.</p>

<pre><code>(defn zombie1_eats [eater,food,bites]
  (if (= 0 bites) eater
    (if (= 0 (count food)) eater
      (zombie2_eats
        (drop-last food)
        (cons (first eater) (cons (last food) (rest eater)) )
         bites))))

(defn zombie2_eats [eater, food bites]
  (if (= 0 bites) eater
    (if (= 0 (count food)) eater
      (zombie1_eats
        (drop-last food)
        (cons (first eater) (cons (last food) (rest eater)) )
         (dec bites)))))
</code></pre>

<p>After 0 bites:</p>

<pre><code>user=&gt; (zombie1_eats zombie1 zombie2 0)
("z1_head" "z1_r_arm" "z1_l_arm" "z1_torso" "z1_r_leg" "z1_l_leg")
</code></pre>

<p>After 1 bite</p>

<pre><code>user=&gt; (zombie1_eats zombie1 zombie2 1)
("z1_head" "z2_l_leg" "z1_r_arm" "z1_l_arm" "z1_torso" "z1_r_leg")
</code></pre>

<p>After 7 bites</p>

<pre><code>(user=&gt; (zombie1_eats zombie1 zombie2 7)
("z1_head" "z1_r_leg" "z1_l_leg" "z2_r_arm" "z2_l_arm" "z2_torso")
</code></pre>

<p>After 1007 bites</p>

<pre><code>user=&gt; (zombie1_eats zombie1 zombie2 1007)
("z1_head" "z1_r_leg" "z1_l_leg" "z2_r_arm" "z2_l_arm" "z2_torso")
</code></pre>

<p>After 5000 bites</p>

<pre><code>user=&gt; (zombie1_eats zombie1 zombie2 5000)
java.lang.StackOverflowError (NO_SOURCE_FILE:0)
</code></pre>

<p>Whoops we blew the stack!  Don&rsquo;t worry – put those zombies on a trampoline!</p>

<p>Clojure provides a function for optimizing mutual recursion.  The only thing that we need to do is to modify our zombie functions with a “#” to introduce an anonymous function.  Our new zombie methods are:</p>

<pre><code>(defn zombie1_eats [eater,food,bites]
  (if (= 0 bites) eater
    (if (= 0 (count food)) eater
      #(zombie2_eats
        (drop-last food)
        (cons (first eater) (cons (last food) (rest eater)) )
         bites))))

(defn zombie2_eats [eater, food bites]
  (if (= 0 bites) eater
    (if (= 0 (count food)) eater
      #(zombie1_eats
        (drop-last food)
        (cons (first eater) (cons (last food) (rest eater)) )
         (dec bites)))))
</code></pre>

<p>Now lets try again:</p>

<pre><code>user=&gt; (trampoline zombie1_eats zombie1 zombie2 5000)
("z1_head" "z1_r_arm" "z1_l_arm" "z1_torso" "z1_r_leg" "z1_l_leg")
</code></pre>

<p>No problem.  Even bigger&hellip;</p>

<pre><code> (trampoline zombie1_eats zombie1 zombie2 50004)
("z1_head" "z2_l_arm" "z2_torso" "z2_r_leg" "z2_l_leg" "z1_r_arm")
</code></pre>

<p>There are other techniques to solve this as well in Clojure.  In Stuart Holloway&rsquo;s book, he mentions converting to self-recursion, replacing recursion with laziness and shortcutting recursion with <a href="http://en.wikipedia.org/wiki/Memoization"> memoization</a>.</p>

<p>But for me, there is nothing more enjoyable than putting those zombies on a trampoline!</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2023 - Carin Meier<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/bhrigu123/abacus">abacus theme</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'squidsblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
