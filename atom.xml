<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Squid's Blog]]></title>
  <link href="http://gigasquid.github.io/atom.xml" rel="self"/>
  <link href="http://gigasquid.github.io/"/>
  <updated>2019-03-22T11:30:22-04:00</updated>
  <id>http://gigasquid.github.io/</id>
  <author>
    <name><![CDATA[Carin Meier]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Clojure MXNet March Update]]></title>
    <link href="http://gigasquid.github.io/blog/2019/03/22/clojure-mxnet-march-update/"/>
    <updated>2019-03-22T10:42:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2019/03/22/clojure-mxnet-march-update</id>
    <content type="html"><![CDATA[<p>I&rsquo;m starting a monthly update for <a href="http://mxnet.incubator.apache.org/">Clojure MXNet</a>. The goal is to share the progress and exciting things that are happening in the project and our community.</p>

<p>Here&rsquo;s some highlights for the month of March.</p>

<h2>Shipped</h2>

<p>Under the shipped heading, the 1.4.0 release of MXNet has been released, along with the <a href="https://search.maven.org/search?q=clojure%20mxnet">Clojure MXNet Jars</a>. There have been improvements to the JVM memory management and an Image API addition. You can see the full list of changes <a href="https://github.com/apache/incubator-mxnet/releases/tag/1.4.0#clojure">here</a></p>

<h2>Clojure MXNet Made Simple Article Series</h2>

<p><a href="https://arthurcaillau.com/about/">Arthur Caillau</a> authored a really nice series of blog posts to help get people started with Clojure MXNet.</p>

<ul>
<li><a href="https://arthurcaillau.com/mxnet-clojure-aws/">Getting started with Clojure and MXNet on AWS</a></li>
<li><a href="https://arthurcaillau.com/mxnet-made-simple-ndarrays-api/">MXNet made simple: Clojure NDArray API</a></li>
<li><a href="https://arthurcaillau.com/mxnet-made-simple-symbol-api/">MXNet made simple: Clojure Symbol API</a></li>
<li><a href="https://arthurcaillau.com/mxnet-made-simple-module-api/">MXNet made simple: Clojure Module API</a></li>
<li><a href="https://arthurcaillau.com/mxnet-made-simple-symbol-visualization/">MXNet made simple: Clojure Symbol Visualization API</a></li>
<li><a href="https://arthurcaillau.com/mxnet-made-simple-image-manipulation/">MXNet made simple: Image Manipulation with OpenCV and MXNet</a></li>
</ul>


<h2>Lein Template &amp; Docker file</h2>

<p><a href="https://github.com/hellonico/">Nicolas Modrzyk</a> created a Leiningen template that allows you to easily get a MXNet project started &ndash; with a notebook too! It&rsquo;s a great way to take Clojure MXNet for a spin</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># create project
</span><span class='line'>lein new clj-mxnet hello
</span><span class='line'>
</span><span class='line'># run included sample
</span><span class='line'>lein run
</span><span class='line'>
</span><span class='line'># start notebook engine
</span><span class='line'>lein notebook
</span><span class='line'>
</span><span class='line'># open notebook
</span><span class='line'>http://0.0.0.0:10000/worksheet.html?filename=notes/practice.clj
</span><span class='line'># open empty notebook with all namespaces
</span><span class='line'>http://0.0.0.0:10000/worksheet.html?filename=notes/empty.clj</span></code></pre></td></tr></table></div></figure>


<p>There also is a docker file as well</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker run -it -p 10000:10000 hellonico/mxnet
</span><span class='line'>
</span><span class='line'>After starting the container, you can open the same notebooks as above:
</span><span class='line'>
</span><span class='line'># open notebook
</span><span class='line'>http://0.0.0.0:10000/worksheet.html?filename=notes/practice.clj
</span><span class='line'># open empty notebook with all namespaces
</span><span class='line'>http://0.0.0.0:10000/worksheet.html?filename=notes/empty.clj</span></code></pre></td></tr></table></div></figure>


<h2>Cool Stuff in Development</h2>

<p>There are a few really interesting things cooking for the future.</p>

<p>One is a <a href="https://github.com/apache/incubator-mxnet/pull/14372">PR for memory fixes</a> from the Scala team that is getting really close to merging. This will be a solution to some the the memory problems that were encountered by early adopters of the Module API.</p>

<p>Another, is the <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=103092678">new version of the API for the Clojure NDArray and Symbol APIs</a> that is being spearheaded by Kedar Bellare</p>

<p>Finally, work is being started to create a <a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=103089990">Gluon API for the Clojure package</a> which is quite exciting.</p>

<h2>Get Involved</h2>

<p>As always, we welcome involvement in the true Apache tradition. If you have questions or want to say hi, head on over the the closest #mxnet room on your preferred server. We are on Clojurian&rsquo;s slack and Zulip.</p>

<h2>Cat Picture of the Month</h2>

<p>There is no better way to close out an update than a cat picture, so here is a picture of our family cat, Otto, watching birds at the window.</p>

<p><img src="https://farm8.staticflickr.com/7862/46718997174_13bf6e88ea_z.jpg"></p>

<p>Have a great rest of March!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Object Detection with Clojure MXNet]]></title>
    <link href="http://gigasquid.github.io/blog/2019/01/19/object-detection-with-clojure-mxnet/"/>
    <updated>2019-01-19T13:34:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2019/01/19/object-detection-with-clojure-mxnet</id>
    <content type="html"><![CDATA[<p><img src="https://c1.staticflickr.com/8/7837/32928474208_4960caafb3.jpg" alt="" /></p>

<p>Object detection just landed in MXNet thanks to the work of contributors <a href="https://github.com/kedarbellare">Kedar Bellare</a> and <a href="https://github.com/hellonico/">Nicolas Modrzyk</a>. Kedar ported over the <code>infer</code> package to Clojure, making inference and prediction much easier for users and Nicolas integrated in his <a href="https://github.com/hellonico/origami">Origami</a> OpenCV library into the the examples to make the visualizations happen.</p>

<p>We&rsquo;ll walk through the main steps to use the <code>infer</code> object detection which include creating the detector with a model and then loading the image and running the inference on it.</p>

<h3>Creating the Detector</h3>

<p>To create the detector you need to define a couple of things:</p>

<ul>
<li>How big is your image?</li>
<li>What model are you going to be using for object detection?</li>
</ul>


<p>In the code below, we are going to be giving it an color image of size 512 x 512.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-detector</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">descriptors</span> <span class="p">[{</span><span class="ss">:name</span> <span class="s">&quot;data&quot;</span>
</span><span class='line'>                      <span class="ss">:shape</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">512</span> <span class="mi">512</span><span class="p">]</span>
</span><span class='line'>                      <span class="ss">:layout</span> <span class="nv">layout/NCHW</span>
</span><span class='line'>                      <span class="ss">:dtype</span> <span class="nv">dtype/FLOAT32</span><span class="p">}]</span>
</span><span class='line'>        <span class="nv">factory</span> <span class="p">(</span><span class="nf">infer/model-factory</span> <span class="nv">model-path-prefix</span> <span class="nv">descriptors</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">infer/create-object-detector</span> <span class="nv">factory</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The shape is going to be <code>[1 3 512 512]</code>.

<ul>
<li>The <code>1</code> is for the batch size which in our case is a single image.</li>
<li>The <code>3</code> is for the channels in the image which for a RGB image is <code>3</code></li>
<li>The <code>512</code> is for the image height and width.</li>
</ul>
</li>
<li>The <code>layout</code> specifies that the shape given is in terms of <code>NCHW</code> which is batch size, channel size, height, and width.</li>
<li>The <code>dtype</code> is the image data type which will be the standard <code>FLOAT32</code></li>
<li>The <code>model-path-prefix</code> points to the place where the trained model we are using for object detection lives.</li>
</ul>


<p>The model we are going to use is the <a href="https://arxiv.org/abs/1512.02325">Single Shot Multiple Box Object Detector (SSD)</a>. You can download the model yourself using this <a href="https://github.com/apache/incubator-mxnet/blob/master/contrib/clojure-package/examples/infer/objectdetector/scripts/get_ssd_data.sh">script</a>.</p>

<h3>How to Load an Image and Run the Detector</h3>

<p>Now that we have a model and a detector, we can load an image up and run the object detection.</p>

<p>To load the image use <code>load-image</code> which will load the image from the path.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">infer/load-image-from-file</span> <span class="nv">input-image</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run the detection using <code>infer/detect-objects</code> which will give you the top five predictions by default.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">infer/detect-objects</span> <span class="nv">detector</span> <span class="nv">image</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will give an output something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[[{</span><span class="ss">:class</span> <span class="s">&quot;person&quot;</span>,
</span><span class='line'>   <span class="ss">:prob</span> <span class="mf">0.9657765</span>,
</span><span class='line'>   <span class="ss">:x-min</span> <span class="mf">0.021868259</span>,
</span><span class='line'>   <span class="ss">:y-min</span> <span class="mf">0.049295247</span>,
</span><span class='line'>   <span class="ss">:x-max</span> <span class="mf">0.9975169</span>,
</span><span class='line'>   <span class="ss">:y-max</span> <span class="mf">0.9734151</span><span class="p">}</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:class</span> <span class="s">&quot;dog&quot;</span>,
</span><span class='line'>   <span class="ss">:prob</span> <span class="mf">0.17513266</span>,
</span><span class='line'>   <span class="ss">:x-min</span> <span class="mf">0.16772352</span>,
</span><span class='line'>   <span class="ss">:y-min</span> <span class="mf">0.45792937</span>,
</span><span class='line'>   <span class="ss">:x-max</span> <span class="mf">0.55409217</span>,
</span><span class='line'>   <span class="ss">:y-max</span> <span class="mf">0.72507095</span><span class="p">}</span>
</span><span class='line'>   <span class="nv">...</span>
</span><span class='line'><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>which you can then use to draw bounding boxes on the image.</p>

<h3>Try Running the Example</h3>

<p><img src="https://c1.staticflickr.com/8/7804/31862638207_61be3a6e3c_b.jpg" alt="" /></p>

<p>One of the best ways to explore using it is with the <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package/examples/infer/objectdetector">object detection example</a> in the MXNet repo. It will be coming out officially in the <code>1.5.0</code> release, but you can get an early peek at it by building the project and running the example with the nightly snapshot.</p>

<p>You can do this by cloning the <a href="https://github.com/apache/incubator-mxnet">MXNet Repo</a> and changing directory to <code>contrib/clojure-package</code>.</p>

<p>Next, edit the <code>project.clj</code> to look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">org.apache.mxnet.contrib.clojure/clojure-mxnet</span> <span class="s">&quot;1.5.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:description</span> <span class="s">&quot;Clojure package for MXNet&quot;</span>
</span><span class='line'>  <span class="ss">:url</span> <span class="s">&quot;https://github.com/apache/incubator-mxnet&quot;</span>
</span><span class='line'>  <span class="ss">:license</span> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Apache License&quot;</span>
</span><span class='line'>            <span class="ss">:url</span> <span class="s">&quot;http://www.apache.org/licenses/LICENSE-2.0&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.9.0&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">t6/from-scala</span> <span class="s">&quot;0.3.0&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                 <span class="c1">;; To use with nightly snapshot</span>
</span><span class='line'>                 <span class="c1">;[org.apache.mxnet/mxnet-full_2.11-osx-x86_64-cpu &quot;&lt;insert-snapshot-version&gt;&quot;]</span>
</span><span class='line'>                 <span class="c1">;[org.apache.mxnet/mxnet-full_2.11-linux-x86_64-cpu &quot;&lt;insert-snapshot-version&gt;&quot;]</span>
</span><span class='line'>                 <span class="c1">;[org.apache.mxnet/mxnet-full_2.11-linux-x86_64-gpu &quot;&lt;insert-snapshot-version&quot;]</span>
</span><span class='line'>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.apache.mxnet/mxnet-full_2.11-osx-x86_64-cpu</span> <span class="s">&quot;1.5.0-SNAPSHOT&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                 <span class="c1">;;; CI</span>
</span><span class='line'>                 <span class="o">#</span><span class="nv">_</span><span class="p">[</span><span class="nv">org.apache.mxnet/mxnet-full_2.11</span> <span class="s">&quot;INTERNAL&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/tools.logging</span> <span class="s">&quot;0.4.0&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.apache.logging.log4j/log4j-core</span> <span class="s">&quot;2.8.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.apache.logging.log4j/log4j-api</span> <span class="s">&quot;2.8.1&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.slf4j/slf4j-log4j12</span> <span class="s">&quot;1.7.25&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">org.slf4j/slf4j-api</span><span class="p">]]]</span>
</span><span class='line'>  <span class="ss">:pedantic?</span> <span class="ss">:skip</span>
</span><span class='line'>  <span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">lein-codox</span> <span class="s">&quot;0.10.3&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">org.clojure/clojure</span><span class="p">]]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-cloverage</span> <span class="s">&quot;1.0.10&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">org.clojure/clojure</span><span class="p">]]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">lein-cljfmt</span> <span class="s">&quot;0.5.7&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:codox</span> <span class="p">{</span><span class="ss">:namespaces</span> <span class="p">[</span><span class="o">#</span><span class="s">&quot;^org\.apache\.clojure-mxnet\.(?!gen).*&quot;</span><span class="p">]}</span>
</span><span class='line'>  <span class="ss">:aot</span> <span class="p">[</span><span class="nv">dev.generator</span><span class="p">]</span>
</span><span class='line'>  <span class="ss">:repositories</span> <span class="p">[[</span><span class="s">&quot;staging&quot;</span> <span class="p">{</span><span class="ss">:url</span> <span class="s">&quot;https://repository.apache.org/content/repositories/staging&quot;</span>                  <span class="ss">:snapshots</span> <span class="nv">true</span>
</span><span class='line'>                             <span class="ss">:update</span> <span class="ss">:always</span><span class="p">}]</span>
</span><span class='line'>                 <span class="p">[</span><span class="s">&quot;snapshots&quot;</span> <span class="p">{</span><span class="ss">:url</span> <span class="s">&quot;https://repository.apache.org/content/repositories/snapshots&quot;</span>               <span class="ss">:snapshots</span> <span class="nv">true</span>
</span><span class='line'>                              <span class="ss">:update</span> <span class="ss">:always</span><span class="p">}]])</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are running on linux, you should change the <code>mxnet-full_2.11-osx-x86_64-cpu</code> to <code>mxnet-full_2.11-linux-x86_64-cpu</code>.</p>

<p>Next, go ahead and do <code>lein test</code> to make sure that everything builds ok. If you run into any trouble please refer to <a href="https://github.com/apache/incubator-mxnet/blob/master/contrib/clojure-package/README.md">README</a> for any missing dependencies.</p>

<p>After that do a <code>lein install</code> to install the <code>clojure-mxnet</code> jar to your local maven. Now you are ready to <code>cd examples/infer/object-detection</code> to try it out. Refer to the README for more details.</p>

<p>If you run into any problems getting started, feel free to reach out in the Clojurian #mxnet slack room or open an issue at the MXNet project. We are a friendly group and happy to help out.</p>

<p>Thanks again to the community for the contributions to make this possible. It&rsquo;s great seeing new things coming to life.</p>

<p>Happy Object Detecting!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to GAN a Flan]]></title>
    <link href="http://gigasquid.github.io/blog/2018/12/18/how-to-gan-a-flan/"/>
    <updated>2018-12-18T16:34:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2018/12/18/how-to-gan-a-flan</id>
    <content type="html"><![CDATA[<p>It&rsquo;s holiday time and that means parties and getting together with friends. Bringing a baked good or dessert to a gathering is a time honored tradition. But what if this year, you could take it to the next level? Everyone brings actual food. But with the help of Deep Learning, you can bring something completely different &ndash;  you can bring the <em>image</em> of baked good! I&rsquo;m not talking about just any old image that someone captured with a camera or created with a pen and paper. I&rsquo;m talking about the computer itself <strong>creating</strong>. This image would be never before seen, totally unique, and crafted by the creative process of the machine.</p>

<p>That is exactly what we are going to do. We are going to create a <em>flan</em></p>

<p><img src="https://c1.staticflickr.com/5/4065/4339500429_aa9c55f246_n.jpg" alt="Photo by Lucia Sanchez on Flickr" /></p>

<p>If you&rsquo;ve never had a flan before, it&rsquo;s a yummy dessert made of a baked custard with caramel sauce on it.</p>

<p>&ldquo;Why a flan?&rdquo;, you may ask. There are quite a few reasons:</p>

<ul>
<li>It&rsquo;s tasty in real life.</li>
<li>Flan rhymes with GAN, <em>(unless you pronounce it &ldquo;Gaaahn&rdquo;)</em>.</li>
<li>Why not?</li>
</ul>


<p>Onto the recipe. How are we actually going to make this work? We need some ingredients:</p>

<ul>
<li><a href="https://clojure.org/">Clojure</a> &ndash; the most advanced programming language to create generative desserts.</li>
<li><a href="https://mxnet.apache.org">Apache MXNet</a> &ndash; a flexible and efficient deep learning library that has a Clojure package.</li>
<li>1000-5000 pictures of flans &ndash; for Deep Learning you need data!</li>
</ul>


<h2>Gather Flan Pictures</h2>

<p>The first thing you want to do is gather your 1000 or more images with a <a href="https://github.com/montoyamoraga/scrapers">scraper</a>. The scraper will crawl google, bing, or instagram and download pictures of <em>mostly</em> flans to your computer. You may have to eyeball and remove any clearly wrong ones from your stash.</p>

<p>Next, you need to gather all these images in a directory and run a tool called <a href="https://github.com/apache/incubator-mxnet/blob/master/tools/im2rec.py">im2rec.py</a> on them to turn them into an <a href="https://mxnet.incubator.apache.org/tutorials/basic/data.html#loading-data-using-image-iterators">image record iterator</a> for use with MXNet. This will produce an optimized format that will allow our deep learning program to efficiently cycle through them.</p>

<p>Run:</p>

<pre><code>python3 im2rec.py --resize 28 root flan
</code></pre>

<p>to produce a <code>flan.rec</code> file with images resized to 28x28 that we can use next.</p>

<h2>Load Flan Pictures into MXNet</h2>

<p>The next step is to import the image record iterator into the MXNet with the <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package">Clojure API</a>. We can do this with the <code>io</code> namespace.</p>

<p>Add this to your require:</p>

<pre><code>[org.apache.clojure-mxnet.io :as mx-io]
</code></pre>

<p>Now, we can load our images:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flan-iter</span> <span class="p">(</span><span class="nf">mx-io/image-record-iter</span> <span class="p">{</span><span class="ss">:path-imgrec</span> <span class="s">&quot;flan.rec&quot;</span>
</span><span class='line'>                                         <span class="ss">:data-shape</span> <span class="p">[</span><span class="mi">3</span> <span class="mi">28</span> <span class="mi">28</span><span class="p">]</span>
</span><span class='line'>                                         <span class="ss">:batch-size</span> <span class="nv">batch-size</span><span class="p">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, that we have the images, we need to create our <code>model</code>. This is what is actually going to do the learning and creating of images.</p>

<h2>Creating a GAN model.</h2>

<p>GAN stands for <em>Generative Adversarial Network</em>. This is a incredibly cool deep learning technique that has two different models pitted against each, yet both learning and getting better at the same time. The two models are a generator and a discriminator. The generator model creates a new image from a random noise vector. The discriminator then tries to tell whether the image is a real image or a fake image. We need to create both of these models for our network.</p>

<p>First, the discriminator model. We are going to use the <code>symbol</code> namespace for the clojure package:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">discriminator</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">as-&gt;</span> <span class="p">(</span><span class="nf">sym/variable</span> <span class="s">&quot;data&quot;</span><span class="p">)</span> <span class="nv">data</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/convolution</span> <span class="s">&quot;d1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span>
</span><span class='line'>                           <span class="ss">:kernel</span> <span class="p">[</span><span class="mi">4</span> <span class="mi">4</span><span class="p">]</span>
</span><span class='line'>                           <span class="ss">:pad</span> <span class="p">[</span><span class="mi">3</span> <span class="mi">3</span><span class="p">]</span>
</span><span class='line'>                           <span class="ss">:stride</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">2</span><span class="p">]</span>
</span><span class='line'>                           <span class="ss">:num-filter</span> <span class="nv">ndf</span>
</span><span class='line'>                           <span class="ss">:no-bias</span> <span class="nv">true</span><span class="p">})</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/batch-norm</span> <span class="s">&quot;dbn1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:fix-gamma</span> <span class="nv">true</span> <span class="ss">:eps</span> <span class="nv">eps</span><span class="p">})</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/leaky-re-lu</span> <span class="s">&quot;dact1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:act-type</span> <span class="s">&quot;leaky&quot;</span> <span class="ss">:slope</span> <span class="mf">0.2</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a variable for the <code>data</code> coming in, (which is the picture of the flan), it then flows through the other layers which consist of convolutions, normalization, and activation layers. The last three layers actually repeat another two times before ending in the output, which tells whether it thinks the image was a fake or not.</p>

<p>The generator model looks similar:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">generator</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">as-&gt;</span> <span class="p">(</span><span class="nf">sym/variable</span> <span class="s">&quot;rand&quot;</span><span class="p">)</span> <span class="nv">data</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/deconvolution</span> <span class="s">&quot;g1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span>
</span><span class='line'>                             <span class="ss">:kernel</span> <span class="p">[</span><span class="mi">4</span> <span class="mi">4</span><span class="p">]</span>
</span><span class='line'>                             <span class="ss">:pad</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>                             <span class="ss">:stride</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                             <span class="ss">:num-filter</span>
</span><span class='line'>                             <span class="p">(</span><span class="nb">* </span><span class="mi">4</span> <span class="nv">ndf</span><span class="p">)</span> <span class="ss">:no-bias</span> <span class="nv">true</span><span class="p">})</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/batch-norm</span> <span class="s">&quot;gbn1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:fix-gamma</span> <span class="nv">true</span> <span class="ss">:eps</span> <span class="nv">eps</span><span class="p">})</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">sym/activation</span> <span class="s">&quot;gact1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:act-type</span> <span class="s">&quot;relu&quot;</span><span class="p">})</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nv">...</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>There is a variable for the <code>data</code> coming in, but this time it is a random noise vector. Another interesting point that is is using a <code>deconvolution</code> layer instead of a <code>convolution</code> layer. The generator is basically the inverse of the discriminator. It starts with a random noise vector, but that is translated up through the layers until it is expanded to a image output.</p>

<p>Next, we iterate through all of our training images in our <code>flan-iter</code> with <code>reduce-batches</code>. Here is just an excerpt where we get a random noise vector and have the generator run the data through and produce the output image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">mx-io/reduce-batches</span>
</span><span class='line'>       <span class="nv">flan-iter</span>
</span><span class='line'>       <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">n</span> <span class="nv">batch</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">rbatch</span> <span class="p">(</span><span class="nf">mx-io/next</span> <span class="nv">rand-noise-iter</span><span class="p">)</span>
</span><span class='line'>               <span class="nv">dbatch</span> <span class="p">(</span><span class="nf">mapv</span> <span class="nv">normalize-rgb-ndarray</span> <span class="p">(</span><span class="nf">mx-io/batch-data</span> <span class="nv">batch</span><span class="p">))</span>
</span><span class='line'>               <span class="nv">out-g</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">mod-g</span>
</span><span class='line'>                         <span class="p">(</span><span class="nf">m/forward</span> <span class="nv">rbatch</span><span class="p">)</span>
</span><span class='line'>                         <span class="p">(</span><span class="nf">m/outputs</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The whole code is <a href="https://github.com/gigasquid/mxnet-gan-flan">here</a> for reference, but let&rsquo;s skip forward and run it and see what happens.</p>

<p><img src="http://gigasquid.github.io/images/gout-96-0.jpg" alt="" /></p>

<p>FLANS!! Well, they could be flans if you squint a bit.</p>

<p>Now that we have them kinda working for a small image size 28x28, let&rsquo;s biggerize it.</p>

<h2>Turn on the Oven and Bake</h2>

<p>Turning up the size to 128x128 requires some alterations in the layers&#8217; parameters to make sure that it processes and generates the correct size, but other than that we are good to go.</p>

<p>Here comes the fun part, watching it train and learn:</p>

<h3>Epoch 0</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-0-0.jpg" alt="" /></p>

<p>In the beginning there was nothing but random noise.</p>

<h3>Epoch 10</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-10-0.jpg" alt="" /></p>

<p>It&rsquo;s beginning to learn colors! Red, yellow, brown seem to be important to flans.</p>

<h3>Epoch 23</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-23-0.jpg" alt="" /></p>

<p>It&rsquo;s learning shapes! It has learned that flans seem to be blob shaped.</p>

<h3>Epoch 33</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-33-0.jpg" alt="" /></p>

<p>It is moving into its surreal phase. Salvidor Dali would be proud of these flans.</p>

<h3>Epoch 45</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-45.jpg" alt="" /></p>

<p>Things take a weird turn. Does that flan have eyes?</p>

<h3>Epoch 68</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-128-68-0.jpg" alt="" /></p>

<p>Even worse. Are those demonic flans? Should we even continue down this path?</p>

<p>Answer: Yes &ndash; <strong>the training must go on..</strong></p>

<h3>Epoch 161</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-161-0.jpg" alt="" /></p>

<p>Big moment here. It looks like something that could possibly be edible.</p>

<h3>Epoch 170</h3>

<p><img src="http://gigasquid.github.io/images/flan-random-170-0.jpg" alt="" /></p>

<p>Ick! Green Flans! No one is going to want that.</p>

<h3>Epoch 195</h3>

<p><img src="http://gigasquid.github.io/images/explore-195.jpg" alt="" /></p>

<p>We&rsquo;ve achieved maximum flan, (for the time being).</p>

<h2>Explore</h2>

<p>If you are interested in playing around with the pretrained model, you can check it out <a href="https://github.com/gigasquid/mxnet-gan-flan/blob/master/src/mxnet_gan_flan/gan.clj#L355">here with the pretrained function</a>.
It will load up the trained model and generate flans for you to explore and bring to your dinner parties.</p>

<p>Wrapping up, training GANs is a <em>lot</em> of fun. With MXNet, you can bring the fun with you to Clojure.</p>

<p>Want more, check out this Clojure Conj video &ndash;  <a href="https://www.youtube.com/watch?v=yzfnlcHtwiY">Can You GAN?</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Clojure MXNet - The Module API]]></title>
    <link href="http://gigasquid.github.io/blog/2018/07/05/clojure-mxnet-the-module-api/"/>
    <updated>2018-07-05T19:39:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2018/07/05/clojure-mxnet-the-module-api</id>
    <content type="html"><![CDATA[<p><img src="https://cdn-images-1.medium.com/max/800/1*OoqsrMD7JzXAvRUGx_8_fg.jpeg"></p>

<p>This is an introduction to the high level Clojure API for deep learning library <a href="http://mxnet.incubator.apache.org/">MXNet</a>.</p>

<p>The module API provides an intermediate and high-level interface for performing computation with neural networks in MXNet.</p>

<p>To follow along with this documentation, you can use this namespace to with the needed requires:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">docs.module</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.java.io</span> <span class="ss">:as</span> <span class="nv">io</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.java.shell</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">sh</span><span class="p">]]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.eval-metric</span> <span class="ss">:as</span> <span class="nv">eval-metric</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.io</span> <span class="ss">:as</span> <span class="nv">mx-io</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.module</span> <span class="ss">:as</span> <span class="nv">m</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.symbol</span> <span class="ss">:as</span> <span class="nv">sym</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.ndarray</span> <span class="ss">:as</span> <span class="nv">ndarray</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Prepare the Data</h2>

<p>In this example, we are going to use the MNIST data set. If you have cloned the MXNet repo and <code>cd contrib/clojure-package</code>, we can run some helper scripts to download the data for us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">data-dir</span> <span class="s">&quot;data/&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">.exists</span> <span class="p">(</span><span class="nf">io/file</span> <span class="p">(</span><span class="nb">str </span><span class="nv">data-dir</span> <span class="s">&quot;train-images-idx3-ubyte&quot;</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">sh</span> <span class="s">&quot;../../scripts/get_mnist_data.sh&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>MXNet provides function in the <code>io</code> namespace to load the MNIST datasets into training and test data iterators that we can use with our module.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">train-data</span> <span class="p">(</span><span class="nf">mx-io/mnist-iter</span> <span class="p">{</span><span class="ss">:image</span> <span class="p">(</span><span class="nb">str </span><span class="nv">data-dir</span> <span class="s">&quot;train-images-idx3-ubyte&quot;</span><span class="p">)</span>
</span><span class='line'>                                   <span class="ss">:label</span> <span class="p">(</span><span class="nb">str </span><span class="nv">data-dir</span> <span class="s">&quot;train-labels-idx1-ubyte&quot;</span><span class="p">)</span>
</span><span class='line'>                                   <span class="ss">:label-name</span> <span class="s">&quot;softmax_label&quot;</span>
</span><span class='line'>                                   <span class="ss">:input-shape</span> <span class="p">[</span><span class="mi">784</span><span class="p">]</span>
</span><span class='line'>                                   <span class="ss">:batch-size</span> <span class="mi">10</span>
</span><span class='line'>                                   <span class="ss">:shuffle</span> <span class="nv">true</span>
</span><span class='line'>                                   <span class="ss">:flat</span> <span class="nv">true</span>
</span><span class='line'>                                   <span class="ss">:silent</span> <span class="nv">false</span>
</span><span class='line'>                                   <span class="ss">:seed</span> <span class="mi">10</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">test-data</span> <span class="p">(</span><span class="nf">mx-io/mnist-iter</span> <span class="p">{</span><span class="ss">:image</span> <span class="p">(</span><span class="nb">str </span><span class="nv">data-dir</span> <span class="s">&quot;t10k-images-idx3-ubyte&quot;</span><span class="p">)</span>
</span><span class='line'>                                  <span class="ss">:label</span> <span class="p">(</span><span class="nb">str </span><span class="nv">data-dir</span> <span class="s">&quot;t10k-labels-idx1-ubyte&quot;</span><span class="p">)</span>
</span><span class='line'>                                  <span class="ss">:input-shape</span> <span class="p">[</span><span class="mi">784</span><span class="p">]</span>
</span><span class='line'>                                  <span class="ss">:batch-size</span> <span class="mi">10</span>
</span><span class='line'>                                  <span class="ss">:flat</span> <span class="nv">true</span>
</span><span class='line'>                                  <span class="ss">:silent</span> <span class="nv">false</span><span class="p">}))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Preparing a Module for Computation</h2>

<p>To construct a module, we need to have a symbol as input. This symbol takes input data in the first layer and then has subsequent layers of fully connected and relu activation layers, ending up in a softmax layer for output.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">data</span> <span class="p">(</span><span class="nf">sym/variable</span> <span class="s">&quot;data&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">fc1</span> <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:num-hidden</span> <span class="mi">128</span><span class="p">})</span>
</span><span class='line'>      <span class="nv">act1</span> <span class="p">(</span><span class="nf">sym/activation</span> <span class="s">&quot;relu1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">fc1</span> <span class="ss">:act-type</span> <span class="s">&quot;relu&quot;</span><span class="p">})</span>
</span><span class='line'>      <span class="nv">fc2</span> <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc2&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">act1</span> <span class="ss">:num-hidden</span> <span class="mi">64</span><span class="p">})</span>
</span><span class='line'>      <span class="nv">act2</span> <span class="p">(</span><span class="nf">sym/activation</span> <span class="s">&quot;relu2&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">fc2</span> <span class="ss">:act-type</span> <span class="s">&quot;relu&quot;</span><span class="p">})</span>
</span><span class='line'>      <span class="nv">fc3</span> <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc3&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">act2</span> <span class="ss">:num-hidden</span> <span class="mi">10</span><span class="p">})</span>
</span><span class='line'>      <span class="nv">out</span> <span class="p">(</span><span class="nf">sym/softmax-output</span> <span class="s">&quot;softmax&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">fc3</span><span class="p">})]</span>
</span><span class='line'>  <span class="nv">out</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;=&gt;#object[org.apache.mxnet.Symbol 0x1f43a406 &quot;org.apache.mxnet.Symbol@1f43a406&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also write this with the <code>as-&gt;</code> threading macro.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">out</span> <span class="p">(</span><span class="nf">as-&gt;</span> <span class="p">(</span><span class="nf">sym/variable</span> <span class="s">&quot;data&quot;</span><span class="p">)</span> <span class="nv">data</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:num-hidden</span> <span class="mi">128</span><span class="p">})</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/activation</span> <span class="s">&quot;relu1&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:act-type</span> <span class="s">&quot;relu&quot;</span><span class="p">})</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc2&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:num-hidden</span> <span class="mi">64</span><span class="p">})</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/activation</span> <span class="s">&quot;relu2&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:act-type</span> <span class="s">&quot;relu&quot;</span><span class="p">})</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/fully-connected</span> <span class="s">&quot;fc3&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span> <span class="ss">:num-hidden</span> <span class="mi">10</span><span class="p">})</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">sym/softmax-output</span> <span class="s">&quot;softmax&quot;</span> <span class="p">{</span><span class="ss">:data</span> <span class="nv">data</span><span class="p">})))</span>
</span><span class='line'><span class="c1">;=&gt; #&#39;tutorial.module/out</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default, <code>context</code> is the CPU. If you need data parallelization, you can specify a GPU context or an array of GPU contexts like this <code>(m/module out {:contexts [(context/gpu)]})</code></p>

<p>Before you can compute with a module, you need to call <code>bind</code> to allocate the device memory and <code>init-params</code> or <code>set-params</code> to initialize the parameters. If you simply want to fit a module, you don’t need to call <code>bind</code> and <code>init-params</code> explicitly, because the <code>fit</code> function automatically calls them if they are needed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">mod</span> <span class="p">(</span><span class="nf">m/module</span> <span class="nv">out</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">mod</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">m/bind</span> <span class="p">{</span><span class="ss">:data-shapes</span> <span class="p">(</span><span class="nf">mx-io/provide-data</span> <span class="nv">train-data</span><span class="p">)</span>
</span><span class='line'>               <span class="ss">:label-shapes</span> <span class="p">(</span><span class="nf">mx-io/provide-label</span> <span class="nv">train-data</span><span class="p">)})</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">m/init-params</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you can compute with the module using functions like <code>forward</code>, <code>backward</code>, etc.</p>

<h2>Training and Predicting</h2>

<p>Modules provide high-level APIs for training, predicting, and evaluating. To fit a module, call the <code>fit</code> function with some data iterators:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mod</span> <span class="p">(</span><span class="nf">m/fit</span> <span class="p">(</span><span class="nf">m/module</span> <span class="nv">out</span><span class="p">)</span> <span class="p">{</span><span class="ss">:train-data</span> <span class="nv">train-data</span> <span class="ss">:eval-data</span> <span class="nv">test-data</span> <span class="ss">:num-epoch</span> <span class="mi">1</span><span class="p">}))</span>
</span><span class='line'><span class="c1">;; Epoch  0  Train- [accuracy 0.12521666]</span>
</span><span class='line'><span class="c1">;; Epoch  0  Time cost- 8392</span>
</span><span class='line'><span class="c1">;; Epoch  0  Validation-  [accuracy 0.2227]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can pass in batch-end callbacks using batch-end-callback and epoch-end callbacks using epoch-end-callback in the <code>fit-params</code>. You can also set parameters using functions like in the fit-params like optimizer and eval-metric. To learn more about the fit-params, see the fit-param function options. To predict with a module, call <code>predict</code> with a DataIter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">results</span> <span class="p">(</span><span class="nf">m/predict</span> <span class="nv">mod</span> <span class="p">{</span><span class="ss">:eval-data</span> <span class="nv">test-data</span><span class="p">}))</span>
</span><span class='line'><span class="p">(</span><span class="nb">first </span><span class="nv">results</span><span class="p">)</span> <span class="c1">;=&gt;#object[org.apache.mxnet.NDArray 0x3540b6d3 &quot;org.apache.mxnet.NDArray@a48686ec&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="p">(</span><span class="nb">first </span><span class="nv">results</span><span class="p">)))</span> <span class="c1">;=&gt;0.08261358</span>
</span></code></pre></td></tr></table></div></figure>


<p>The module collects and returns all of the prediction results. For more details about the format of the return values, see the documentation for the <code>predict</code> function.</p>

<p>When prediction results might be too large to fit in memory, use the <code>predict-every-batch</code> API.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">preds</span> <span class="p">(</span><span class="nf">m/predict-every-batch</span> <span class="nv">mod</span> <span class="p">{</span><span class="ss">:eval-data</span> <span class="nv">test-data</span><span class="p">})]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">mx-io/reduce-batches</span> <span class="nv">test-data</span>
</span><span class='line'>                        <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">i</span> <span class="nv">batch</span><span class="p">]</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;pred is &quot;</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">get </span><span class="nv">preds</span> <span class="nv">i</span><span class="p">))))</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;label is &quot;</span> <span class="p">(</span><span class="nf">mx-io/batch-label</span> <span class="nv">batch</span><span class="p">)))</span>
</span><span class='line'>                          <span class="c1">;;; do something</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">inc </span><span class="nv">i</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you need to evaluate on a test set and don’t need the prediction output, call the <code>score</code> function with a data iterator and an eval metric:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">m/score</span> <span class="nv">mod</span> <span class="p">{</span><span class="ss">:eval-data</span> <span class="nv">test-data</span> <span class="ss">:eval-metric</span> <span class="p">(</span><span class="nf">eval-metric/accuracy</span><span class="p">)})</span> <span class="c1">;=&gt;[&quot;accuracy&quot; 0.2227]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This runs predictions on each batch in the provided data iterator and computes the evaluation score using the provided eval metric. The evaluation results are stored in metric so that you can query later.</p>

<h2>Saving and Loading</h2>

<p>To save the module parameters in each training epoch, use a <code>checkpoint</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">save-prefix</span> <span class="s">&quot;my-model&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">epoch-num</span> <span class="p">(</span><span class="nb">range </span><span class="mi">3</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">mx-io/do-batches</span> <span class="nv">train-data</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">batch</span>
</span><span class='line'>                                          <span class="c1">;; do something</span>
</span><span class='line'><span class="p">]))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">m/save-checkpoint</span> <span class="nv">mod</span> <span class="p">{</span><span class="ss">:prefix</span> <span class="nv">save-prefix</span> <span class="ss">:epoch</span> <span class="nv">epoch-num</span> <span class="ss">:save-opt-states</span> <span class="nv">true</span><span class="p">})))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved checkpoint to my-model-0000.params</span>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved optimizer state to my-model-0000.states</span>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved checkpoint to my-model-0001.params</span>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved optimizer state to my-model-0001.states</span>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved checkpoint to my-model-0002.params</span>
</span><span class='line'><span class="c1">;; INFO  org.apache.mxnet.module.Module: Saved optimizer state to my-model-0002.states</span>
</span></code></pre></td></tr></table></div></figure>


<p>To load the saved module parameters, call the <code>load-checkpoint</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">new-mod</span> <span class="p">(</span><span class="nf">m/load-checkpoint</span> <span class="p">{</span><span class="ss">:prefix</span> <span class="s">&quot;my-model&quot;</span> <span class="ss">:epoch</span> <span class="mi">1</span> <span class="ss">:load-optimizer-states</span> <span class="nv">true</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">new-mod</span> <span class="c1">;=&gt; #object[org.apache.mxnet.module.Module 0x5304d0f4 &quot;org.apache.mxnet.module.Module@5304d0f4&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To initialize parameters, Bind the symbols to construct executors first with bind function. Then, initialize the parameters and auxiliary states by calling <code>init-params</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="nv">new-mod</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">m/bind</span> <span class="p">{</span><span class="ss">:data-shapes</span> <span class="p">(</span><span class="nf">mx-io/provide-data</span> <span class="nv">train-data</span><span class="p">)</span> <span class="ss">:label-shapes</span> <span class="p">(</span><span class="nf">mx-io/provide-label</span> <span class="nv">train-data</span><span class="p">)})</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">m/init-params</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get current parameters, use <code>params</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">arg-params</span> <span class="nv">aux-params</span><span class="p">]</span> <span class="p">(</span><span class="nf">m/params</span> <span class="nv">new-mod</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:arg-params</span> <span class="nv">arg-params</span>
</span><span class='line'>   <span class="ss">:aux-params</span> <span class="nv">aux-params</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; {:arg-params</span>
</span><span class='line'><span class="c1">;;  {&quot;fc3_bias&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x39adc3b0 &quot;org.apache.mxnet.NDArray@49caf426&quot;],</span>
</span><span class='line'><span class="c1">;;   &quot;fc2_weight&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x25baf623 &quot;org.apache.mxnet.NDArray@a6c8f9ac&quot;],</span>
</span><span class='line'><span class="c1">;;   &quot;fc1_bias&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x6e089973 &quot;org.apache.mxnet.NDArray@9f91d6eb&quot;],</span>
</span><span class='line'><span class="c1">;;   &quot;fc3_weight&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x756fd109 &quot;org.apache.mxnet.NDArray@2dd0fe3c&quot;],</span>
</span><span class='line'><span class="c1">;;   &quot;fc2_bias&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x1dc69c8b &quot;org.apache.mxnet.NDArray@d128f73d&quot;],</span>
</span><span class='line'><span class="c1">;;   &quot;fc1_weight&quot;</span>
</span><span class='line'><span class="c1">;;   #object[org.apache.mxnet.NDArray 0x20abc769 &quot;org.apache.mxnet.NDArray@b8e1c5e8&quot;]},</span>
</span><span class='line'><span class="c1">;;  :aux-params {}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To assign parameter and aux state values, use <code>set-params</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">m/set-params</span> <span class="nv">new-mod</span> <span class="p">{</span><span class="ss">:arg-params</span> <span class="p">(</span><span class="nf">m/arg-params</span> <span class="nv">new-mod</span><span class="p">)</span> <span class="ss">:aux-params</span> <span class="p">(</span><span class="nf">m/aux-params</span> <span class="nv">new-mod</span><span class="p">)})</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.apache.mxnet.module.Module 0x5304d0f4 &quot;org.apache.mxnet.module.Module@5304d0f4&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To resume training from a saved checkpoint, instead of calling <code>set-params</code>, directly call <code>fit</code>, passing the loaded parameters, so that <code>fit</code> knows to start from those parameters instead of initializing randomly</p>

<p>Create fit-params, and then use it to set <code>begin-epoch</code> so that <code>fit</code> knows to resume from a saved epoch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; reset the training data before calling fit or you will get an error</span>
</span><span class='line'><span class="p">(</span><span class="nf">mx-io/reset</span> <span class="nv">train-data</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">mx-io/reset</span> <span class="nv">test-data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">m/fit</span> <span class="nv">new-mod</span> <span class="p">{</span><span class="ss">:train-data</span> <span class="nv">train-data</span> <span class="ss">:eval-data</span> <span class="nv">test-data</span> <span class="ss">:num-epoch</span> <span class="mi">2</span>
</span><span class='line'>                <span class="ss">:fit-params</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">m/fit-params</span> <span class="p">{</span><span class="ss">:begin-epoch</span> <span class="mi">1</span><span class="p">}))})</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are interested in checking out MXNet and exploring on your own, check out the main page <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package">here</a> with instructions on how to install and other information.</p>

<h3>See other blog posts about MXNet</h3>

<ul>
<li><a href="http://gigasquidsoftware.com/blog/2018/06/03/meet-clojure-mxnet-ndarray/">Clojure MXNet &ndash; NDArray</a></li>
<li><a href="http://gigasquidsoftware.com/blog/2018/07/01/clojure-mxnet-joins-the-apache-mxnet-project/">Clojure MXNet Joins Apache MXNet</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Clojure MXNet Joins the Apache MXNet Project]]></title>
    <link href="http://gigasquid.github.io/blog/2018/07/01/clojure-mxnet-joins-the-apache-mxnet-project/"/>
    <updated>2018-07-01T10:44:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2018/07/01/clojure-mxnet-joins-the-apache-mxnet-project</id>
    <content type="html"><![CDATA[<p><img src="https://cdn-images-1.medium.com/max/800/1*OoqsrMD7JzXAvRUGx_8_fg.jpeg"></p>

<p>I&rsquo;m delighted to share the news that the Clojure package for <a href="https://mxnet.apache.org/">MXNet</a> has now joined the main Apache MXNet project. A big thank you to the efforts of everyone involved to make this possible. Having it as part of the main project is a great place for growth and collaboration that will benefit both MXNet and the Clojure community.</p>

<h2>Invitation to Join and Contribute</h2>

<p>The Clojure package has been brought in as a <em>contrib</em> <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package">clojure-package</a>. It is still very new and will go through a period of feedback, stabilization, and improvement before it graduates out of contrib.</p>

<p>We welcome contributors and people getting involved to make it better.</p>

<p>Are you interested in Deep Learning and Clojure? Great &ndash; Join us!</p>

<p>There are a few ways to get involved.</p>

<ul>
<li>Check out the current state of the Clojure package some contribution needs here <a href="https://cwiki.apache.org/confluence/display/MXNET/Clojure+Package+Contribution+Needs">https://cwiki.apache.org/confluence/display/MXNET/Clojure+Package+Contribution+Needs</a></li>
<li>Join the Clojurian Slack #mxnet channel</li>
<li>Join the <a href="https://lists.apache.org/list.html?dev@mxnet.apache.org">MXNet dev mailing list</a> by sending an email to <code>dev-subscribe@mxnet.apache.org.</code>.</li>
<li>Join the MXNET Slack channel &ndash; You have to join the MXnet dev mailing list first, but after that says you would like to join the slack and someone will add you.</li>
<li>Join the <a href="https://discuss.mxnet.io/">MXNet Discussion Forum</a></li>
</ul>


<h3>Want to Learn More?</h3>

<p>There are lots of examples in the package to check out, but a good place to start are the tutorials here <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package/examples/tutorial">https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package/examples/tutorial</a></p>

<p>There is a blog walkthough here as well &ndash; <a href="http://gigasquidsoftware.com/blog/2018/07/05/clojure-mxnet-the-module-api/">Clojure MXNet Module API</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Meet Clojure MXNet - NDArray]]></title>
    <link href="http://gigasquid.github.io/blog/2018/06/03/meet-clojure-mxnet-ndarray/"/>
    <updated>2018-06-03T16:13:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2018/06/03/meet-clojure-mxnet-ndarray</id>
    <content type="html"><![CDATA[<p><img src="https://cdn-images-1.medium.com/max/800/1*OoqsrMD7JzXAvRUGx_8_fg.jpeg"></p>

<p>This is the beginning of a series of blog posts to get to know the <a href="https://mxnet.apache.org/">Apache MXNet</a> Deep Learning project and the new Clojure language binding <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package">clojure-package</a></p>

<p>MXNet is a first class, modern deep learning library that AWS has officially picked as its chosen library. It supports multiple languages on a first class basis and is incubating as an Apache project.</p>

<p>The motivation for creating a Clojure package is to be able to open the deep learning library to the Clojure ecosystem and build bridges for future development and innovation for the community. It provides all the needed tools including low level and high level apis, dynamic graphs, and things like GAN and natural language support.</p>

<p>So let&rsquo;s get on with our introduction with one of the basic building blocks of MXNet, the <code>NDArray</code>.</p>

<h2>Meet NDArray</h2>

<p>The <code>NDArray</code> is the tensor data structure in MXNet. Let&rsquo;s start of by creating one. First we need to require the <code>ndarray</code> namespace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tutorial.ndarray</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.ndarray</span> <span class="ss">:as</span> <span class="nv">ndarray</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create an all zero array of dimension 100 x 50</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">50</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.apache.mxnet.NDArray 0x3e396d0 &quot;org.apache.mxnet.NDArray@aeea40b6&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can check the shape of this by using <code>shape-vec</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">50</span><span class="p">]))</span>
</span><span class='line'><span class="c1">;=&gt; [100 50]</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is also a quick way to create an ndarray of ones with the <code>ones</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">256</span> <span class="mi">32</span> <span class="mi">128</span> <span class="mi">1</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ones and zeros are nice, but what an array with specific contents? There is an <code>array</code> function for that. Specific the contents of the array first and the shape second:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">c</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">3</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="nv">c</span><span class="p">)</span>  <span class="c1">;=&gt; [2 3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To convert it back to a vector format, we can use the <code>-&gt;vec</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">c</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; [1.0 2.0 3.0 4.0 5.0 6.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we know how to create NDArrays, we can get to do something interesting like operations on them.</p>

<h3>Operations</h3>

<p>There are all the standard arithmetic operations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">a</span> <span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">5</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">b</span> <span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">5</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">ndarray/+</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nf">ndarray/-&gt;vec</span><span class="p">))</span>
</span><span class='line'><span class="c1">;=&gt;  [2.0 2.0 2.0 2.0 2.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the original ndarrays are unchanged.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt; [1.0 1.0 1.0 1.0 1.0]</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">b</span><span class="p">)</span> <span class="c1">;=&gt; [1.0 1.0 1.0 1.0 1.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, we can change that if we use the inplace operators:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/+=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt;  [2.0 2.0 2.0 2.0 2.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many more operations, but just to give you a taste, we&rsquo;ll take a look a the <code>dot</code> product operation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">arr1</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">arr2</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">3</span> <span class="mi">4</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">res</span> <span class="p">(</span><span class="nf">ndarray/dot</span> <span class="nv">arr1</span> <span class="nv">arr2</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="nv">res</span><span class="p">)</span> <span class="c1">;=&gt; [1 1]</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">res</span><span class="p">)</span> <span class="c1">;=&gt; [11.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are curious about the other operators available in NDArray API check out the <a href="https://mxnet.incubator.apache.org/api/python/ndarray/ndarray.html">MXNet project documentation page</a></p>

<p>Now that we have ndarrays and can do calculations on them, we might want to save and load them.</p>

<h3>Saving and Loading</h3>

<p>You can save ndarrays with a name as a map like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/save</span> <span class="s">&quot;filename&quot;</span> <span class="p">{</span><span class="s">&quot;arr1&quot;</span> <span class="nv">arr1</span> <span class="s">&quot;arr2&quot;</span> <span class="nv">arr2</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>To load them, you just specify the filename and the map is returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/load</span> <span class="s">&quot;filename&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; {&quot;arr1&quot; #object[org.apache.mxnet.NDArray 0x1b629ff4 &quot;org.apache.mxnet.NDArray@63da08cb&quot;]</span>
</span><span class='line'><span class="c1">;=&gt;  &quot;arr2&quot; #object[org.apache.mxnet.NDArray 0x25d994e3 &quot;org.apache.mxnet.NDArray@5bbaf2c3&quot;]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One more cool thing, we can even due our operations on the cpu or gpu.</p>

<h3>Multi-Device Support</h3>

<p>When creating an <code>ndarray</code> you can use a context argument to specify the device. To do this, we will need the help of the <code>context</code> namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">org.apache.clojure-mxnet.context</span> <span class="ss">:as</span> <span class="nv">context</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default, the <code>ndarray</code> is created on the cpu context.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cpu-a</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">200</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/context</span> <span class="nv">cpu-a</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; #object[ml.dmlc.mxnet.Context 0x3f376123 &quot;cpu(0)&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we can specify the gpu instead, (if we have a gpu enabled build).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">gpu-b</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">200</span><span class="p">]</span> <span class="p">{</span><span class="ss">:ctx</span> <span class="p">(</span><span class="nf">context/gpu</span> <span class="mi">0</span><span class="p">)}))</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note: Operations among different contexts are currently not allowed, but there is a <code>copy-to</code> function that can help copy the content from one device to another and then continue on with the computation.</em></p>

<h2>Wrap up</h2>

<p>I hope you&rsquo;ve enjoyed the brief introduction to the MXNet library, there is much more to explore in future posts. If you are interested in giving it a try, there are native jars for OSX cpu and Linux cpu/gpu available and the code for the ndarray tutorial can be found <a href="https://github.com/apache/incubator-mxnet/tree/master/contrib/clojure-package/examples/tutorial">here</a></p>

<p><em>Please remember that the library is in a experimential state, so if you encounter any problems or have any other feedback, please log an issue so bugs and rough edges can be fixed :).</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[On Staying Technical]]></title>
    <link href="http://gigasquid.github.io/blog/2018/03/04/on-staying-technical/"/>
    <updated>2018-03-04T11:03:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2018/03/04/on-staying-technical</id>
    <content type="html"><![CDATA[<p>I was 10 years into my career when I met her. I could count the number of other women programmers I had worked with on one hand and none of them had young children at home like me. She was not only incredibly experienced and competent, but also had a son in college. I was curious about her career path so I asked her one day at lunch why she was still programming and hadn’t become a manager instead.</p>

<p>She smiled at me kindly and replied, &ldquo;I’ve worked very hard to stay exactly where I am&rdquo;,  and I was enlightened.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Cats and Dogs with Cortex Redux]]></title>
    <link href="http://gigasquid.github.io/blog/2017/11/07/cats-and-dogs-with-cortex-redux/"/>
    <updated>2017-11-07T18:51:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2017/11/07/cats-and-dogs-with-cortex-redux</id>
    <content type="html"><![CDATA[<p>I wrote a <a href="http://gigasquidsoftware.com/blog/2016/12/27/deep-learning-in-clojure-with-cortex/">blog post</a> a while back about using a Clojure machine learning library called <a href="https://github.com/thinktopic/cortex">Cortex</a> to do the Kaggle Cats and Dogs classification challenge.</p>

<p>I wanted to revisit it for a few reasons. The first one is that the Cortex library has progressed and improved considerably over the last year. It&rsquo;s still not at version 1.0, but it my eyes, it&rsquo;s really starting to shine. The second reason is that they recently published an <a href="https://github.com/thinktopic/cortex/tree/master/examples/resnet-retrain">example</a> of using the RESNET50 model, (I&rsquo;ll explain later on), to do fine-tuning or transfer learning. The third reason, is that there is a great new plugin for leiningen the supports using <a href="https://github.com/didiercrunch/lein-jupyter">Jupyter notebooks with Clojure projects</a>. These notebooks are a great way of doing walkthroughs and tutorials.</p>

<p>Putting all these things together, I felt like I was finally at a stage where I could somewhat replicate the first lesson in the <a href="https://github.com/fastai/courses/blob/master/deeplearning1/nbs/dogs_cats_redux.ipynb">Practical Deep Learning Course for Coders</a> with Cats and Dogs &ndash; although this time all in Clojure!</p>

<h2>Where to Start?</h2>

<p><img src="http://kaggle2.blob.core.windows.net/competitions/kaggle/3362/media/woof_meow.jpg"></p>

<p>In the last blog post, we created our deep learning network and trained the data on scaled down images (like 50x50) from scratch. This time we are much smarter.</p>

<p>We are still of course going to have to get a hold of all the training data from <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data">Kaggle Cats vs Dogs Challenge</a>. The big difference is this time, we are just going to have to train our model for <em>1 epoch</em>. What&rsquo;s more, the results will be way better than before.</p>

<p>How is this possible? We are going to use an already trained model, RESNET50. This model has already been painstakingly trained with a gigantic network that is 50 layers deep on the ImageNet challenge. That&rsquo;s a challenge that has models try to classify a 1000 different categories. The theory is that the inner layers of the network have already learned about the features that make up cats and dogs, all we would need to do is peel off the final layer of the network and graft on a new layers that just learns the final classification for our 2 categories of cats and dogs. This is called <em>transfer learning</em> or <em>retraining</em>.</p>

<h2>Plan of Action</h2>

<ul>
<li>Get all the cats and dogs pictures in the right directory format for training</li>
<li>Train the model with all but the last layer in the RESNET model. The last layer we are going to replace with our own layer that will finetune it to classify only cats and dogs</li>
<li>Run the test data and come up with a spreadsheet of results to submit to Kaggle.</li>
</ul>


<h3>Getting all the data pictures in the right format</h3>

<p>This is the generally the most time consuming step of most deep learning. I&rsquo;ll spare you the gritty details but we want to get all the pictures from the <code>train.zip</code> into the format</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-data
</span><span class='line'>  -cats-dogs-training
</span><span class='line'>      -cat
</span><span class='line'>          1110.png
</span><span class='line'>          ...
</span><span class='line'>      -dog
</span><span class='line'>          12416.png
</span><span class='line'>          ...
</span><span class='line'>  -cats-dogs-testing
</span><span class='line'>      -cat
</span><span class='line'>          11.png
</span><span class='line'>          ...
</span><span class='line'>      -dog
</span><span class='line'>          12.png
</span><span class='line'>          ...</span></code></pre></td></tr></table></div></figure>


<p>The image sizes must also all be resized to match the input of the RESNET50. That means they all have to be 224x224.</p>

<h3>Train the model</h3>

<p>The cortex functions allow you to load the resnet50 model, remove the last layer, freeze all the other layers so that they will not be retrained, and add new layers.</p>

<p>I was surprised that I could actually train the model with all the images at 224x244 with the huge RESNET50 model. I built the uberjar and ran it which helped the performance.</p>

<p><code>lein uberjar</code></p>

<p><code>java -jar target/cats-dogs-cortex-redux.jar</code></p>

<p>Training one epoch took me approximately 6 minutes. Not bad, especially considering that&rsquo;s all the training I really needed to do.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Loss for epoch 1: (current) 0.05875186542016347 (best) null
</span><span class='line'>Saving network to trained-network.nippy</span></code></pre></td></tr></table></div></figure>


<p>The key point is that it saved the fine tuned network to trained-network.nippy</p>

<h3>Run the Kaggle test results and submit the results</h3>

<p>You will need to do a bit more setup for this. First, you need to get the Kaggle test images for classification. There are 12500 of these in the test.zip file from the site. Under the data directory, create a new directory called kaggle-test. Now unzip the contents of test.zip inside that folder. The full directory with all the test images should now be:</p>

<p><code>data/kaggle-test/test</code></p>

<p>This step takes a long time and you might have to tweak the batch size again depending on your memory. There are 12500 predications to be made. The main logic for this is in function called <code>(kaggle-results batch-size)</code>. It will take a long time to run. It will print the results as it goes along to the kaggle-results.csv file. If you want to check progress you can do wc -l kaggle-results.csv</p>

<p>For me locally, with <code>(cats-dogs/kaggle-results 100)</code> it took me 28 minutes locally.</p>

<h3>Compare the results</h3>

<p><img src="http://c1.staticflickr.com/5/4518/26477015609_1af781b8da_b.jpg"></p>

<p>My one epoch of fine tuning beat my best results of going through the Practical Deep Learning exercise with the fine tuning the VGG16 model. Not bad at all.</p>

<h2>Summary</h2>

<p>For those of you that are interested in checking out the code, it&rsquo;s out there on <a href="https://github.com/gigasquid/cats-dogs-cortex-redux">github</a></p>

<p>Even more exciting, there is a <a href="https://github.com/gigasquid/cats-dogs-cortex-redux/blob/master/Cats%20and%20Dogs%20in%20Cortex%20(Redux).ipynb">walkthrough in a jupyter notebook</a> with a lein-jupyter plugin.</p>

<p>The Deep Learning world in Clojure is an exciting place to be and gaining tools and traction more and more.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Embedded Interop between Clojure, R, and Python with GraalVM]]></title>
    <link href="http://gigasquid.github.io/blog/2017/10/22/embedded-interop-between-clojure-r-and-python-with-graalvm/"/>
    <updated>2017-10-22T16:02:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2017/10/22/embedded-interop-between-clojure-r-and-python-with-graalvm</id>
    <content type="html"><![CDATA[<p><img src="https://images-na.ssl-images-amazon.com/images/M/MV5BOTViY2Y0ZGItMTg2OC00YzEzLWJhYjYtZjg4OTMyOWE4YzM1XkEyXkFqcGdeQXVyNTQ1NzU4Njk@._V1_.jpg" title="" ></p>

<p>In my talk at <a href="https://www.youtube.com/watch?v=eLl6_k_fZn4">Clojure Conj</a> I mentioned how a project from Oracle Labs named GraalVM might have to potential for Clojure to interop with Python on the same VM. At the time of the talk, I had just learned about it so I didn&rsquo;t have time to take a look at it. Over the last week, I&rsquo;ve managed to take it for a test drive and I wanted to share what I found.</p>

<h3>Are you ready?</h3>

<p>In this example, we will be using an ordinary Leinengen project and using the REPL we will interop with both R and python.</p>

<p>But first will need a bit of setup.</p>

<p>We will download the <a href="http://www.oracle.com/technetwork/oracle-labs/program-languages/downloads/index.html">Graal project</a> so we can use its <code>java</code> instead of our own.</p>

<p>Once we have it downloaded we will configure our PATH to use Graal&rsquo;s java instead of our own.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export PATH=/path/to/graalAndTruffle/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>Now, we can create a new lein project and run <code>lein repl</code> and begin the fun.</p>

<h3>The Polyglot Context</h3>

<p>In our new namespace, we just need to import the <a href="http://graalvm.github.io/graal/truffle/javadoc/org/graalvm/polyglot/Context.html">Polyglot Context</a> to get started:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">graal-test.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">org.graalvm.polyglot</span> <span class="nv">Context</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; note that is also supports Ruby, LLVM, and JS</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">context</span> <span class="p">(</span><span class="nf">Context/create</span> <span class="p">(</span><span class="nb">into-array </span><span class="p">[</span><span class="s">&quot;python&quot;</span> <span class="s">&quot;R&quot;</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we are ready to actually try to run some R and Python code right in our REPL. Let&rsquo;s start first with R.</p>

<h3>Interoping with R</h3>

<p>The main function we are going to use is the <code>eval</code> function in the context. Let&rsquo;s start small with some basic math.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">3^2 + 2^2</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x7ff40e4d &quot;13.0&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow! It actually did something. It returned something called a <a href="https://github.com/graalvm/graal/blob/master/sdk/src/org.graalvm.polyglot/src/org/graalvm/polyglot/Value.java">Polyglot Value</a> with what looks like the right answer in it.</p>

<p>Emboldened by our early success, let&rsquo;s try something a little more complicated like calling a function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">result1</span> <span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">sum.of.squares &lt;- function(x,y) {</span>
</span><span class='line'><span class="s">  x^2 + y^2</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">sum.of.squares(3,4)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0xc3edd92 &quot;25.0&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, it looks like it worked. Let&rsquo;s try to get the result back into Clojure as a value we can work with. We could ask the result what sort of type it is with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.isNumber</span> <span class="nv">result1</span><span class="p">)</span> <span class="c1">;=&gt; true </span>
</span></code></pre></td></tr></table></div></figure>


<p>but let&rsquo;s just use <code>clojure.edn</code> to read the string and save some time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-&gt;clojure</span> <span class="p">[</span><span class="nv">polyglot-value</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">polyglot-value</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.toString</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">clojure.edn/read-string</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">-&gt;clojure</span> <span class="nv">result1</span><span class="p">)</span> <span class="c1">;=&gt; 25</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be nice to have a easier way to export symbols and import symbols to and from the guest and host language. In fact, Graal provides a way to do this but to do this in Clojure, we would need something else called <a href="https://github.com/graalvm/graal/tree/master/truffle">Truffle</a>.</p>

<p>Truffle is part of the Graal project and is a framework for implementing languages with the Graal compliler.
There are quite a few languages implemented with the Truffle framework. R is one of them.</p>

<p><img src="https://image.slidesharecdn.com/polyglotonthejvmwithgraalenglish-170521104613/95/polyglot-on-the-jvm-with-graal-english-14-638.jpg?cb=1495364615"></p>

<p>My understanding is that if Clojure was implemented as a truffle lang, then interop could be much more seamless like this example in Ruby</p>

<p><img src="https://image.slidesharecdn.com/polyglotonthejvmwithgraalenglish-170521104613/95/polyglot-on-the-jvm-with-graal-english-37-638.jpg?cb=1495364615"></p>

<p>But let&rsquo;s continue in our exploration. What about doing something more interesting, like importing a useful R library and using it. How about the <a href="https://www.rdocumentation.org/packages/numDeriv/versions/2016.8-1">numDeriv</a> package that supports Accurate Numerical Derivatives?</p>

<p>First we import the package using cran.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">install.packages(\&quot;numDeriv\&quot;, repos = \&quot;http://cran.case.edu/\&quot;)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are doing this at your REPL, you can will see lots of text going on in your <code>lein repl</code> process at this point. It&rsquo;s going out and figuring out what deps you need and installing them in your <code>/graalvm-0.28.2/jre/languages/R</code> directory structure.</p>

<p>After it is done, we can actually use it!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">result2</span> <span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">library(numDeriv)</span>
</span><span class='line'><span class="s">grad(sin, (0:10)*2*pi/10)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="nv">result2</span> <span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x76765898 &quot;c(1,</span>
</span><span class='line'>        <span class="c1">;0.809016994367249, 0.309016994372158, -0.309016994373567,</span>
</span><span class='line'>        <span class="c1">;-0.809016994368844, -0.999999999993381, -0.809016994370298,</span>
</span><span class='line'>        <span class="c1">;-0.309016994373312, 0.309016994372042, 0.809016994369185,</span>
</span><span class='line'>        <span class="c1">;0.999999999993381)&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has a bit more interesting result as an array. But the Context has ways of dealing with it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.hasArrayElements</span> <span class="nv">result2</span><span class="p">)</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">.getArraySize</span> <span class="nv">result2</span><span class="p">)</span> <span class="c1">;=&gt; 11</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="mi">10</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">.getArrayElement</span> <span class="nv">result2</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nf">-&gt;clojure</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;=&gt; (1.0 0.8090169943672489 0.3090169943721585 -0.3090169943735675</span>
</span><span class='line'><span class="c1">;-0.8090169943688436 -0.9999999999933814</span>
</span><span class='line'><span class="c1">; -0.8090169943702977 -0.3090169943733122 0.30901699437204233</span>
</span><span class='line'><span class="c1">; 0.8090169943691851)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, we&rsquo;ve showed basic interop with R &ndash; which is pretty neat. What about Python?</p>

<h3>Interoping with Python</h3>

<p>Truffle is scheduled to fully support Python in 2018, but there is already an early alpha version in the Graal download that we can play with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;python&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">import time;</span>
</span><span class='line'><span class="s">time.clock()</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'> <span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x4a6b3b70 &quot;1.508202803249E9&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Neat!</p>

<p>It is still a long way for <code>import numpy</code> or <code>import tensorflow</code> but cPython compatibility is the goal. Although the c-extensions are the really tricky part.</p>

<p>So keep an eye on Graal and Truffle for the future and wish the Oracle Labs team the best on their mission to make the JVM Polyglot.</p>

<h3>Footnotes</h3>

<p>If you are interested in playing with the code. I have a github repo here <a href="https://github.com/gigasquid/graal-test">graal-test</a>. If you are interested in watching a video, I really liked <a href="https://www.youtube.com/watch?v=TQMKPRc6cbE">this one</a>. There are also some really nice examples of running in polyglot mode with R and Java and JS here <a href="https://github.com/graalvm/examples">https://github.com/graalvm/examples</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Self Publishing for the Creative Coder]]></title>
    <link href="http://gigasquid.github.io/blog/2017/05/27/self-publishing-for-the-creative-coder/"/>
    <updated>2017-05-27T14:11:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2017/05/27/self-publishing-for-the-creative-coder</id>
    <content type="html"><![CDATA[<p>So, you have an idea for a fiction book. First, let me tell you that it&rsquo;s a good idea and it&rsquo;s a great thing that you are a coder. Quite a few successful authors have a background in software development. <a href="http://www.imdb.com/title/tt2543164/">Arrival</a>, (which is a fabulous movie), comes from the book, <a href="https://www.amazon.com/Stories-Your-Life-Others-Chiang/dp/1101972122">Stories of your Life</a>,  written by a fellow programmer <a href="https://en.wikipedia.org/wiki/Ted_Chiang">Ted Chiang</a>. <a href="https://en.wikipedia.org/wiki/Charles_Stross">Charlie Stross</a> is another fine example. One of my favorites is <a href="https://en.wikipedia.org/wiki/Daniel_Suarez_(author">Daniel Suarez</a>, the author of the<a href="https://www.amazon.com/DAEMON-Daniel-Suarez/dp/0451228731"> Daemon</a> and more recently <a href="https://www.amazon.com/Change-Agent-Novel-Daniel-Suarez/dp/110198466X/">Change Agent</a>. So yes, you can write a fiction book and you&rsquo;re in good company. This post is dedicated to help make it happen.</p>

<h2>So how do you know about self publishing?</h2>

<p>Two years ago, I had a semi-crazy idea for a tween/teen scifi book. At the time, my daughter was into all the popular books of time like <em>Hunger Games</em> and <em>Divergent</em>. The thing that I really liked about them was the strong female protagonist. The only thing that I thought was missing was a story that focused on a girl who could code. It would make it even better if she had <em>coding super powers</em>. The idea for <a href="http://www.codeshifterbook.com/">Code Shifter</a> was born. One of the things that I wanted to explore in writing the book was to have real programming code in the book but not have it be a <em>learning how to code</em> book. The code would exist as part of the story and if the reader picked up concepts along the way, great. Even if they didn&rsquo;t, it would lay the positive groundwork to have them be more open to it later.</p>

<p>Books, like software, always take longer than you plan. My daughter and I enjoyed working on it together and over time it grew into a book that we could share with others. Along the way, I learned quite a bit about writing books, publishing, and other things that I wish I had known beforehand.</p>

<h2>What did you use to write the book?</h2>

<p>In the book world, your story is referred to as your <em>manuscript</em>. As a tool to produce it, I cannot speak highly enough of <a href="https://leanpub.com/">Leanpub</a>. I found it easy and productive to work in as a programmer. For example,  my setup was pretty painless.</p>

<p>In the repo, I had a <code>manuscript</code> directory, in which there was a <code>Book.txt</code> file that listed the chapter files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chapter2.txt
</span><span class='line'>chapter3.txt
</span><span class='line'>chapter4.txt
</span><span class='line'>chapter5.txt</span></code></pre></td></tr></table></div></figure>


<p>Each chapter file in turn was written in markdown. For example, <code>chapter2.txt</code> looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 1
</span><span class='line'>
</span><span class='line'>## Flicker
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Twelve-year-old Eliza knew that the next words were the result of computer program far more intelligent than any one of them. Standing next to her parents, she held her breath and watched as her brother touched his finger to the message on the wall screen.</span></code></pre></td></tr></table></div></figure>


<p>From there, my process looked like:</p>

<ul>
<li>Write a bit in my favorite editor, (Emacs of course), and make a commit.</li>
<li>Push the commit to github, which is registered with the Leanpub project</li>
<li>Log onto the Leanpub project and hit the <em>preview</em> button. This would generate a pdf and ebook that I could share with my daughter for feedback.</li>
</ul>


<p><img src="http://c1.staticflickr.com/5/4274/34768029762_3bbae300f0.jpg"></p>

<h3>Advantages of Leanpub for development.</h3>

<p>As I said earlier, I&rsquo;m a fan. Using git for revisions is incredibly useful. I shudder to think of people writing in Word without version control. The ability to easily create PDF and ebook formats was also very convenient. The markdown format has excellent code support. There is also the option as publishing your work as you go. However, I think that this is more useful with a technical book than with fiction.</p>

<h3>Disadvantages of Leanpub for development</h3>

<p>If you are going to work with an freelance editor or share your work with someone in the mainstream book world, they are not going to want pdf. They usually want a doc version. It took me a bit of research to find a good converter, <a href="http://pandoc.org/">pandoc</a>. With it, you can convert from markdown to Word with things looking pretty good. Don&rsquo;t try to do pdf to Word. I found it a big recipe for fail.</p>

<p>Finally, the book was considered done enough to think about publishing.</p>

<p>There was much rejoicing.</p>

<h2>Didn&rsquo;t you want to get the book into bookstores?</h2>

<p>Of course. That would be incredibly cool. However, that requires getting into what they call <em>traditional publishing</em> and it is a lot more work, time, and luck. If you go this route, you will need to budget at least six months to send out form letters to agencies to have them represent your work. Also, beware of predatory services that take advantage of unsuspecting and wide eyed authors. If you are interested in this, you&rsquo;ll want to start looking for agents that are interested in your type of book. <a href="https://querytracker.net/">Query Tracker</a> is a great place to start.</p>

<h2>Traditional publishing sounds hard. What about self publishing?</h2>

<p>Self publishing is certainly an easier more direct way to bring your book to life. For me, it was the best way forward. Luckily, Leanpub made it pretty painless.</p>

<h3>Publishing the book with Leanpub</h3>

<p>Actually publishing the finished copy was really easy with Leanpub. All I had to do was fill in some fields on the project page and push <em>Publish!</em> The book was immediately ready to share with the world. Putting out an updated edition was as easy as pushing the button again. Leanpub provides online reading as well as all the ebook versions.</p>

<p>That was nice, but I really wanted a print copy too.</p>

<h3>Publishing with CreateSpace</h3>

<p>Amazon&rsquo;s <a href="https://www.createspace.com/">CreateSpace</a> provides and excellent platform for on-demand print copies of books. This is where Leanpub comes in handy again. There is an <code>Export Option</code> that provides and unbranded pdf copy of your manuscript with all the correct formatting and margins required for CreateSpace. I simply exported the file and then uploaded it up to the project.</p>

<p><img src="http://c1.staticflickr.com/5/4203/34121511063_b63d283086_b.jpg"></p>

<p>The other thing that you will want is a nice cover. There are services through CreateSpace for cover creation that you can buy or you can upload your own file. I was lucky enough to have a talented graphic designer as sister, Kristin Allmyer,  who made me an awesome cover.</p>

<p>One of the confusing things was picking an ISBN for the print copy. You don&rsquo;t need to worry about this for ebook versions but you do for a physical copy. Your choices through CreateSpace are using a provided one for free or buying your own for $99. I chose my own so I could have flexibility of working with another publisher other than Amazon if I want. If you choose that option, you can also make up your own publisher name. Mine is <em>Gigasquid Books</em>.</p>

<p><img src="http://c1.staticflickr.com/5/4244/34121511083_15027c4571.jpg"></p>

<p>Once you have completed all the setup, they will send you a physical copy in the mail to approve. The moment you get to hold it in your hands is really magical.</p>

<p><img src="https://pbs.twimg.com/media/C8xBM-nXYAAOmK0.jpg:large"></p>

<p>If it looks alright, you hit the approve button and voilà &ndash; it&rsquo;s for sale on Amazon!</p>

<h3>Publishing with Direct Kindle Publishing</h3>

<p>With CreateSpace, you have the option of porting your book to a Kindle format as well. It will do most of the heavy lifting of converting the files for you and a few button clicks later you have both an Kindle and print version available for your readers.</p>

<p>If you need to update the text of the Kindle version, Leanpub also has an export option available to produce unbranded ebook files. Just take this and upload it to your KDP account and you are good to go.</p>

<h2>Did you run into any problems?</h2>

<p>Of course I did. I was totally new to self publishing and I underestimated how hard copy editing is. Some errors unfortunately made it into the first version. Luckily, I had some really nice people that helped my fix it for later versions. Many thanks to Martin Plumb, Michael Daines, Paul Henrich, and S. Le Callonnec for editing help.</p>

<p>This brings me to my next point. If I had to do it all over again, I would publish the book in a different order. Books are really no different than software. There are going to be bugs when you first release it in the wild. It is best to embrace this. In the future, I would publish the ebook versions first, which are much easier to update and then the print versions after that.</p>

<h2>Did you make lots of money from the book sales?</h2>

<p>Hahaha &hellip;  that&rsquo;s funny. If you are interested in making money, books are not the best way to go. The margins on Leanpub are definitely better than Amazon, but if I really was interested in making money, I would have been much better off using deep learning to make a stock market predictor or code up a startup that I could sell off.</p>

<p>Authors in general, are much harder pressed to make livings than software developers. We should count our blessings.</p>

<h2>Any last words of advice?</h2>

<p>There is a great joy from creating a story and sharing it with others. Take your book idea, nurture it, and bring it to life. Then publish it and we can celebrate together.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deep Learning in Clojure with Cortex]]></title>
    <link href="http://gigasquid.github.io/blog/2016/12/27/deep-learning-in-clojure-with-cortex/"/>
    <updated>2016-12-27T10:44:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2016/12/27/deep-learning-in-clojure-with-cortex</id>
    <content type="html"><![CDATA[<p><strong>Update: Cortex has moved along since I first wrote this blog post, so if you are looking to run the examples, please go and clone the <a href="https://github.com/thinktopic/cortex">Cortex</a> repo and look for the cats and dogs code in the examples directory.</strong></p>

<p>There is an awesome new <em>Clojure-first</em> machine learning library called <a href="https://github.com/thinktopic/cortex">Cortex</a> that was open sourced recently. I&rsquo;ve been exploring it lately and wanted to share my discoveries so far in this post. In our exploration, we are going to tackle one of the classic classification problems of the internet. How do you tell the difference between a cat and dog pic?</p>

<h2>Where to Start?</h2>

<p><img src="http://kaggle2.blob.core.windows.net/competitions/kaggle/3362/media/woof_meow.jpg"></p>

<p>For any machine learning problem, we&rsquo;re going to need data. For this, we can use Kaggle&rsquo;s data for the <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data">Cats vs Dogs Challenge</a>.  The training data consists of 25,000 images of cats and dogs. That should be more than enough to train our computer to recognize cats from doggies.</p>

<p>We also need some idea of how to train against the data. Luckily, the Cortex project has a very nice set of examples to help you get started. In particular there is a <a href="https://github.com/thinktopic/cortex/tree/master/examples/suite-classification">suite classification example</a> using MNIST, (hand written digit), corpus. This example contains a number cutting edge features that we&rsquo;ll want to use:</p>

<ul>
<li>Uses GPU for <em>fast</em> computation.</li>
<li>Uses a deep, multi-layered, convolutional layered network for feature recognition.</li>
<li>Has &ldquo;forever&rdquo; training by image augmentation.</li>
<li>Saves the network configuration as it trains to an external nippy file so that it can be imported later.</li>
<li>Has a really nice ClojureScript front end to visualize the training progress with a confusion matrix.</li>
<li>Has a way to import the saved nippy network configuration and perform inference on it to classify a new image.</li>
</ul>


<p>Basically, it has everything we need to hit the ground running.</p>

<h2>Data Wrangling</h2>

<p>To use the example&rsquo;s <em>forever</em> training, we need to get the data in the right form. We need all the images to be the same size as well as in a directory structure that is split up into the training and test images. Furthermore, we want all the dog images to be under a &ldquo;dog&rdquo; directory and the cat images under the &ldquo;cat&rdquo; directory so that the all the indexed images under them have the correct &ldquo;label&rdquo;.  It will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- training
</span><span class='line'>  - cat
</span><span class='line'>    - 1.png
</span><span class='line'>    - 2.png
</span><span class='line'>  - dog
</span><span class='line'>    - 1.png
</span><span class='line'>    - 2.png</span></code></pre></td></tr></table></div></figure>


<p>For this task, we are going to use a couple image libraries to help us out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">[</span><span class="nv">mikera.image.core</span> <span class="ss">:as</span> <span class="nv">imagez</span><span class="p">]</span>
</span><span class='line'> <span class="p">[</span><span class="nv">think.image.image</span> <span class="ss">:as</span> <span class="nv">image</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can resize and rewrite the original images into the form we want. For a image size, we&rsquo;re going to go with 52x52. The choice is arbitrary in that I wanted it bigger than the MNIST dataset which is 28x28 so it will be easier to see, but not so big that it kills my CPU. This is even more important since we want to use RGB colors which is 3 channels as opposed to the MNIST grey scale of 1.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-image-size</span> <span class="mi">52</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-num-classes</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-num-channels</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-datatype</span> <span class="ss">:float</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">resize-and-write-data</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">output-dir</span> <span class="p">[</span><span class="nv">idx</span> <span class="p">[</span><span class="nv">file</span> <span class="nv">label</span><span class="p">]]]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">img-path</span> <span class="p">(</span><span class="nb">str </span><span class="nv">output-dir</span> <span class="s">&quot;/&quot;</span> <span class="nv">label</span> <span class="s">&quot;/&quot;</span> <span class="nv">idx</span> <span class="s">&quot;.png&quot;</span> <span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">.exists</span> <span class="p">(</span><span class="nf">io/file</span> <span class="nv">img-path</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">io/make-parents</span> <span class="nv">img-path</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">imagez/load-image</span> <span class="nv">file</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">image/resize</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">imagez/save</span> <span class="nv">img-path</span><span class="p">)))</span>
</span><span class='line'>    <span class="nv">nil</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>As far as the split between training images and testing images, we are going the go for an simple even split between testing and training data.</p>

<h2>Network Configuration</h2>

<p>The Network layer configuration is the meat of the whole thing. We are going to go with the exact same network description as the MNIST example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-basic-network-description</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">[(</span><span class="nf">desc/input</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-num-channels</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">5</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/max-pooling</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">5</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/max-pooling</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/linear-&gt;relu</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/dropout</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/linear-&gt;softmax</span> <span class="nv">dataset-num-classes</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>It uses a series of convolutional layers with max pooling for feature recognition. We&rsquo;ll see if it works for color versions of cats and dogs as well as street numbers.</p>

<p>We&rsquo;ll also keep the image augmentation the same as in the example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">max-image-rotation-degrees</span> <span class="mi">25</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">img-aug-pipeline</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">img</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">img</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">image-aug/rotate</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">* </span><span class="mi">2</span> <span class="nv">max-image-rotation-degrees</span><span class="p">))</span>
</span><span class='line'>                           <span class="nv">max-image-rotation-degrees</span><span class="p">)</span>
</span><span class='line'>                        <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">image-aug/inject-noise</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.25</span> <span class="p">(</span><span class="nf">rand</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*num-augmented-images-per-file*</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It injects one augmented image into our training data by slightly rotating it and adding noise.</p>

<h3>Running it!</h3>

<p>It&rsquo;s time to test it out. Using <code>lein run</code>, we&rsquo;ll launch the <code>train-forever</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">train-forever</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">dataset</span> <span class="p">(</span><span class="nf">create-dataset</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">initial-description</span> <span class="p">(</span><span class="nf">create-basic-network-description</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">confusion-matrix-atom</span> <span class="p">(</span><span class="nf">display-dataset-and-model</span> <span class="nv">dataset</span> <span class="nv">initial-description</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">classification/train-forever</span> <span class="nv">dataset</span> <span class="nv">observation-&gt;image</span>
</span><span class='line'>                                  <span class="nv">initial-description</span>
</span><span class='line'>                                  <span class="ss">:confusion-matrix-atom</span> <span class="nv">confusion-matrix-atom</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This opens a port to a localhost webpage where we can view the progress <code>http://localhost:8091/</code></p>

<p><img src="http://c3.staticflickr.com/1/599/31877481106_ab49402b71_b.jpg"></p>

<p>Below the confusion matrix is shown. This tracks the progress of the training in the classification. In particular, how many times it thought a cat was really a cat and how many times it got it wrong.</p>

<p><img src="http://c7.staticflickr.com/1/371/31541533750_69d80cc7fa.jpg"></p>

<p>As we are training the data, the loss for each epoch is shown on the console as well as when it saves the network to the external file.</p>

<p>After only thirty minutes of training on my Mac Book Pro, we get to some pretty good results, with the correct percentage in the 99s :</p>

<p><img src="http://c1.staticflickr.com/1/707/31541538600_8e61134375.jpg"></p>

<p>It&rsquo;s time to do some inference on our trained network.</p>

<h2>Inference</h2>

<p>Firing up a REPL we can connect to our namespace and use the <code>label-one</code> function from the cortex example to spot check our classification. It reads in the external nippy file that contains the trained network description, takes a random image from the testing directory, and classifies it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">label-one</span>
</span><span class='line'>  <span class="s">&quot;Take an arbitrary image and label it.&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-label-pairs</span> <span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">classification/directory-&gt;file-label-seq</span> <span class="nv">testing-dir</span>
</span><span class='line'>                                                                            <span class="nv">false</span><span class="p">))</span>
</span><span class='line'>        <span class="p">[</span><span class="nv">test-file</span> <span class="nv">test-label</span><span class="p">]</span> <span class="p">(</span><span class="nb">first </span><span class="nv">file-label-pairs</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">test-img</span> <span class="p">(</span><span class="nf">imagez/load-image</span> <span class="nv">test-file</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">observation</span> <span class="p">(</span><span class="nf">png-&gt;observation</span> <span class="nv">dataset-datatype</span> <span class="nv">false</span> <span class="nv">test-img</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">imagez/show</span> <span class="nv">test-img</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">infer/classify-one-observation</span> <span class="p">(</span><span class="ss">:network-description</span>
</span><span class='line'>                                     <span class="p">(</span><span class="nf">suite-io/read-nippy-file</span> <span class="s">&quot;trained-network.nippy&quot;</span><span class="p">))</span>
</span><span class='line'>                                    <span class="nv">observation</span>
</span><span class='line'>                                    <span class="p">(</span><span class="nf">ds/create-image-shape</span> <span class="nv">dataset-num-channels</span>
</span><span class='line'>                                                           <span class="nv">dataset-image-size</span>
</span><span class='line'>                                                           <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>                                    <span class="nv">dataset-datatype</span>
</span><span class='line'>                                    <span class="p">(</span><span class="nf">classification/get-class-names-from-directory</span> <span class="nv">testing-dir</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running <code>(label-one)</code> gives us the picture:</p>

<p><img src="http://c2.staticflickr.com/1/423/31105658073_b6143b2f00.jpg"></p>

<p>and classifies it as a cat. Yipee!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:probability-map</span> <span class="p">{</span><span class="s">&quot;cat&quot;</span> <span class="mf">0.9995587468147278</span>, <span class="s">&quot;dog&quot;</span> <span class="mf">4.4119369704276323</span><span class="nv">E-4</span><span class="p">}</span>, <span class="ss">:classification</span> <span class="s">&quot;cat&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad, but let&rsquo;s try it with something harder. Personally, I&rsquo;m not even sure whether this is a cat or a dog.</p>

<p><img src="http://c6.staticflickr.com/1/596/31105666133_223dc2f04e_c.jpg"></p>

<p>Feeding it through the program &ndash; it says it is a cat.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">{</span><span class="ss">:probability-map</span> <span class="p">{</span><span class="s">&quot;cat&quot;</span> <span class="mf">0.9942012429237366</span>, <span class="s">&quot;dog&quot;</span> <span class="mf">0.005798777565360069</span><span class="p">}</span>, <span class="ss">:classification</span> <span class="s">&quot;cat&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After much <a href="http://www.today.com/pets/cat-or-dog-wild-eyed-cutie-has-us-all-confused-t104835">debate on the internet</a>, I think that is the best answer the humans got too :)</p>

<h2>Kaggle it</h2>

<p>So it seems like we have a pretty good model, why don&rsquo;t we submit our results to the Kaggle competition and see how it rates. All they need is to have us run the classification against their test data of 12,500 images and classify them as 1 = dog or 0 = cat in a csv format.</p>

<p>We will take each image and resize it, then feed it into cortex&rsquo;s <code>infer-n-observations</code> function, to do all our classification as a batch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">(</span><span class="nf">infer/infer-n-observations</span> <span class="p">(</span><span class="ss">:network-description</span>
</span><span class='line'>                                             <span class="p">(</span><span class="nf">suite-io/read-nippy-file</span> <span class="s">&quot;trained-network.nippy&quot;</span><span class="p">))</span>
</span><span class='line'>                                            <span class="nv">observations</span>
</span><span class='line'>                                            <span class="p">(</span><span class="nf">ds/create-image-shape</span> <span class="nv">dataset-num-channels</span>
</span><span class='line'>                                                                   <span class="nv">dataset-image-size</span>
</span><span class='line'>                                                                   <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>                                            <span class="nv">dataset-datatype</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we just need to format our results to a csv file and export it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">write-kaggle-results</span> <span class="p">[</span><span class="nv">results</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">out-file</span> <span class="p">(</span><span class="nf">io/writer</span> <span class="s">&quot;kaggle-results.csv&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">csv/write-csv</span> <span class="nv">out-file</span>
</span><span class='line'>                   <span class="p">(</span><span class="nb">into </span><span class="p">[[</span><span class="s">&quot;id&quot;</span> <span class="s">&quot;label&quot;</span><span class="p">]]</span>
</span><span class='line'>                         <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">mapv</span> <span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">id</span> <span class="nv">class</span><span class="p">]]</span> <span class="p">[(</span><span class="nf">Integer/parseInt</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">&quot;dog&quot;</span> <span class="nv">class</span><span class="p">)</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">)])</span> <span class="nv">results</span><span class="p">)</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">sort</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>After uploading the file to the Kaggle, I was pleased that the answer got in the top 91%! It made it on the <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/leaderboard">Leaderboard</a>.</p>

<h2>Conclusion</h2>

<p>Using an example setup from the Cortex project and 30 minutes of processing time on my laptop, we were able to crunch through some significant data and come up with a trained classification model that was good enough to make the charts in the Kaggle competition. On top of it all, it is in pure Clojure.</p>

<p>In my mind, this is truely impressive and even though the Cortex library is in it&rsquo;s early phases, it puts it on track to be as useful a tool as Tensor Flow for Machine Learning.</p>

<p>Earlier this month, I watched an ACM Learning webcast with Peter Norvig speaking on AI. In it, he spoke of one of the next challenges of AI which is to combine <a href="https://twitter.com/gigasquid/status/806916856040689664?lang=en">symbolic with neural</a>. I can think of no better language than Clojure with it&rsquo;s simplicity, power, and rich LISP heritage to take on the challenge for the future. With the Cortex library, it&rsquo;s off to a great start.</p>

<p><em>If want to see all the cats vs dog  Kaggle Code, it&rsquo;s out on github here <a href="https://github.com/gigasquid/kaggle-cats-dogs">https://github.com/gigasquid/kaggle-cats-dogs</a></em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Genetic Programming with clojure.spec]]></title>
    <link href="http://gigasquid.github.io/blog/2016/07/18/genetic-programming-with-clojure-dot-spec/"/>
    <updated>2016-07-18T09:40:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2016/07/18/genetic-programming-with-clojure-dot-spec</id>
    <content type="html"><![CDATA[<p><img src="http://c1.staticflickr.com/9/8815/28320682816_44780d1b75.jpg"></p>

<p><a href="http://blog.cognitect.com/blog/2016/5/23/introducing-clojurespec">Clojure.spec</a> is a new library for Clojure that enables you to write specifications for your program.  In an earlier <a href="http://gigasquidsoftware.com/blog/2016/05/29/one-fish-spec-fish/">post</a>, I showed off some of it&rsquo;s power to generate test data from your specifications.  It&rsquo;s a pretty cool feature.  Given some clojure.spec code, you can generate sample data for you based off of the specifications.  But what if you could write a program that would <em>generate</em> your clojure.spec program based off of data so that you could generate more test data?</p>

<h2>Genetic programming</h2>

<p>Here is where we embark for fun.  We are going to use genetic programming to generate clojure.spec <em>creatures</em> that contain a program.  Through successive generations, those creatures will breed, mutate, and evolve to fit the data that we are going to give it.  Going with our creature theme, we can say that it <em>eats</em> a sequence of data like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="s">&quot;hi&quot;</span> <span class="nv">true</span> <span class="mi">5</span> <span class="mi">10</span> <span class="s">&quot;boo&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each creature will be represented by a map that has information about two key pieces, its program and the <em>fitness</em> score.  Each program is going to start with a <a href="https://clojure.github.io/clojure/branch-master/clojure.spec-api.html#clojure.spec/cat">clojure.spec/cat</a>, (which is the spec to describe a sequence).  From here on out, I&rsquo;m going to refer to the clojure.spec namespace as <code>s/</code>.  So, a simple creature would look like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>
</span><span class='line'> <span class="ss">:score</span> <span class="mi">0</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>How do we figure out a score from the creature&rsquo;s spec?  We run the spec and see how much of the data that it can successfully consume.</p>

<h3>Scoring a creature</h3>

<p>To score a creature, we&rsquo;re going to use the clojure.spec <code>explain-data</code> function. It enables us to run a spec against some data and get back the problems in a data format that we can inspect.  If there are no problems and the spec passes, the result is nil.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>  <span class="p">[</span><span class="mi">1</span> <span class="s">&quot;hi&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, if there is a problem, we can get information about what went wrong.  In particular, we can see <em>where</em> it went wrong in the sequence.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>  <span class="p">[</span><span class="mi">1</span> <span class="nv">true</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; #:clojure.spec{:problems [{:path [:1], :pred string?, :val true, :via [], :in [1]}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above example, the <code>:in</code> key tells us that it fails at index 1. This gives us all the information we need to write a score function for our creature.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">score</span> <span class="p">[</span><span class="nv">creature</span> <span class="nv">test-data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">try</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">problems</span> <span class="p">(</span><span class="ss">:clojure.spec/problems</span> <span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="ss">:program</span> <span class="nv">creature</span><span class="p">))</span> <span class="nv">test-data</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="nv">problems</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">problems</span> <span class="p">[</span><span class="mi">0</span> <span class="ss">:in</span> <span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="mi">100</span><span class="p">)))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">catch</span> <span class="nv">Throwable</span> <span class="nv">e</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="mi">0</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This function tries to run the spec against the data.  If there are no problems, the creature gets a 100 score.  Otherwise, it records the farthest point in the sequence that it got.  Creatures with a higher score are considered more <em>fit</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">score</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)}</span> <span class="p">[</span><span class="mi">1</span> <span class="nv">true</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; {:program (s/cat :0 int? :1 string?), :score 1}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a fitness function to evaluate our creatures, we need a way to generate a random clojure.spec creature.</p>

<p><img src="http:////c1.staticflickr.com/9/8781/28071856800_0477b25fcc.jpg"></p>

<h3>Create a random creature</h3>

<p>This is where I really love Clojure.  Code is data, so we can create the programs as lists and they are just themselves.  To run the programs, we just need to call <code>eval</code> on them.  We are going to constrain the creatures somewhat.  They are all going to start out with <code>s/cat</code> and have a certain length of items in the sequence.  Also, we are going to allow the parts of the spec to be created with certain predicates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">preds</span> <span class="p">[</span><span class="ss">&#39;integer?</span> <span class="ss">&#39;string?</span> <span class="ss">&#39;boolean?</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">even?</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also allowing, composition with ands and ors and other sequences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">seqs</span> <span class="p">[</span><span class="ss">&#39;s/+</span> <span class="ss">&#39;s/*</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">and-ors</span> <span class="p">[</span><span class="ss">&#39;s/and</span> <span class="ss">&#39;s/or</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are also going to have some probability knobs to control how the random creature is constructed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">seq-prob</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nest-prob</span> <span class="mf">0.00</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">max-depth</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">and-or-prob</span> <span class="mf">0.85</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>seq-prob</code> is the probability that a new spec sub sequence will be constructed.  The <code>nest-prob</code> is set to zero right now, to keep things simple, but if turned up with increase the chance that a nested spec sequence would occur.  We are going to be writing a recursive function for generation, so we&rsquo;ll keep things to a limited depth with <code>max-depth</code>.  Finally, we have the chance that when constructing a spec sub sequence, that it will be an and/or with <code>and-or-prob</code>.  Putting it all together with code to construct a random arg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-arg</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">pos? </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">seq-prob</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">make-random-seq</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">preds</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also creating a random sub sequence.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-seq</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">nest-prob</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">s/spec</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">seqs</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">and-or-prob</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">and-ors</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">))</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="ss">:else</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">seqs</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we can create a random <code>s/cat</code> spec with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-cat</span> <span class="p">[</span><span class="nv">len</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">args</span> <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">r</span> <span class="nv">i</span><span class="p">]</span>
</span><span class='line'>                       <span class="p">(</span><span class="nb">conj </span><span class="nv">r</span> <span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nb">str </span><span class="nv">i</span><span class="p">))</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">make-random-arg</span> <span class="nv">max-depth</span><span class="p">)))</span>
</span><span class='line'>                     <span class="p">[]</span>
</span><span class='line'>                     <span class="p">(</span><span class="nb">range </span><span class="nv">len</span><span class="p">))]</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">s/cat</span> <span class="o">~@</span><span class="nv">args</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see it in action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">make-random-cat</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; (clojure.spec/cat :0 (s/and integer? odd?) :1 integer? :2 boolean?)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can make a batch of new creatures for our initial population using this function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">initial-population</span> <span class="p">[</span><span class="nv">popsize</span> <span class="nv">max-cat-length</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="nv">popsize</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">make-random-cat</span> <span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nb">rand-int </span><span class="nv">max-cat-length</span><span class="p">)))}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! Now we have a way to make new random spec creatures.  But, we need a way to alter them and let them evolve.  The first way to do this is with <em>mutation</em>.</p>

<p><img src="http://c2.staticflickr.com/9/8807/28275661121_94361d2fc4.jpg"></p>

<h3>Mutating a creature</h3>

<p>Mutation in our case, means changing part of the code tree of the creature&rsquo;s program.  To keep the program runnable, we don&rsquo;t want to be able to mutate every node, only specific ones.  We&rsquo;re going to control this by defining a <code>mutable</code> function that will only change nodes that start with our sequences or predicates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">mutable?</span> <span class="p">[</span><span class="nv">node</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">seq? </span><span class="nv">node</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nf">set/union</span> <span class="p">(</span><span class="nb">set </span><span class="nv">seqs</span><span class="p">)</span> <span class="o">#</span><span class="p">{</span><span class="ss">&#39;clojure.spec/spec</span><span class="p">})</span> <span class="p">(</span><span class="nb">first </span><span class="nv">node</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">preds</span><span class="p">)</span> <span class="nv">node</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we can use <code>postwalk</code> to walk the code tree and alter a node by a mutation probability factor</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mutate-prob</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">mutate</span> <span class="p">[</span><span class="nv">creature</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">program</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">mutated-program</span> <span class="p">(</span><span class="nf">walk/postwalk</span>
</span><span class='line'>                         <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">mutable?</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">mutate-prob</span><span class="p">))</span>
</span><span class='line'>                                  <span class="p">(</span><span class="nf">make-random-arg</span> <span class="nv">max-depth</span><span class="p">)</span>
</span><span class='line'>                                  <span class="nv">x</span><span class="p">))</span> <span class="nv">program</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:program</span> <span class="nv">mutated-program</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trying it on one of our creatures.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">mutate</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)</span> <span class="ss">:1</span> <span class="nv">integer?</span><span class="p">)})</span>
</span><span class='line'><span class="c1">;=&gt; {:program (clojure.spec/cat :0 (s/or (s/and integer? even?)) :1 integer?)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can change our creatures via mutation, but what about breeding it with other creatures?</p>

<p><img src="http://c8.staticflickr.com/9/8670/28354279095_25661401c0_z.jpg"></p>

<h3>Crossovers with creatures</h3>

<p>Crossover is another way to modify programs.  It takes two creatures and swaps a node from one creature to another. To accomplish this, we&rsquo;re going to use the <code>walk</code> function to select at a random probability the crossover node from the first node, then insert it into the second&rsquo;s creatures program at another random spot.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">crossover-prob</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">crossover</span> <span class="p">[</span><span class="nv">creature1</span> <span class="nv">creature2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">program1</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature1</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">program2</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature2</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">chosen-node</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">walk/walk</span>
</span><span class='line'>                            <span class="o">#</span><span class="p">(</span><span class="nf">when</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">crossover-prob</span><span class="p">)</span>
</span><span class='line'>                                      <span class="p">(</span><span class="nf">mutable?</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>                               <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                            <span class="o">#</span><span class="p">(</span><span class="nb">remove nil? </span><span class="nv">%</span><span class="p">)</span> <span class="nv">program1</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">crossed-over?</span> <span class="p">(</span><span class="nf">atom</span> <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">crossover-program</span> <span class="p">(</span><span class="k">if </span><span class="nv">chosen-node</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">walk/postwalk</span>
</span><span class='line'>                              <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>                                <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">mutable?</span> <span class="nv">x</span><span class="p">)</span>
</span><span class='line'>                                         <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">crossover-prob</span><span class="p">)</span>
</span><span class='line'>                                         <span class="p">(</span><span class="nb">not </span><span class="err">@</span><span class="nv">crossed-over?</span><span class="p">))</span>
</span><span class='line'>                                  <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">reset!</span> <span class="nv">crossed-over?</span> <span class="nv">true</span><span class="p">)</span> <span class="nv">chosen-node</span><span class="p">)</span>
</span><span class='line'>                                  <span class="nv">x</span><span class="p">))</span>
</span><span class='line'>                              <span class="nv">program2</span><span class="p">)</span>
</span><span class='line'>                             <span class="nv">program2</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:program</span> <span class="nv">crossover-program</span><span class="p">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Taking two creatures and putting them together.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">crossover</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)</span> <span class="ss">:1</span> <span class="nv">integer?</span><span class="p">)}</span>
</span><span class='line'>           <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="nb">string? </span><span class="ss">:1</span> <span class="nv">boolean?</span><span class="p">)})</span>
</span><span class='line'><span class="c1">;=&gt; {:program (clojure.spec/cat :0 (s/and integer? odd?) :1 boolean?)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have our ways to change our creatures to let them evolve and we have a way to rank them.  What we need now is to put it together in a way that will let them evolve to the solution.</p>

<p><img src="http://c5.staticflickr.com/9/8570/28320682956_2a301eea70_z.jpg"></p>

<h3>Evolving creatures</h3>

<p>The process will be in general terms:</p>

<ul>
<li>Create initial population</li>
<li>Rank them</li>
<li>Take the top two best ones and carry them over (this is known as <em>elitism</em>)</li>
<li>Create the next generation from by <em>selecting</em> creatures for crossover and mutation</li>
<li>Repeat!</li>
</ul>


<p>So how do we select the best creatures for our next population?  This is an interesting question, there are many approaches.  The one that we&rsquo;re going to use is called <a href="https://en.wikipedia.org/wiki/Tournament_selection">tournament selection</a>.  It involves picking n creatures from the whole population and then, among those, picking the best scored one.  This will allow diversity in our population that is needed for proper evolution.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">select-best</span> <span class="p">[</span><span class="nv">creatures</span> <span class="nv">tournament-size</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">selected</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">tournament-size</span> <span class="o">#</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">creatures</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">selected</span><span class="p">)</span> <span class="nb">reverse </span><span class="nv">first</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re now ready to write our evolve function.  In it, we pass in the population size, how many generations we want, the tournament size, and of course, our test data that our creatures are going to feed on.  The loop ends when it reaches a perfect fitting solution, (a creature with a score of 100), or the max generations.</p>

<p>Note that we have a chance for a completely random creature to appear in the generations, to further encourage diversity.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">perfect-fit</span> <span class="p">[</span><span class="nv">creatures</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="mi">100</span> <span class="p">(</span><span class="ss">:score</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">creatures</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">evolve</span> <span class="p">[</span><span class="nv">pop-size</span> <span class="nv">max-gen</span> <span class="nv">tournament-size</span> <span class="nv">test-data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">n</span> <span class="nv">max-gen</span>
</span><span class='line'>         <span class="nv">creatures</span> <span class="p">(</span><span class="nf">initial-population</span> <span class="nv">pop-size</span> <span class="p">(</span><span class="nb">count </span><span class="nv">test-data</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;generation &quot;</span> <span class="p">(</span><span class="nb">- </span><span class="nv">max-gen</span> <span class="nv">n</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">scored-creatures</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">creature</span><span class="p">]</span> <span class="p">(</span><span class="nf">score</span> <span class="nv">creature</span> <span class="nv">test-data</span><span class="p">))</span> <span class="nv">creatures</span><span class="p">)]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">scored-creatures</span><span class="p">))</span>
</span><span class='line'>       <span class="nv">scored-creatures</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">elites</span> <span class="p">(</span><span class="nb">take </span><span class="mi">2</span> <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">scored-creatures</span><span class="p">)))</span>
</span><span class='line'>             <span class="nv">new-creatures</span> <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">count </span><span class="nv">creatures</span><span class="p">)</span> <span class="mi">2</span><span class="p">))]</span>
</span><span class='line'>                             <span class="c1">;; add a random node to improve diversity</span>
</span><span class='line'>                             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">new-node-prob</span><span class="p">)</span>
</span><span class='line'>                               <span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">make-random-cat</span> <span class="p">(</span><span class="nb">count </span><span class="nv">test-data</span><span class="p">))}</span>
</span><span class='line'>                               <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">creature1</span> <span class="p">(</span><span class="nf">select-best</span> <span class="nv">scored-creatures</span> <span class="nv">tournament-size</span><span class="p">)</span>
</span><span class='line'>                                     <span class="nv">creature2</span> <span class="p">(</span><span class="nf">select-best</span> <span class="nv">scored-creatures</span> <span class="nv">tournament-size</span><span class="p">)]</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nf">mutate</span> <span class="p">(</span><span class="nf">crossover</span> <span class="nv">creature1</span> <span class="nv">creature2</span><span class="p">)))))]</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">println </span><span class="s">&quot;best-scores&quot;</span> <span class="p">(</span><span class="nb">map </span><span class="ss">:score</span> <span class="nv">elites</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nb">into </span><span class="nv">new-creatures</span> <span class="nv">elites</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trying it out. We get a perfect clojure.spec creature!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">creature-specs</span> <span class="p">(</span><span class="nf">evolve</span> <span class="mi">100</span> <span class="mi">100</span> <span class="mi">7</span> <span class="p">[</span><span class="s">&quot;hi&quot;</span> <span class="nv">true</span> <span class="mi">5</span> <span class="mi">10</span> <span class="s">&quot;boo&quot;</span><span class="p">]))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">creature-specs</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;=&gt;{:program (clojure.spec/cat :0 string? :1 boolean? :2 (s/and integer? odd?) :3 integer? :4 string?)</span>
</span><span class='line'>      <span class="ss">:score</span> <span class="mi">100</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, our clojure.spec creature can generate data on its own with the <code>exercise</code> function.  Let&rsquo;s have it generate 5 more examples of data that conform to its spec.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">(</span><span class="nf">s/exercise</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">creature-specs</span><span class="p">)))</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(&quot;&quot; true -1 -1 &quot;&quot;) {:0 &quot;&quot;, :1 true, :2 -1, :3 -1, :4 &quot;&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;D&quot; false -1 -1 &quot;G&quot;) {:0 &quot;D&quot;, :1 false, :2 -1, :3 -1, :4 &quot;G&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;12&quot; false -1 0 &quot;l0&quot;) {:0 &quot;12&quot;, :1 false, :2 -1, :3 0, :4 &quot;l0&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;&quot; false -1 -2 &quot;&quot;) {:0 &quot;&quot;, :1 false, :2 -1, :3 -2, :4 &quot;&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;2&quot; false 1 0 &quot;Jro&quot;) {:0 &quot;2&quot;, :1 false, :2 1, :3 0, :4 &quot;Jro&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we wanted to, we could adjust our evolve function and let it continue to evolve creatures and lots of different solutions to choose from. We could even take the generated data from the <code>exercise function</code> and let it generate more creatures who generate more data&hellip;&hellip;</p>

<p>The mind boggles.</p>

<p>We&rsquo;ll leave with a quick summary of Genetic Programming.</p>

<ul>
<li>Start with a way to generate random creatures</li>
<li>Have a way to evaluate their fitness</li>
<li>Create a way to change them for the next generations using

<ul>
<li>Mutation</li>
<li>Crossover</li>
</ul>
</li>
<li>Have an evolution process

<ul>
<li>Create an initial population</li>
<li>Rank them</li>
<li>Create the next generation using selection techniques and mutation/ crossovers</li>
<li>Don&rsquo;t forget about diversity</li>
</ul>
</li>
</ul>


<p>Most importantly, have fun!</p>

<p>If you want to play with the code, it&rsquo;s on github here <a href="https://github.com/gigasquid/genetic-programming-spec">https://github.com/gigasquid/genetic-programming-spec</a></p>

<p>If you want to learn more about clojure.spec this <a href="https://www.youtube.com/watch?v=nqY4nUMfus8">video</a> is a great place to start.  The <a href="http://clojure.org/guides/spec">guide</a> is also a great reference with examples.</p>

<p>If you want to learn more about genetic programming, there are a couple of books I would recommend: <a href="https://www.amazon.com/Programming-Collective-Intelligence-Building-Applications/dp/0596529325">Collective Intelligence</a> and <a href="https://www.amazon.com/Genetic-Algorithms-Structures-Evolution-Programs/dp/3540606769/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1468862704&amp;sr=1-1&amp;keywords=genetic+algorithms+data+structures">Genetic Algorithms + Data Structures = Evolution Programs</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello World for the Next Generation]]></title>
    <link href="http://gigasquid.github.io/blog/2016/07/03/hello-world/"/>
    <updated>2016-07-03T15:01:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2016/07/03/hello-world</id>
    <content type="html"><![CDATA[<p>I sit next to my daughter, showing her programming for the first time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;Now press enter.&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;Pretty cool, huh?&rdquo;</p>

<p>She looks unimpressed.  I fear I&rsquo;m losing her.  How can I explain that this is just a small tip of something so much bigger?</p>

<h3>You can make the code sing to you.</h3>

<p>You can take these numbers, turn them into notes, and line them up with the beat of your heart. Bring in the melody and chorus and build them up to a crescendo. Let it crash in waves and then</p>

<h3>You can make the code dance for you.</h3>

<p>You can create delicate swirls and patterns with mathematical expressions.  Have them pulse to the music in a never ending prism of fractals, flexing your control with confidence because</p>

<h3>You can make the code lift you up.</h3>

<p>It doesn&rsquo;t matter if you don&rsquo;t look like them.  It doesn&rsquo;t matter if they think you don&rsquo;t belong. They can&rsquo;t hold you back. You&rsquo;re smart and strong and</p>

<h3>You can make the code create your life.</h3>

<p>You can solve problems for people.  Make things work better and faster.  Keep the data flowing.  Make a company for yourself.  Watch that company and your power and influence in the world grow until nothing feels out of reach and then, if you&rsquo;re not careful</p>

<h3>You can make the code hard and cruel.</h3>

<p>You can automate hate.  Use the latest AI to keep them in control.  Watch them with never sleeping eyes.  Steal their money and point guns at them with armed robots.  Then, late at night, you can think how</p>

<h3>You can let the code control you.</h3>

<p>You can forget the important things in life.  Turn away from family and friends.  Lose yourself in some self created digital representation of yourself that never feels smart enough and leaves you grasping for more.  Until that day, when you walk the streets with a deadened heart and you see the sad faces all around and you remember that</p>

<h3>You can let the code make them smile.</h3>

<p>You can use your skills to brighten dark days.  Use your programs to make them laugh.  When you have their attention, inspire them to dream with you of a better world and next</p>

<h3>You can make the code save lives.</h3>

<p>You can turn those algorithms to heal.  Dive in and join the battle against death and disease.  Make sense of all the data.  Then lift your head to the sky and</p>

<h3>You can make the code reach the stars.</h3>

<p>You can see the surface of Mars.  Pick up a rock from a planet that was unimaginable generations before.  Look out at what is beyond our solar system and peer into the mysteries of the beginning of time.</p>

<h3>You can.</h3>

<p>All these things are yours now.  The terrible and beautiful power of it.</p>

<p>I reach down to type the code that distills my hopes and fears for the next generation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">println </span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I slide the keyboard over to her, a tear sliding down my cheek, and lean over to whisper the only advice that I can form into words,</p>

<p>&ldquo;Don&rsquo;t forget the closing parens.&rdquo;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Book Writing for the Busy Programmer]]></title>
    <link href="http://gigasquid.github.io/blog/2016/06/19/book-writing-for-the-busy-programmer/"/>
    <updated>2016-06-19T09:22:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2016/06/19/book-writing-for-the-busy-programmer</id>
    <content type="html"><![CDATA[<p><img src="http://c5.staticflickr.com/8/7302/27492453220_eecdf6dee1.jpg"></p>

<p>So you want to write a book?  Awesome.  I&rsquo;ve been working on one too for the last year.</p>

<p>No, it&rsquo;s not really a programming book, but it does have code in it.  It&rsquo;s a sci-fi/fantasy book written for my ten year daughter, but this post isn&rsquo;t about that.  It&rsquo;s about sharing the tools and setup that I&rsquo;ve found work best for me.</p>

<h2>Tools for Writing</h2>

<p>If the first thing you think of when you want to write a book is creating some really cool tools to help you, I can totally relate.  It&rsquo;s a programmer thing.</p>

<p>Hold on though, there&rsquo;s another way.</p>

<p>Starting out with only my book idea, I spent some time looking at the best authoring tools out there.  I knew that I wanted to able to write in an editor that I was comfortable in and in a terse format like Markdown.  I also wanted to be able to use git for revision management.  After searching, I settled on <a href="https://leanpub.com/">Leanpub</a></p>

<p>Leanpub is a free service for authoring that has <a href="https://leanpub.com/help/getting_started_sync_github">Git integration</a> in <a href="https://leanpub.com/help">Markdown format</a>.  With it, I was able to write in my favorite text editor, (Emacs of course), commit and push my changes to my git repo, and then generate PDF and e-book formats.  The multiple formats were important to me because it allowed me to share my chapters and get feedback.</p>

<h2>Tools for Feedback</h2>

<p>Since I was writing a book with my daughter in mind, the most important feedback was from her.  After every chapter was done.  I would either print her out a copy or download it to her Kindle for review.  She actually really enjoyed reading it on her Kindle because it made it for more <em>real</em> to her.  My son also got interested in the story and before long, I had them both getting in heated debates about which direction the story should go.</p>

<p>After my kids reviewed the chapters, I also sought some professional writing advice from a free-lance editor.  I highly recommend getting this sort of feedback from an editor, writing group, or trusted friend to help you grow and improve. The one catch is that most of the writing world works with Microsoft Word, so I needed to convert my chapters to that format.</p>

<p>From my experience, all PDF to Word converters are full of fail.  The formatting goes all over the place and your writing ends up looking like some horrible abstract text art experiment gone wrong.  So far, the best converter I&rsquo;ve found is <a href="http://pandoc.org/">pandoc</a>.  It allows you to take your Markdown files and turn them into quite presentable Word documents.</p>

<p>If you have a Mac, it&rsquo;s as simple as <code>brew install pandoc</code>.  Then, you can create a simple script to convert all your chapters,(or a selection) into a properly formatted Word Doc.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>rm ./all.md
</span><span class='line'>for i in `cat ./Book.txt`; do  cat $i &gt;&gt; all.md; echo "  " &gt;&gt; all.md ; done
</span><span class='line'>pandoc -o all.docx -f markdown -t docx ./all.md</span></code></pre></td></tr></table></div></figure>


<p>Once you write your manuscript, (what the publishing world calls your book text), revise it, copy edit it, and walk backwards in a circle three times, you&rsquo;re ready to publish.</p>

<h2>Tools for Publishing</h2>

<p>I don&rsquo;t have any real firm advice in this area yet since I&rsquo;m still in the midst of it, but I&rsquo;ll share the two options that I&rsquo;m looking at &ndash; traditional publishing and self publishing.</p>

<p>Self publishing is more easily understood of the two.  You can put your book up for sale at any time through Leanpub or Amazon.  For better or worse, you have complete control of the content, display, marketing, and revenue of your book.</p>

<p>Traditional publishing involves finding an literary agent and/or publisher to work with.  This route involves pitching your manuscript to someone to represent it through a <a href="http://nybookeditors.com/2015/12/how-to-write-a-darn-good-query-letter/">query</a>.  The advantages of this are that, (if you find a good match), you will have a team of people helping you make your book the best it can be and have the possibility of getting it on the shelf in a bookstore.  One of the downsides is that the traditional publishing world takes a lot longer than pushing the self publish button.</p>

<p>With any luck, I&rsquo;ll have a clearer picture of this all in a bit and be able to share my experiences.  In the meantime, I encourage you to grab your keyboard and bring your book ideas to life.</p>

<p>No matter the outcome, it&rsquo;s a rewarding journey.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[One Fish Spec Fish]]></title>
    <link href="http://gigasquid.github.io/blog/2016/05/29/one-fish-spec-fish/"/>
    <updated>2016-05-29T16:29:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2016/05/29/one-fish-spec-fish</id>
    <content type="html"><![CDATA[<p><img src="https://upload.wikimedia.org/wikipedia/en/9/9a/One_Fish_Two_Fish_Red_Fish_Blue_Fish_%28cover_art%29.jpg"></p>

<p><a href="http://blog.cognitect.com/blog/2016/5/23/introducing-clojurespec">Clojure.spec</a> is an exciting, new core library for Clojure.  It enables pragmatic specifications for functions and brings a new level of robustness to building software in Clojure, along with unexpected side benefits.  One of which is the ability to write specifications that generate Dr. Seuss inspired rhymes.</p>

<p>In this blog post, we&rsquo;ll take a tour of writing specifications for a clojure function, as well as the power of data generation.  First, some inspirational words:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>One fish
</span><span class='line'>Two fish
</span><span class='line'>Red fish
</span><span class='line'>Blue fish</span></code></pre></td></tr></table></div></figure>


<p>The mere shape of these words brings a function to mind.  One that would take in a vector:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>and give us back a string of transformed items with the word <em>fish</em> added, of course.</p>

<p>But, let us turn our attention the parameters of this function and see how we can further specify them.  Before we get started, make sure you use the latest version of clojure, currently <code>[org.clojure/clojure "1.9.0-alpha13"]</code>,  test.check <code>[org.clojure/test.check "0.9.0"]</code>, and add clojure.spec to your namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">one-fish.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.spec</span> <span class="ss">:as</span> <span class="nv">s</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Specifying the values of the parameters</h3>

<p>Back to the parameters. The first two are integers, that&rsquo;s pretty easy, but we want to say more about them.  For example, we don&rsquo;t want them to be very big.  Having a child&rsquo;s poem with the <em>One Hundred Thousand and Thirty Three fish</em> really won&rsquo;t do.  In fact, what we really want is to say is there is finite notion of <em>fish-numbers</em> and it&rsquo;s a map of integer to string representation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">fish-numbers</span> <span class="p">{</span><span class="mi">0</span> <span class="s">&quot;Zero&quot;</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="s">&quot;One&quot;</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="s">&quot;Two&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we can use the <code>s/def</code> to register the spec we are going to define for global reuse.  We&rsquo;ll use a namespaced keyword <code>::fish-number</code> to express that our specification for a valid number is the keys of the <code>fish-numbers</code> map.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::fish-number</span> <span class="p">(</span><span class="nb">set </span><span class="p">(</span><span class="nb">keys </span><span class="nv">fish-numbers</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have the specification, we can ask it if it&rsquo;s valid for a given value.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::fish-number</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::fish-number</span> <span class="mi">5</span><span class="p">)</span> <span class="c1">;=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>So <code>5</code> is not a valid number for us.  We can ask it to explain why not.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::fish-number</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;;val: 5 fails spec: :one-fish.core/fish-number predicate: (set (keys fish-numbers))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which, of course,  totally makes sense because <code>5</code> is not in our <code>fish-numbers</code> map.  Now that we&rsquo;ve covered the numbers, let&rsquo;s look at the colors.  We&rsquo;ll use a finite set of colors for our specification.  In addition to the classic red and blue, we&rsquo;ll also add the color <em>dun</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::color</span> <span class="o">#</span><span class="p">{</span><span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span> <span class="s">&quot;Dun&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>You may be asking yourself, &ldquo;Is dun really a color?&rdquo;.  The author can assure you that it is in fact a real color, like a <a href="http://www.dictionary.com/browse/dun">dun colored horse</a>.  Furthermore, the word has the very important characteristic of rhyming with number one, which the author spent way too much time trying to think of.</em></p>

<h3>Specifying the sequences of the values</h3>

<p>We&rsquo;re at the point where we can start specifying things about the sequence of values in the parameter vector.  We&rsquo;ll have two numbers followed by two colors.  Using the <code>s/cat</code>, which is a concatentation of predicates/patterns, we can specify it as the <code>::first-line</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What the spec is doing here is associating each <em>part</em> with a <em>tag</em>, to identify what was matched or not, and its predicate/pattern.  So, if we try to explain a failing spec, it will tell us where it went wrong.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span>  <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Black&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;; In: [3] val: &quot;Black&quot; fails spec: :one-fish.core/color</span>
</span><span class='line'><span class="c1">;;   at: [:c2] predicate: #{&quot;Blue&quot; &quot;Dun&quot; &quot;Red&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s great, but there&rsquo;s more we can express about the sequence of values.  For example, the second number should be one bigger than the first number.  The input to the function is going to be the map of the destructured tag keys from the <code>::first-line</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">one-bigger?</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">n1</span> <span class="nv">n2</span><span class="p">]}]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="nv">n2</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">n1</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, the colors should not be the same value.  We can add these additional specifications with <code>s/and</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/and</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">)</span>
</span><span class='line'>                           <span class="nv">one-bigger?</span>
</span><span class='line'>                           <span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:c1</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c2</span> <span class="nv">%</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can test if our data is valid.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to get the destructured, conformed values, we can use <code>s/conform</code>.  It will return the tags along with the values.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/conform</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Failing values for the specification can be easily identified.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; false</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;; val: {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}</span>
</span><span class='line'><span class="c1">;; fails spec: :one-fish.core/first-line predicate: one-bigger?</span>
</span></code></pre></td></tr></table></div></figure>


<p>With our specifications for both the values and the sequences of values in hand, we can now use the power of data generation to actually create data.</p>

<h3>Generating test data &ndash; and poetry with specification</h3>

<p>The <code>s/exercise</code> function will generate data for your specifications.  It does 10 items by default, but we can tell it to do only 5.  Let&rsquo;s see what it comes up with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/exercise</span> <span class="ss">::first-line</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(0 1 &quot;Dun&quot; &quot;Red&quot;) {:n1 0, :n2 1, :c1 &quot;Dun&quot;, :c2 &quot;Red&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Red&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Red&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Blue&quot; &quot;Dun&quot;) {:n1 1, :n2 2, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Red&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Red&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmmm&hellip; something&rsquo;s not quite right.  Looking at the first result <code>[0 1 "Dun" Red"]</code>, it would result in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Zero</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">One</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Dun</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Red</span> <span class="nv">fish</span>
</span></code></pre></td></tr></table></div></figure>


<p>Although, it meets our criteria, it&rsquo;s missing one essential ingredient &ndash; rhyming!</p>

<p>Let&rsquo;s fix this by adding an extra predicate <code>number-rhymes-with-color?</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fish-number-rhymes-with-color?</span> <span class="p">[{</span><span class="nv">n</span> <span class="ss">:n2</span> <span class="nv">c</span> <span class="ss">:c2</span><span class="p">}]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">or</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">= </span><span class="p">[</span><span class="nv">n</span> <span class="nv">c</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">= </span><span class="p">[</span><span class="nv">n</span> <span class="nv">c</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="s">&quot;Dun&quot;</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll add this to our definition of <code>::first-line</code>, stating that the second number parameter should rhyme with the second color parameter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/and</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">)</span>
</span><span class='line'>                           <span class="nv">one-bigger?</span>
</span><span class='line'>                           <span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:c1</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c2</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>                           <span class="nv">fish-number-rhymes-with-color?</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Dun&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;;  {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;} fails spec:</span>
</span><span class='line'><span class="c1">;;  :one-fish.core/first-line predicate: fish-number-rhymes-with-color?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s try the data generation again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/exercise</span> <span class="ss">::first-line</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Red&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Red&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much better.  To finish things off, let&rsquo;s finally create a function to create a string for our mini-poem from our data.  While  we&rsquo;re at it, we can use our spec with <code>s/fdef</code>, to validate that the parameters are indeed in the form of <code>::first-line</code>.</p>

<h3>Using spec with functions</h3>

<p>Here&rsquo;s our function <code>fish-line</code> that takes in our values as a parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fish-line</span> <span class="p">[</span><span class="nv">n1</span> <span class="nv">n2</span> <span class="nv">c1</span> <span class="nv">c2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clojure.string/join</span> <span class="s">&quot; &quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">str </span><span class="nv">%</span> <span class="s">&quot; fish.&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">[(</span><span class="nb">get </span><span class="nv">fish-numbers</span> <span class="nv">n1</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">get </span><span class="nv">fish-numbers</span> <span class="nv">n2</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">c1</span>
</span><span class='line'>       <span class="nv">c2</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can specify that the args for this function be validated with <code>::first-line</code> and the return value is a string.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/fdef</span> <span class="nv">fish-line</span>
</span><span class='line'>        <span class="ss">:args</span> <span class="ss">::first-line</span>
</span><span class='line'>        <span class="ss">:ret</span>  <span class="nv">string?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we turn on the instrumentation of the validation for functions and see what happens. To enable this, we need to add the <code>spec.test</code> namespace to our requires:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">one-fish.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.spec</span> <span class="ss">:as</span> <span class="nv">s</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.spec.test</span> <span class="ss">:as</span> <span class="nv">stest</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The instrument function takes a fully-qualified symbol so add ` before the function name  to resolve it in the context of the current namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">stest/instrument</span> <span class="o">`</span><span class="nv">fish-line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fish-line</span> <span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;-&gt; &quot;One fish. Two fish. Red fish. Blue fish.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But what about with bad data?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fish-line</span> <span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">;; Call to #&#39;one-fish.core/fish-line did not conform to spec: val:</span>
</span><span class='line'> <span class="c1">;;   {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;} fails at: [:args] predicate:</span>
</span><span class='line'> <span class="c1">;;   one-bigger? :clojure.spec/args (2 1 &quot;Red&quot; &quot;Blue&quot;)</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">;;   {:clojure.spec/problems</span>
</span><span class='line'> <span class="c1">;;    {[:args]</span>
</span><span class='line'> <span class="c1">;;     {:pred one-bigger?,</span>
</span><span class='line'> <span class="c1">;;      :val {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;},</span>
</span><span class='line'> <span class="c1">;;      :via [],</span>
</span><span class='line'> <span class="c1">;;      :in []}},</span>
</span><span class='line'> <span class="c1">;;    :clojure.spec/args (2 1 &quot;Red&quot; &quot;Blue&quot;)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ah, yes &ndash; the first number must be one smaller than the second number.</p>

<h3>Wrap up</h3>

<p>I hope you&rsquo;ve enjoyed this brief tour of clojure.spec.  If you&rsquo;re interested in learning more, you should check out the <a href="http://clojure.org/guides/spec">spec.guide</a>.  It really is an exciting, new feature to Clojure.</p>

<p>In the meantime, I&rsquo;ll leave you with one of our generated lines, sure to be a big hit with future generations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Zero</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">One</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Red</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Dun</span> <span class="nv">fish</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ Kolmogorov-Uspensky Machine]]></title>
    <link href="http://gigasquid.github.io/blog/2016/03/16/kolmogorov-uspensky-machine/"/>
    <updated>2016-03-16T18:19:00-04:00</updated>
    <id>http://gigasquid.github.io/blog/2016/03/16/kolmogorov-uspensky-machine</id>
    <content type="html"><![CDATA[<p>It happened again.  I was sitting down reading a paper and I came across the phrase <em>Kolmogorov-Uspensky machine</em> and I had no idea what it was.  My initial reaction was just to move on.  It probably wasn&rsquo;t important, I told myself, just a detail that I could skim over.  I took a sip of my tea and continued on. The next paragraph it appeared <em>again</em>.  It was just sticking up like a thread waiting to be pulled. Still, I resisted.  After all, I wasn&rsquo;t even near my computer.  I would have to get up an walk into the other room.   After considering it for a moment, inertia won out and I continued my reading.  There it was <em>once more</em>.  This time right in the same paragraph, silently mocking me.  I knew I had to do something so I strode to my computer and pulled the thread.</p>

<h2>What is a Kolmogorov-Uspensky machine?</h2>

<p>The first thing I found is that the Kolmogorov-Uspensky machine, (also referred to as KUM), is very similar to the <a href="https://en.wikipedia.org/wiki/Turing_machine">Turing machine</a>.  In fact, it shares the same computational class of being Turing-complete.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Turing_machine_2b.svg/320px-Turing_machine_2b.svg.png"></p>

<p>The Turing machine operates on a tape divided into cells.  The head can move along the tape and read and write to it.  The tape is the storage for the machine.  Its movements are controlled by a collection of instructions which will be executed if certain prerequisites are met. The difference between the Turing machine  and a Kolmogorov-Uspensky machine is that the KUM has a tape that can change topology.  It&rsquo;s a graph.</p>

<p>The graph of a KUM machine is not just any graph.  It&rsquo;s a particular kind of graph.  It must have the property that if you start at a one vertex, all the other vertexes are uniquely addressable.  The graph also has a active node which, in turn, has a active neighborhood of other nodes associated with it.  This is not unlike the Turing machine&rsquo;s head that points to the current cell.  To figure out what do, the KUM machine looks at the graph to decide on what instruction to execute.  The instructions can consist of adding a node or edge to the active neighborhood, removing a node or edge from the active neighborhood, or halting.</p>

<p>After spending some time reading and researching, I felt like a had some idea of what a Kolmogorov-Uspensky machine was but it was still a bit fuzzy.  I wanted to really dig in and experience it by trying to implement one.  I found an esoteric programming language called <a href="https://esolangs.org/wiki/Eodermdrome">Eodermdrome</a> that fit the bill and set to work building it out in Clojure.</p>

<h2>Eodermdrome</h2>

<p>An Eodermdrome program creates graphs from a string of letters.  For example the graph of <em>abcdae</em> would produce</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/abcdae.png?raw=true"></p>

<p>The program itself consists of series of commands or rules.  The command will be executed if the following prereqs are met:</p>

<ul>
<li>The match graph in the command is a subgraph of the system graph.</li>
<li>If an input set is part of the command, the input character read of the system input must match it.</li>
</ul>


<p>A command is of the form:</p>

<ul>
<li><strong>match-graph graph-replacement</strong>

<ul>
<li>This will execute if the match-graph is a subgraph and then transform the match to the replacement.</li>
<li>Example:<code>a abc</code></li>
</ul>
</li>
<li><strong>(input-set) match-graph graph-replacement</strong>.

<ul>
<li>This will execute if the match is a subgraph and if the next character of the system input matches.  On executing, it will read one char from the input and then transform the match graph with the replacement.</li>
<li>Example: <code>(1) a abc</code></li>
</ul>
</li>
<li><strong>match-graph (output) graph-replacement.</strong>

<ul>
<li>This will execute if the match-graph is a subgraph. On executing, it will print the output to the system and transform the match with the replacement.</li>
<li>Example: <code>a (1) abc</code></li>
</ul>
</li>
<li><strong>(input-set) match-graph (output) graph-replacement.</strong>

<ul>
<li>This will execute if the match is a subgraph and if the next character of the system input matches.  On executing, it will read one char from the input, print the output to the system, and then transform the match graph with the replacement.</li>
<li>Example: <code>(0) a (1) abc</code></li>
</ul>
</li>
</ul>


<p>Comments are also allowed as text in between commas.  In this implementation, they must be contained on a single line.  Example: <code>,this is a comment,(1) a abc</code></p>

<p>The initial state of the graph with a program is the denoted by the graph string <em>thequickbrownfoxjumpsoverthelazydog</em>.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/thequickbrownfoxjumpsoverthelazydog.png?raw=true" title="" ></p>

<p>We now have all we need to walk through an example program in the Kolmogorov-Uspensky machine.</p>

<h3>An add program</h3>

<p>Let&rsquo;s take program for adding two string of ones together separated by zeros.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>,takes input of ones separated by zeros and adds the ones, thequickbrownfoxjumpsoverthelazydog a
</span><span class='line'>(1) a ab
</span><span class='line'>(0) a a
</span><span class='line'>ab (1) a</span></code></pre></td></tr></table></div></figure>


<p>Given a system input of &ldquo;101&rdquo;, it will print out &ldquo;11&rdquo;.  Let&rsquo;s walk through what happens in the program.</p>

<p><strong>Step 1</strong> &ndash; The program starts with our graph in the initial state of our beloved <em>thequickbrownfoxjumpsoverthelazydog</em> configuration.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-1.png?raw=true" title="" ></p>

<p><strong>Step 2</strong> &ndash; The first instruction matches <code>,takes input of ones separated by zeros and adds the ones, thequickbrownfoxjumpsoverthelazydog a</code> with he active subgraph being the whole graph. It is replaced by the single graph node <em>a</em>.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-2.png?raw=true"></p>

<p><strong>Step 3</strong> &ndash; The next instruction set <code>(1) a ab</code> <em>a</em> subgraph matches and takes a 1 off the input and transforms the graph to <em>ab</em>.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-3.png?raw=true"></p>

<p><strong>Step 4</strong> &ndash; The instruction set <code>(0) a a</code> also matches (since a is a subgraph of ab) and it takes a zero off the input and transforms back the <em>a</em> to <em>a</em> so the graph is still <em>ab</em>.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-4.png?raw=true"></p>

<p><strong>Step 5</strong> &ndash;  The instruction set <code>ab (1) a</code> now matches and a one prints out and the <em>ab</em> graph changes to <em>a</em>.</p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-5.png?raw=true"></p>

<p><strong>Step 6</strong> &ndash; Now, the <code>(1) a ab</code> instruction matches, it takes another 1 off the input (our last one) and transforms to <em>ab</em></p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-3.png?raw=true"></p>

<p><strong>Step 7</strong> &ndash; Finally, <code>ab (1) a</code> matches and it prints out a 1 and rewrites the graph to back to <em>a</em></p>

<p><img src="https://github.com/gigasquid/eodermdrome/blob/master/images/step-5.png?raw=true"></p>

<p>There are no more matching subgraphs without input required for instructions, so the program ends.</p>

<h2>Parting thoughts and threads</h2>

<p>The Kolmogorov-Uspensky machine is quite interesting. Not only is the idea of graph storage and rewriting appealing, it is also pretty powerful compared to Turing machines.  In fact, Dima Grigoriev proved that Turing machines cannot simulate Kolmogorov machines in real time.</p>

<p>It&rsquo;s been quite a fun and enriching jaunt.  The next time you see an unfamiliar term or concept, I encourage you to pull the thread. You never know where it will take you. It&rsquo;s a great way to enlarge your world.</p>

<p>If you are interested in the code and hacking for yourself, here is the repo  <a href="https://github.com/gigasquid/eodermdrome">https://github.com/gigasquid/eodermdrome</a>.</p>

<p>Other good resources on KUM:</p>

<ul>
<li><a href="http://research.microsoft.com/en-us/um/people/gurevich/opera/78.pdf">On Kolmogorov Machines And Related Issues</a></li>
<li><a href="https://books.google.com/books?id=SpTv44Ia-J0C&amp;pg=PA284&amp;lpg=PA284&amp;dq=active+node+kolmogorov+uspensky+machine&amp;source=bl&amp;ots=uQQSLaaKOS&amp;sig=9-V_m8z-Yh9zlzy6vX9MplGMbjw&amp;hl=en&amp;sa=X&amp;ved=0ahUKEwjy8820rMDLAhVByYMKHWP5A8oQ6AEILDAC#v=onepage&amp;q=active%20node%20kolmogorov%20uspensky%20machine&amp;f=false">Kolmogorov&rsquo;s Heritage in Mathematics</a></li>
<li><a href="http://dl.acm.org/citation.cfm?id=202846">What is a &ldquo;pointer machine&rdquo;</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fairy Tale Word Vectors]]></title>
    <link href="http://gigasquid.github.io/blog/2016/02/10/fairy-tale-word-vectors/"/>
    <updated>2016-02-10T21:27:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2016/02/10/fairy-tale-word-vectors</id>
    <content type="html"><![CDATA[<p><img src="http://c2.staticflickr.com/2/1558/24654386380_bda44419a8_n.jpg"></p>

<p>This post continues our exploration from the last blog post <a href="http://gigasquidsoftware.com/blog/2016/02/06/why-hyperdimensional-socks-never-match/">Why Hyperdimensional Socks Never Match</a>.  We are still working our way through <a href="http://redwood.berkeley.edu/pkanerva/papers/kanerva09-hyperdimensional.pdf">Kanerva&rsquo;s paper</a>.  This time, with the basics of hypervectors under our belts, we&rsquo;re ready to explore how words can be expressed as context vectors.  Once in a high dimensional form, you can compare two words to see how similar they are and even perform reasoning.</p>

<p>To kick off our word vector adventure, we need some words.  Preferring whimsy over the Google news, our text will be taken from ten freely available fairy tale books on <a href="http://www.gutenberg.org/">http://www.gutenberg.org/</a>.</p>

<h3>Gather ye nouns</h3>

<p>Our goal is to assemble a frequency matrix, with all the different nouns as the rows and the columns will be the counts of if the word appears or not in the document.  Our matrix will be binary with just 1s and 0s.  The <em>document</em> will be a sentence or fragment of words.  A small visualization is below.</p>

<table>
<thead>
<tr>
<th></th>
<th> Noun          </th>
<th align="center"> Doc1</th>
<th> Doc2</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> flower        </td>
<td align="center"> 1   </td>
<td>0</td>
</tr>
<tr>
<td></td>
<td> king          </td>
<td align="center"> 0   </td>
<td>1</td>
</tr>
<tr>
<td></td>
<td> fairy         </td>
<td align="center"> 1   </td>
<td>0</td>
</tr>
<tr>
<td></td>
<td> gold          </td>
<td align="center"> 1   </td>
<td>1</td>
</tr>
</tbody>
</table>


<p>The size of the matrix will be big enough to support hypervector behavior, but not so big as to make computation too annoyingly slow.  It will be nouns x 10,000.</p>

<p>The first task is to get a set of nouns to fill out the rows.  Although, there are numerous online sources for linguistic nouns, they unfortunately do not cover the same language spectrum as old fairy tale books.  So we are going to collect our own.  Using <a href="http://stanfordnlp.github.io/CoreNLP/">Stanford CoreNLP</a>, we can collect a set of nouns using Grimm&rsquo;s Book as a guide.  There are about 2500 nouns there to give us a nice sample to play with.  This makes our total matrix size ~ 2500 x 10,000.</p>

<p>Now that we have our nouns, let&rsquo;s get down to business.  We want to create an index to row to make a <code>noun-idx</code> and then create a sparse matrix for our word frequency matrix.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">hyperdimensional-playground.context-vectors</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.matrix</span> <span class="ss">:as</span> <span class="nv">m</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.core.matrix.linear</span> <span class="ss">:as</span> <span class="nv">ml</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.string</span> <span class="ss">:as</span> <span class="nv">string</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">hyperdimensional-playground.core</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">rand-hv</span> <span class="nv">cosine-sim</span> <span class="nv">mean-add</span> <span class="nv">inverse</span> <span class="nv">xor-mul</span><span class="p">]]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">hyperdimensional-playground.fairytale-nouns</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">fairy-tales-nouns</span> <span class="nv">book-list</span><span class="p">]]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">m/set-current-implementation</span> <span class="ss">:vectorz</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; size of the hypervectors and freq matrix columns</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">sz</span> <span class="mi">10000</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; The nouns come from a sampling of Grimm&#39;s fairy tale nouns these will</span>
</span><span class='line'><span class="c1">;; make up the rows in the frequency matrix</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">noun-idx</span> <span class="p">(</span><span class="nb">zipmap </span><span class="nv">fairy-tales-nouns</span> <span class="p">(</span><span class="nf">range</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">freq-matrix</span> <span class="p">(</span><span class="nf">m/new-sparse-array</span> <span class="p">[(</span><span class="nb">count </span><span class="nv">fairy-tales-nouns</span><span class="p">)</span> <span class="nv">sz</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next thing we need to do is to have some functions to take a book, read it in, split it into documents and then update the frequency matrix.</p>

<h3>Random indexing for the win</h3>

<p>The interesting thing about the update method is that we can use <em>random indexing</em>.  We don&rsquo;t need to worry about having a column for each document.  Because of the nature of hyperdimensions, we can randomly assign 10 columns for each document.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">update-doc!</span>
</span><span class='line'>  <span class="s">&quot;Given a document - upate the frequency matrix using random indexing&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">doc</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">known-nouns</span> <span class="p">(</span><span class="nf">clojure.set/intersection</span> <span class="nv">fairy-tales-nouns</span> <span class="p">(</span><span class="nb">set </span><span class="nv">doc</span><span class="p">))]</span>
</span><span class='line'>    <span class="c1">; use positive random indexing</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nf">repeatedly</span> <span class="mi">10</span> <span class="o">#</span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">noun</span> <span class="nv">known-nouns</span><span class="p">]</span>
</span><span class='line'>                       <span class="p">(</span><span class="nf">m/mset!</span> <span class="nv">freq-matrix</span> <span class="p">(</span><span class="nb">get </span><span class="nv">noun-idx</span> <span class="nv">noun</span><span class="p">)</span> <span class="p">(</span><span class="nb">rand-int </span><span class="nv">sz</span><span class="p">)</span> <span class="mi">1</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The whole book is processed by slurping in the contents and using a regex to split it up into docs to update the matrix.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">process-book</span>
</span><span class='line'>  <span class="s">&quot;Load a book and break it into sentence like documents and update the frequency matrix&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">book-str</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">book-text</span> <span class="p">(</span><span class="nb">slurp </span><span class="nv">book-str</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">docs</span> <span class="p">(</span><span class="nf">partition</span> <span class="mi">25</span> <span class="p">(</span><span class="nb">map </span><span class="nv">string/lower-case</span>
</span><span class='line'>                                <span class="p">(</span><span class="nf">string/split</span> <span class="nv">book-text</span> <span class="o">#</span><span class="s">&quot;\s|\.|\,|\;|\!|\?&quot;</span><span class="p">)))</span>
</span><span class='line'>        <span class="nv">doc-count</span> <span class="p">(</span><span class="nb">count </span><span class="nv">docs</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;processing:&quot;</span> <span class="nv">book-str</span> <span class="s">&quot;(with&quot;</span> <span class="nv">doc-count</span> <span class="s">&quot;docs)&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nf">map-indexed</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">idx</span> <span class="nv">doc</span><span class="p">]</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">zero? </span><span class="p">(</span><span class="nf">mod</span> <span class="nv">idx</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">(</span><span class="nb">println </span><span class="s">&quot;doc:&quot;</span> <span class="nv">idx</span><span class="p">))</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">update-doc!</span> <span class="nv">doc</span><span class="p">))</span>
</span><span class='line'>                        <span class="nv">docs</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;DONE with &quot;</span> <span class="nv">book-str</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now run the whole processing with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">book</span> <span class="nv">book-list</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">process-book</span> <span class="nv">book</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>On my system, it only takes about 3 seconds.</p>

<p>Great!  Now we have hypervectors associated with word frequencies.  They are now <em>context word vectors</em>.  What can we do with them.</p>

<h3>How close is a king to a goat?</h3>

<p>One of the things that we can do with them is find out a measure of how closely related the context of two words are by a measure of their cosine similarity.  First, we need a handy function to turn a string word into a word vector by getting it out of our frequency matrix.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">wv</span> <span class="p">[</span><span class="nv">word</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Get a hypervector for the word from the frequency matrix&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">get </span><span class="nv">noun-idx</span> <span class="nv">word</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assert </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">i</span><span class="p">))</span> <span class="p">(</span><span class="nb">str </span><span class="nv">word</span> <span class="s">&quot; not found&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">m/slice</span> <span class="nv">freq-matrix</span> <span class="nv">i</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can make another nice function to compare two words and give a informational map back.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">compare-wvs</span>
</span><span class='line'>  <span class="s">&quot;Compare two words and give the cosine distance info map&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">word1</span> <span class="nv">word2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">wv1</span> <span class="p">(</span><span class="nf">wv</span> <span class="nv">word1</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">wv2</span> <span class="p">(</span><span class="nf">wv</span> <span class="nv">word2</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">not= </span><span class="nv">word1</span> <span class="nv">word2</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:word1</span> <span class="nv">word1</span>
</span><span class='line'>       <span class="ss">:word2</span> <span class="nv">word2</span>
</span><span class='line'>       <span class="ss">:cosine</span> <span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">wv1</span> <span class="nv">wv2</span><span class="p">)})))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a look at the similarities of some words to <em>king</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:cosine</span><span class="p">[(</span><span class="nf">compare-wvs</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;queen&quot;</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">compare-wvs</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;prince&quot;</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">compare-wvs</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;princess&quot;</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">compare-wvs</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;guard&quot;</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">(</span><span class="nf">compare-wvs</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;goat&quot;</span><span class="p">)])</span>
</span><span class='line'>  <span class="c1">;; ({:word1 &quot;king&quot;, :word2 &quot;goat&quot;, :cosine 0.1509151478896664}</span>
</span><span class='line'>  <span class="c1">;;  {:word1 &quot;king&quot;, :word2 &quot;guard&quot;, :cosine 0.16098893367403827}</span>
</span><span class='line'>  <span class="c1">;;  {:word1 &quot;king&quot;, :word2 &quot;queen&quot;, :cosine 0.49470535530616655}</span>
</span><span class='line'>  <span class="c1">;;  {:word1 &quot;king&quot;, :word2 &quot;prince&quot;, :cosine 0.5832521795716931}</span>
</span><span class='line'>  <span class="c1">;;  {:word1 &quot;king&quot;, :word2 &quot;princess&quot;, :cosine 0.5836922474743367})</span>
</span></code></pre></td></tr></table></div></figure>


<p>As expected, the royal family is closer to the king then a guard or goat is.</p>

<p>One of the interesting things is that now we can do addition and subtraction with these word vectors and see how it affects the relation with other words.</p>

<h3>Boy + Gold = King, Boy + Giant = Jack</h3>

<p>We can take a look at how close <em>boy</em> and <em>king</em> are together by themselves.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;boy&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;king&quot;</span><span class="p">))</span> <span class="c1">;=&gt; 0.42996397142253145</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can add some gold to the boy and that new word vector will be closer to king than boy was alone.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;boy&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gold&quot;</span><span class="p">))</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;king&quot;</span><span class="p">))</span> <span class="c1">;=&gt; 0.5876251031366048</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing the same for <em>boy</em> and <em>jack</em>, we find that adding a giant moves the context closer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;boy&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">))</span> <span class="c1">;=&gt; 0.33102858702785953</span>
</span><span class='line'><span class="c1">;; boy + giant = jack</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;giant&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;boy&quot;</span><span class="p">))</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">))</span> <span class="c1">;=&gt;0.4491473187787431</span>
</span></code></pre></td></tr></table></div></figure>


<p>Amusingly, a frog and a princess make a prince.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;; frog + princess = prince</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">wv-add</span> <span class="s">&quot;frog&quot;</span> <span class="s">&quot;princess&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;prince&quot;</span><span class="p">))</span> <span class="c1">;=&gt; 0.5231641991974249</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can take this even farther by subtracting words and adding others.  For example a similarity to the word queen can be obtained by subtracting man from king and adding woman.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;; queen= (king-man) + woman</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;queen&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;woman&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv-subtract</span> <span class="s">&quot;king&quot;</span> <span class="s">&quot;man&quot;</span><span class="p">)))</span> <span class="c1">;=&gt;0.5659832204544486</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similarly, a contextual closeness to father can be gotten from subtracting woman from mother and adding man.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;father&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;man&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv-subtract</span> <span class="s">&quot;mother&quot;</span> <span class="s">&quot;woman&quot;</span><span class="p">)))</span> <span class="c1">;=&gt;0.5959841177719538</span>
</span></code></pre></td></tr></table></div></figure>


<p>But wait, that&rsquo;s not all.  We can also do express facts with these word vectors and <em>reason</em> about them.</p>

<h3>Reasoning with word vector with the database as a hyperdimensional value</h3>

<p>The curious nature of hypervectors allows the storage of multiple entity, attributes in it and allow the retrieval of the likeness of them later by simple linear math &ndash; using only xor multiplication and addition.  This gives us the <em>database as a value</em> in the form of a high dimensional vector.</p>

<p>For an example, say we want to express the fact that Hansel is a brother of Gretel.  We can do this by adding the xor product of brother with hansel and the product of brother with Gretel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; hansel is the brother of gretel</span>
</span><span class='line'><span class="c1">;; B*H + B*G</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">hansel-brother-of-gretel</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">mean-add</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;hansel&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also we can express that Jack is a brother of Hansel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">jack-brother-of-hansel</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">mean-add</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">))</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;hansel&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can add these two facts together to make a new hypervector value.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">facts</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="nv">hansel-brother-of-gretel</span>
</span><span class='line'>                       <span class="nv">jack-brother-of-hansel</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can actually <em>reason</em> about them and ask questions.  Is Jack a brother of Hansel?  With a high cosine similarity, we can assume the answer is likely.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="c1">;; is jack the brother of hansel?</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt;0.8095270629815969</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about someone unrelated.  Is Cinderella the brother of Gretel? &ndash; No</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="c1">;; is cinderella the brother of gretel ?</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;cinderella&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt;0.1451799916656951</span>
</span></code></pre></td></tr></table></div></figure>


<p>Is Jack the brother of Gretel &ndash; Yes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="c1">;; is jack the brother of gretel ?</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt; 0.8095270629815969</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can take this further by adding more facts and inventing a relation of our own.</p>

<h3>Siblings in Hyperspace</h3>

<p>Let&rsquo;s invent a new word vector that is not in our nouns &ndash; <em>siblings</em>.  We are going to create new random hypervector to represent it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">siblings</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will define it in terms of word vectors that we already have.  That is, siblings will be a the sum of brother + sister.  We XOR multiply it by siblings to associate it with the hypervector.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">siblings-brother-sister</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">siblings</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;brother&quot;</span><span class="p">))</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">siblings</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;sister&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can add some more facts.  Gretel is a sister of Hansel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="c1">;; gretel is the sister of hansel</span>
</span><span class='line'>  <span class="c1">;; S*G + S*H</span>
</span><span class='line'>  <span class="p">(</span><span class="k">def </span><span class="nv">gretel-sister-of-hansel</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">mean-add</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;sister&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;sister&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;hansel&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Gretel is also a sister of Jack.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="c1">;; gretel is the sister of jack</span>
</span><span class='line'>  <span class="c1">; S*G + S*H</span>
</span><span class='line'>  <span class="p">(</span><span class="k">def </span><span class="nv">gretel-sister-of-jack</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">mean-add</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;sister&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">xor-mul</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;sister&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Collecting all of our facts into one hypervector (as a database).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">(</span><span class="k">def </span><span class="nv">facts</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="nv">hansel-brother-of-gretel</span>
</span><span class='line'>                       <span class="nv">jack-brother-of-hansel</span>
</span><span class='line'>                       <span class="nv">gretel-sister-of-jack</span>
</span><span class='line'>                       <span class="nv">gretel-sister-of-hansel</span>
</span><span class='line'>                       <span class="nv">siblings-brother-sister</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can ask some for questions.</p>

<p>Are Hansel and Gretel siblings? &ndash; Yes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; are hansel and gretel siblings?</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;hansel&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;gretel&quot;</span><span class="p">))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">siblings</span> <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt;0.627015379034067</span>
</span></code></pre></td></tr></table></div></figure>


<p>Are John and Roland siblings &ndash; No</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; are john and roland siblings?</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;roland&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;john&quot;</span><span class="p">))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">siblings</span> <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt; 0.1984017637065277</span>
</span></code></pre></td></tr></table></div></figure>


<p>Are Jack and Hansel siblings? &ndash; Yes</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">(</span><span class="nf">cosine-sim</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;jack&quot;</span><span class="p">)</span> <span class="p">(</span><span class="nf">wv</span> <span class="s">&quot;hansel&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">siblings</span> <span class="nv">facts</span><span class="p">))</span> <span class="c1">;=&gt;0.48003572523507465</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is interesting to think of that nothing is stopping us at this point from <em>retracting</em> facts by simply subtracting the fact encoded word vectors from our &ldquo;database&rdquo; value and making a new value from it.</p>

<h3>Conclusions</h3>

<p>In this fun, but casual exploration of word vector we have seen the potential for reasoning about language in a way that uses nothing more complicated than addition and multiplication.  The ability to store dense information in hypervectors, extract it with simple methods, and flexibly collect it randomly, shows its versatility and power.  Hyperdimensional vectors  might hold the key to unlocking a deeper understanding of cognitive computing or perhaps even true artificial intelligence.</p>

<p>It is interesting to note that this technique is not limited to words. Other applications can be done the same way.  For example a video recommendation using a hypervector with movie titles.  Or perhaps even anomaly detection using sensor readings over a regular weekly time period.</p>

<p>Looking over our journey with word vectors.  At the beginning it seemed that word vectors were magical.  Now, after an understanding of the basics, it still seems like magic.</p>

<p>If you are interested in exploring further, feel free to use my github <a href="https://github.com/gigasquid/hyperdimensional-playground">hyperdimensional-playground</a> as a starting point.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why Hyperdimensional Socks Never Match]]></title>
    <link href="http://gigasquid.github.io/blog/2016/02/06/why-hyperdimensional-socks-never-match/"/>
    <updated>2016-02-06T14:26:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2016/02/06/why-hyperdimensional-socks-never-match</id>
    <content type="html"><![CDATA[<p><img src="http://c2.staticflickr.com/8/7238/7188420611_a99f936971_n.jpg"></p>

<p>The nature of computing in hyperdimensions is a strange and wonderful place.   I have only started to scratch the surface by reading a paper by <a href="http://redwood.berkeley.edu/pkanerva/papers/kanerva09-hyperdimensional.pdf">Kanerva</a>. Not only is it interesting from a computer science standpoint, it&rsquo;s also interesting from a cognitive science point of view.  In fact, it could hold the key to better model AI and general reasoning.  This blog is a casual stroll through some of the main points of Kanerva&rsquo;s paper along with examples in Clojure to make it tangible.  First things first, what is a hyperdimension?</p>

<h3>What is a Hyperdimension and Where Are My Socks?</h3>

<p>When we are talking about hyperdimensions, we are really talking about <em>lots</em> of dimensions.  A vector has dimensions.  A regular vector could have three dimensions <code>[0 1 1]</code>, but a hyperdimensional vector has tons more, like 10,000 or 100,000.  We call these big vectors <em>hypervectors</em> for short, which makes them sound really cool. Although the vectors could be made up of anything, we are going to use vectors made up of zeros and ones.  To handle big computing with big vectors in a reasonable amount of time, we are also going to use <em>sparse</em> vectors.  What makes them sparse is that most of the space is empty, (zeros).  In fact, Clojure has a nice library to handle these sparse vectors.  The <a href="https://github.com/mikera/core.matrix">core.matrix</a> project from Mike Anderson is what we will use in our examples.  Let&rsquo;s go ahead and make some random hypervectors.</p>

<p>First we import the core.matrix libraries and set the implementation to vectorz which provides fast double precision vector math.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">hyperdimensional-playground.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.matrix</span> <span class="ss">:as</span> <span class="nv">m</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.core.matrix.linear</span> <span class="ss">:as</span> <span class="nv">ml</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">m/set-current-implementation</span> <span class="ss">:vectorz</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we set the sz of our hypervectors to be 100,000.  We also create a function to generate a random sparse hypervector by choosing to put ones in about 10% of the space.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">sz</span> <span class="mi">100000</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">rand-hv</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hv</span> <span class="p">(</span><span class="nf">m/new-sparse-array</span> <span class="p">[</span><span class="nv">sz</span><span class="p">])</span>
</span><span class='line'>        <span class="nv">n</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.1</span> <span class="nv">sz</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="nv">n</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">m/mset!</span> <span class="nv">hv</span> <span class="p">(</span><span class="nb">rand-int </span><span class="nv">sz</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">hv</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can generate some.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">a</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">b</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">c</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">d</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">a</span> <span class="c1">;=&gt; #vectorz/vector Large vector with shape: [100000]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can think of each of this hypervectors as random hyperdimensional sock, or hypersock, because that sounds cooler.  These hypersocks, have curious properties.  One of which is that they will ~never match.</p>

<h3>Hypersocks never match</h3>

<p>Because we are dealing with huge amount of dimensions, a mathematically peculiar probability distribution occurs.  We can take a random hypervector to represent something, then take another one and they will different from each by about 100 STD. We can take another one and it too, will be 100 STD from the other ones.  For practical purposes, we will run out of time before we will run of vectors that are unrelated.  Because of this, any two hypersocks will never match each other.</p>

<p>How can we tell how similar two hypersocks are?  The cosine to tell the similarity between two vectors.  This is determined by the dot product.  We can construct a <a href="https://en.wikipedia.org/wiki/Cosine_similarity">cosine similarity</a> function to give us a value from -1 to 1 to measure how alike they are with 1 being the same and -1 being the complete opposite.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">cosine-sim</span> <span class="p">[</span><span class="nv">v1</span> <span class="nv">v2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">m/dot</span> <span class="nv">v1</span> <span class="nv">v2</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">ml/norm</span> <span class="nv">v1</span><span class="p">)</span> <span class="p">(</span><span class="nf">ml/norm</span> <span class="nv">v2</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we look at the similarity of a hypervector with itself, the result is ~1.  With the other random hypervectors, it is ~0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">a</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt;  1.0</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">d</span> <span class="nv">d</span><span class="p">)</span> <span class="c1">;=&gt; 1.0</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="c1">;=&gt;  0.0859992468320239</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">)</span> <span class="c1">;=&gt; 0.09329186588790261</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">a</span> <span class="nv">c</span><span class="p">)</span> <span class="c1">;=&gt; 0.08782018973001954</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are other cool things we can do with hypervectors, like do math with them.</p>

<h3>The Hamming Distance of Two Hypersocks</h3>

<p>We can add hypervectors together with a sum mean vector. We add the vector of 1s and 0s together then we divide the resulting vector by the number of total vectors.  Finally, to get back to our 1s and 0s, we round the result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">mean-add</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">hvs</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">m/emap</span> <span class="o">#</span><span class="p">(</span><span class="nf">Math/round</span> <span class="p">(</span><span class="nb">double </span><span class="nv">%</span><span class="p">))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">m/div</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">m/add</span> <span class="nv">hvs</span><span class="p">)</span> <span class="p">(</span><span class="nb">count </span><span class="nv">hvs</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interesting thing about addition is that the result is similar to all the vectors in it.  For example, if we add a and b together to make x, <code>x = a + b</code>, then x will be similar to a and similar to b.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; x = a + b</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">x</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt; 0.7234734658023224</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">x</span> <span class="nv">b</span><span class="p">)</span> <span class="c1">;=&gt; 0.7252586504505658</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also do a very simple form of multiplication on vectors with 1s and 0s with using <em>XOR</em>.  We can do this by add the two vectors together and then mapping <code>mod 2</code> on each of the elements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">xor-mul</span> <span class="p">[</span><span class="nv">v1</span> <span class="nv">v2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">m/add</span> <span class="nv">v1</span> <span class="nv">v2</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">m/emap</span> <span class="o">#</span><span class="p">(</span><span class="nf">mod</span> <span class="nv">%</span> <span class="mi">2</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can actually use this <code>xor-mul</code> to calculate the <a href="https://en.wikipedia.org/wiki/Hamming_distance">Hamming distance</a>, which is an important measure of error detection.  The Hamming distance is simply the sum of all of the xor multiplied elements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">hamming-dist</span> <span class="p">[</span><span class="nv">v1</span> <span class="nv">v2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">m/esum</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">v1</span> <span class="nv">v2</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">])</span> <span class="c1">;=&gt; 0</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">])</span> <span class="c1">;=&gt; 2</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">a</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt; 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>This illustrates a point that xor multiplication randomizes the hypervector, but preserves the distance.  In the following example, we xor multiply two random hypervectors by another and the hamming distance stays the same.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">; xa = x * a</span>
</span><span class='line'><span class="c1">; ya = y * a</span>
</span><span class='line'><span class="c1">; hamming distance of xa is the same as ya</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">;; multiplication randomizes but preserves the distance</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">xa</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">a</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">ya</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">y</span> <span class="nv">a</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">xa</span> <span class="nv">ya</span><span class="p">)</span> <span class="c1">;=&gt; 1740.0</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="c1">;=&gt; 1740.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>So you can xor multiply your two hypersocks and move them to a different point in hyperspace, but they will still be the same distance apart.</p>

<p>Another great party trick in hyperspace, is the ability to bind and unbind hypervectors for use as map like pairs.</p>

<h3>Using Hypervectors to Represent Maps</h3>

<p>A map of pairs is a very important data structure.  It gives the ability to bind symbols to values and then retrieve those values.  We can do this with hypervectors too.  Consider the following structure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Gigasquid&quot;</span>
</span><span class='line'> <span class="ss">:cute-animal</span> <span class="s">&quot;duck&quot;</span>
</span><span class='line'> <span class="ss">:favorite-sock</span> <span class="s">&quot;red plaid&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now create hypervectors to represent each of these values.  Then we can xor the hypervector symbol to the hypervector value and sum them up.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; data records with bound pairs</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">x</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; favorite-sock</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">y</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; cute-animal</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">z</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; name</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">a</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; red-plaid</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">b</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; duck</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">c</span> <span class="p">(</span><span class="nf">rand-hv</span><span class="p">))</span> <span class="c1">;; gigasquid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;H = X * A + Y * B + Z * C</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">h</span> <span class="p">(</span><span class="nf">mean-add</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">y</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">z</span> <span class="nv">c</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we have a sum of all these things and we want to find the value of the <em>favorite sock</em>.  We can <em>unbind</em> it from the sum by xor multiplying the favorite-sock hypervector <code>x</code>.  Because of the property that xor multiplication both distributes and cancels itself out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">a</span><span class="p">))</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt; 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can compare the result with the known values and find the closest match.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">a</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 1462.0  ;; closest to &quot;red-plaid&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">b</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 1721.0</span>
</span><span class='line'><span class="p">(</span><span class="nf">hamming-dist</span> <span class="nv">c</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 1736.0</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">a</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 0.3195059768353112 ;; closest to &quot;red-plaid&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">b</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 0.1989075567830733</span>
</span><span class='line'><span class="p">(</span><span class="nf">cosine-sim</span> <span class="nv">c</span> <span class="p">(</span><span class="nf">xor-mul</span> <span class="nv">x</span> <span class="nv">h</span><span class="p">))</span> <span class="c1">;=&gt; 0.18705233578983288</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Conclusion</h3>

<p>We have seen that the nature of higher dimensional representation leads to some very interesting properties with both representing data and computing with it.  These properties and others form the foundation of exciting advancements in Cognitive Computing like word vectors.  Future posts will delve further into these interesting areas.  In the meantime, I encourage you to read Kanerva&rsquo;s paper on your own and to find comfort in that when you can&rsquo;t find one of your socks, it&rsquo;s not your fault. It most likely has something to do with the curious nature of hyperspace.</p>

<p><em>Thanks to <a href="https://twitter.com/ross_gayler">Ross Gayler</a> for bringing the paper to my attention and to <a href="https://twitter.com/solussd">Joe Smith</a> for the great conversations on SDM</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Book of Software Miracles]]></title>
    <link href="http://gigasquid.github.io/blog/2016/01/16/book-of-software-miracles/"/>
    <updated>2016-01-16T22:09:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2016/01/16/book-of-software-miracles</id>
    <content type="html"><![CDATA[<p><img src="http://c2.staticflickr.com/2/1611/23811303563_029d4c864e_c.jpg" title="&#34;Book of Software Miracles - Cover&#34;" alt="&#34;Book of Software Miracles - Cover&#34;"></p>

<p>This 21st century illustrated manuscript was recently uncovered.  It depicts miraculous phenomena in software engineering and represents one of the most spectacular new discoveries in the field of Renaissance Computer Science.</p>

<p>Some examples of the glorious illustrations and text translations are presented here.</p>

<p><img src="http://c2.staticflickr.com/2/1520/24070311299_c23fc388e0_z.jpg" title="&#34;Book of Software Miracles Fol. 26&#34;" alt="&#34;Book of Software Miracles Fol. 26&#34;"></p>

<p><em>On the day in 1958 that John McCarthy invented LISP, three suns appeared in the East in the morning sky which moved towards each other so that they merged into one.</em></p>

<p><img src="http://c2.staticflickr.com/2/1448/24355655351_f449746e80_z.jpg" title="&#34;Book of Software Miracles Fol. 72&#34;" alt="&#34;Book of Software Miracles Fol. 72&#34;"></p>

<p><em>In the year 1952, countless software bugs appeared in the land after being coined by Grace Hopper during the invention of the COBOL language.</em></p>

<p><img src="http://c2.staticflickr.com/2/1644/23809895144_dac1fdcc2c_z.jpg" title="&#34;Book of Software Miracles Fol. 83&#34;" alt="&#34;Book of Software Miracles Fol. 83&#34;"></p>

<p><em>In the year of 2007, a great and wonderful comet appeared in the sky.  This was followed by the invention of the Clojure language by Rich Hickey.</em></p>

<p><img src="http://c2.staticflickr.com/2/1704/24070310299_c9b80e4033_z.jpg" title="&#34;Book of Software Miracles Fol. 91&#34;" alt="&#34;Book of Software Miracles Fol. 91&#34;"></p>

<p><em>A month after the NPM Node repository burst its banks in the year of 2015, a wondrous creature appeared from the JavaScript ecosystem.  Found dead after the raging subsided, was in this shape and form and is painted here.</em></p>

<p>For more information about this remarkable book visit <a href="http://www.taschen.com/pages/en/catalogue/classics/all/03107/facts.the_book_of_miracles.htm">Book of Software Miracles</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Can a Programming Language Make You Smarter?]]></title>
    <link href="http://gigasquid.github.io/blog/2015/12/20/can-a-programming-language-make-you-smarter/"/>
    <updated>2015-12-20T11:16:00-05:00</updated>
    <id>http://gigasquid.github.io/blog/2015/12/20/can-a-programming-language-make-you-smarter</id>
    <content type="html"><![CDATA[<p><img src="http://c1.staticflickr.com/1/34/118425909_86f332f075_z.jpg?zz=1"></p>

<p>All programming languages are not created equal.  Some clearly excel at solving different problems.  There are languages that are great for scalability and others that are great for proving correctness.  But what about one that that will make you smarter?  To look for this answer, I am going to turn to a different language, our human language, and research from the field of linguistics and cognitive development.</p>

<h3>A new language is born</h3>

<p>Up until the late 1970s, there was no school for the deaf In Nicaragua.  Being deaf before then meant only developing crude signs with your family and friends.  Beyond that there was nothing.  Finally, the wife of the dictator set up a special school for them.  This was the first time that the children were brought together in one place rather than being scattered about.  For most of them, it was the first time that they had ever met another deaf person.  There were about fifty kids in that first class and they came together with fifty different ways of communication with crude gestures.  But after awhile, something amazing happened. They started to converge into a common system &ndash; a language was born. For scientists, this was an incredible opportunity to watch a new language develop.  One of the fascinating insights had to do with how the this sign language evolved over the generations of children entering the school.  One in particular, was a study about how words in a language can actually increase your cognitive capacity and make people <em>smarter</em>.</p>

<p>The study involved a test that was performed on different generations of students from the school, including the very first students who were now grown and younger children.  A comic strip shown to the participants. In it there are two brothers.  The big brother is playing with the train and the little brother wants the play with it.  The big brother puts it under the bed and goes out to the kitchen to get a sandwich.  While the big brother is gone, the little brother takes out the train and hides it in the toy box.  The question for the test subjects is, &ldquo;When the big brother comes back, where is he going to look for the train?&rdquo;</p>

<h3>Thinking about thinking</h3>

<p>For most kids over the age of five, the answer will be that the big brother will look under the bed because he doesn&rsquo;t know that it has been moved to the toy box.  The interesting thing was that the first generation of kids that went through the school, now thirty five years old, failed this simple test.  The younger ones all passed.  What was going on?</p>

<p>To find out, the scientists looked a differences in the language over the generations and found that the older signers lacked words for the concept of thinking.  The earlier generation just had one word for <em>think</em>, while the later generations had evolved ten or twelve.  Words that expressed concepts like <em>understand</em> and <em>believe</em>.  It seems that having words gave them access to a concept that otherwise would have been really hard to think about.  It increased their cognitive capacity.  It enabled them to <em>think about thinking</em>.</p>

<h3>Thinking about programming programs</h3>

<p>Programming languages allow us to translate our human thoughts and instructions to machines.  We have words to express simple concepts like adding two numbers together with <code>+</code> or finding how many elements are in a list with <code>count</code>, but what about harder concepts that are more difficult to access?  Is there an analogy to having words to <em>think about thinking</em> that some programming languages have that others don&rsquo;t?  I believe there is.  It&rsquo;s having a way to think about a <em>program programming itself</em> with self modifying code or <em>macros</em>.</p>

<p>In Clojure, macros are way to do <em>meta-programming</em>.  This involves ability to treat the program as data, allowing a program to modify another program &ndash; even its own.  It gives Clojure the capability to implement language features, make code more concise, and encapsulate patterns and repetitive code.  It is a powerful feature and more to the point of our current line of inquiry, it is a pretty friggin difficult concept to grok.  In fact, before I was exposed to a language that had macros in it, I doubt that I would have been able to think about it.  For the sake of argument, let&rsquo;s go back to the comic strip story with the two brothers.  But this time, the train is a function and the little brother uses a macro on it when the big brother gets a snack in the kitchen.  What does the big brother expect the result of the program to be when he gets back in the room.  Prior to my exposure to Clojure and macros, I am sure I would have failed the test.</p>

<h3>Conclusion</h3>

<p>So yes, I do think that a programming language can increase your cognitive capacity and make you smarter.  I certainly feel that my exposure had expanded my world and given me access to programming concepts that I did not have with my other programming experience.  I also feel certain that there are other languages out there, both existing and yet to be invented, that have words to express concepts that am not even aware of.  Languages that are just waiting for me to expand my horizons.</p>

<p>And that certainty makes me incredibly happy and grateful to be a programmer.</p>

<p><em>Listen to whole fascinating story of Ann Senghas studying sign language that born in Nicaragua on <a href="http://www.radiolab.org/story/91730-new-words-new-world/">Radiolab</a></em></p>
]]></content>
  </entry>
  
</feed>
