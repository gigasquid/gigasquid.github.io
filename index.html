
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Squid's Blog</title>
    <meta name="author" content="Carin Meier">
    
	<meta name="description" content="Published on: Jun 3rd, 2018 Tags: All, Clojure, Deep Learning This is the beginning of a series of blog posts to get to know the Apache MXNet Deep &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Squid's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated">
    <div id="headerbg">
        Squid's Blog
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  
  
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/about/index.html">About</a></li>
	<li id="ajax"><a href="/speaking/index.html">Speaking</a></li>
	<li id="ajax"><a href="/books/index.html">Books</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2018/06/03/meet-clojure-mxnet-ndarray/">
		
			Meet Clojure MXNet - NDArray</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2018-06-03T16:13:00-04:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2018</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure</a>, <a class='category' href='/blog/categories/deep-learning/'>Deep Learning</a>


</div>
    </div>
		<p><img src="https://cdn-images-1.medium.com/max/800/1*OoqsrMD7JzXAvRUGx_8_fg.jpeg"></p>

<p>This is the beginning of a series of blog posts to get to know the <a href="https://mxnet.apache.org/">Apache MXNet</a> Deep Learning project and the new Clojure library <a href="https://github.com/gigasquid/clojure-mxnet">clojure-mxnet</a>.</p>

<p>MXNet is a first class, modern deep learning library that AWS has officially picked as its chosen library. It supports multiple languages on a first class basis and is incubating as an Apache project.</p>

<p>The motivation for creating a Clojure package is to be able to open the deep learning library to the Clojure ecosystem and build bridges for future development and innovation for the community. It provides all the needed tools including low level and high level apis, dynamic graphs, and things like GAN and natural language support.</p>

<p>So let&rsquo;s get on with our introduction with one of the basic building blocks of MXNet, the <code>NDArray</code>.</p>

<h2>Meet NDArray</h2>

<p>The <code>NDArray</code> is the tensor data structure in MXNet. Let&rsquo;s start of by creating one. First we need to require the <code>ndarray</code> namespace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">tutorial.ndarray</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">org.apache.clojure-mxnet.ndarray</span> <span class="ss">:as</span> <span class="nv">ndarray</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s create an all zero array of dimension 100 x 50</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">50</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.apache.mxnet.NDArray 0x3e396d0 &quot;org.apache.mxnet.NDArray@aeea40b6&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can check the shape of this by using <code>shape-vec</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">50</span><span class="p">]))</span>
</span><span class='line'><span class="c1">;=&gt; [100 50]</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is also a quick way to create an ndarray of ones with the <code>ones</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">256</span> <span class="mi">32</span> <span class="mi">128</span> <span class="mi">1</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ones and zeros are nice, but what an array with specific contents? There is an <code>array</code> function for that. Specific the contents of the array first and the shape second:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">c</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">3</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="nv">c</span><span class="p">)</span>  <span class="c1">;=&gt; [2 3]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To convert it back to a vector format, we can use the <code>-&gt;vec</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">c</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; [1.0 2.0 3.0 4.0 5.0 6.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we know how to create NDArrays, we can get to do something interesting like operations on them.</p>

<h3>Operations</h3>

<p>There are all the standard arithmetic operations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">a</span> <span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">5</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">b</span> <span class="p">(</span><span class="nf">ndarray/ones</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">5</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">ndarray/+</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nf">ndarray/-&gt;vec</span><span class="p">))</span>
</span><span class='line'><span class="c1">;=&gt;  [2.0 2.0 2.0 2.0 2.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the original ndarrays are unchanged.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt; [1.0 1.0 1.0 1.0 1.0]</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">b</span><span class="p">)</span> <span class="c1">;=&gt; [1.0 1.0 1.0 1.0 1.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, we can change that if we use the inplace operators:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/+=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">a</span><span class="p">)</span> <span class="c1">;=&gt;  [2.0 2.0 2.0 2.0 2.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many more operations, but just to give you a taste, we&rsquo;ll take a look a the <code>dot</code> product operation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">arr1</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">arr2</span> <span class="p">(</span><span class="nf">ndarray/array</span> <span class="p">[</span><span class="mi">3</span> <span class="mi">4</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">res</span> <span class="p">(</span><span class="nf">ndarray/dot</span> <span class="nv">arr1</span> <span class="nv">arr2</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/shape-vec</span> <span class="nv">res</span><span class="p">)</span> <span class="c1">;=&gt; [1 1]</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/-&gt;vec</span> <span class="nv">res</span><span class="p">)</span> <span class="c1">;=&gt; [11.0]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are curious about the other operators available in NDArray API check out the <a href="https://mxnet.incubator.apache.org/api/python/ndarray/ndarray.html">MXNet project documentation page</a></p>

<p>Now that we have ndarrays and can do calculations on them, we might want to save and load them.</p>

<h3>Saving and Loading</h3>

<p>You can save ndarrays with a name as a map like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/save</span> <span class="s">&quot;filename&quot;</span> <span class="p">{</span><span class="s">&quot;arr1&quot;</span> <span class="nv">arr1</span> <span class="s">&quot;arr2&quot;</span> <span class="nv">arr2</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>To load them, you just specify the filename and the map is returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">ndarray/load</span> <span class="s">&quot;filename&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; {&quot;arr1&quot; #object[org.apache.mxnet.NDArray 0x1b629ff4 &quot;org.apache.mxnet.NDArray@63da08cb&quot;]</span>
</span><span class='line'><span class="c1">;=&gt;  &quot;arr2&quot; #object[org.apache.mxnet.NDArray 0x25d994e3 &quot;org.apache.mxnet.NDArray@5bbaf2c3&quot;]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One more cool thing, we can even due our operations on the cpu or gpu.</p>

<h3>Multi-Device Support</h3>

<p>When creating an <code>ndarray</code> you can use a context argument to specify the device. To do this, we will need the help of the <code>context</code> namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">org.apache.clojure-mxnet.context</span> <span class="ss">:as</span> <span class="nv">context</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default, the <code>ndarray</code> is created on the cpu context.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cpu-a</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">200</span><span class="p">]))</span>
</span><span class='line'><span class="p">(</span><span class="nf">ndarray/context</span> <span class="nv">cpu-a</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; #object[ml.dmlc.mxnet.Context 0x3f376123 &quot;cpu(0)&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we can specify the gpu instead, (if we have a gpu enabled build).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">gpu-b</span> <span class="p">(</span><span class="nf">ndarray/zeros</span> <span class="p">[</span><span class="mi">100</span> <span class="mi">200</span><span class="p">]</span> <span class="p">{</span><span class="ss">:ctx</span> <span class="p">(</span><span class="nf">context/gpu</span> <span class="mi">0</span><span class="p">)}))</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note: Operations among different contexts are currently not allowed, but there is a <code>copy-to</code> function that can help copy the content from one device to another and then continue on with the computation.</em></p>

<h2>Wrap up</h2>

<p>I hope you&rsquo;ve enjoyed the brief introduction to the MXNet library, there is much more to explore in future posts. If you are interested in giving it a try, there are native jars for OSX cpu and Linux cpu/gpu available and the code for the ndarray tutorial can be found <a href="https://github.com/gigasquid/clojure-mxnet/blob/master/examples/tutorial/src/tutorial/ndarray.clj">here</a>.</p>

<p><em>Please remember that he library is in a very <strong>alpha</strong> state, so if you encounter any problems or have any other feedback, please log an issue so bugs and rough edges can be fixed :).</em></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2018/06/03/meet-clojure-mxnet-ndarray//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2018/03/04/on-staying-technical/">
		
			On Staying Technical</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2018-03-04T11:03:00-05:00" pubdate data-updated="true">Mar 4<span>th</span>, 2018</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>all</a>


</div>
    </div>
		<p>I was 10 years into my career when I met her. I could count the number of other women programmers I had worked with on one hand and none of them had young children at home like me. She was not only incredibly experienced and competent, but also had a son in college. I was curious about her career path so I asked her one day at lunch why she was still programming and hadn’t become a manager instead.</p>

<p>She smiled at me kindly and replied, &ldquo;I’ve worked very hard to stay exactly where I am&rdquo;,  and I was enlightened.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2018/03/04/on-staying-technical//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2017/11/07/cats-and-dogs-with-cortex-redux/">
		
			Cats and Dogs With Cortex Redux</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2017-11-07T18:51:00-05:00" pubdate data-updated="true">Nov 7<span>th</span>, 2017</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ai/'>AI</a>, <a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure</a>, <a class='category' href='/blog/categories/machine-learning/'>Machine Learning</a>


</div>
    </div>
		<p>I wrote a <a href="http://gigasquidsoftware.com/blog/2016/12/27/deep-learning-in-clojure-with-cortex/">blog post</a> a while back about using a Clojure machine learning library called <a href="https://github.com/thinktopic/cortex">Cortex</a> to do the Kaggle Cats and Dogs classification challenge.</p>

<p>I wanted to revisit it for a few reasons. The first one is that the Cortex library has progressed and improved considerably over the last year. It&rsquo;s still not at version 1.0, but it my eyes, it&rsquo;s really starting to shine. The second reason is that they recently published an <a href="https://github.com/thinktopic/cortex/tree/master/examples/resnet-retrain">example</a> of using the RESNET50 model, (I&rsquo;ll explain later on), to do fine-tuning or transfer learning. The third reason, is that there is a great new plugin for leiningen the supports using <a href="https://github.com/didiercrunch/lein-jupyter">Jupyter notebooks with Clojure projects</a>. These notebooks are a great way of doing walkthroughs and tutorials.</p>

<p>Putting all these things together, I felt like I was finally at a stage where I could somewhat replicate the first lesson in the <a href="https://github.com/fastai/courses/blob/master/deeplearning1/nbs/dogs_cats_redux.ipynb">Practical Deep Learning Course for Coders</a> with Cats and Dogs &ndash; although this time all in Clojure!</p>

<h2>Where to Start?</h2>

<p><img src="http://kaggle2.blob.core.windows.net/competitions/kaggle/3362/media/woof_meow.jpg"></p>

<p>In the last blog post, we created our deep learning network and trained the data on scaled down images (like 50x50) from scratch. This time we are much smarter.</p>

<p>We are still of course going to have to get a hold of all the training data from <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data">Kaggle Cats vs Dogs Challenge</a>. The big difference is this time, we are just going to have to train our model for <em>1 epoch</em>. What&rsquo;s more, the results will be way better than before.</p>

<p>How is this possible? We are going to use an already trained model, RESNET50. This model has already been painstakingly trained with a gigantic network that is 50 layers deep on the ImageNet challenge. That&rsquo;s a challenge that has models try to classify a 1000 different categories. The theory is that the inner layers of the network have already learned about the features that make up cats and dogs, all we would need to do is peel off the final layer of the network and graft on a new layers that just learns the final classification for our 2 categories of cats and dogs. This is called <em>transfer learning</em> or <em>retraining</em>.</p>

<h2>Plan of Action</h2>

<ul>
<li>Get all the cats and dogs pictures in the right directory format for training</li>
<li>Train the model with all but the last layer in the RESNET model. The last layer we are going to replace with our own layer that will finetune it to classify only cats and dogs</li>
<li>Run the test data and come up with a spreadsheet of results to submit to Kaggle.</li>
</ul>


<h3>Getting all the data pictures in the right format</h3>

<p>This is the generally the most time consuming step of most deep learning. I&rsquo;ll spare you the gritty details but we want to get all the pictures from the <code>train.zip</code> into the format</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-data
</span><span class='line'>  -cats-dogs-training
</span><span class='line'>      -cat
</span><span class='line'>          1110.png
</span><span class='line'>          ...
</span><span class='line'>      -dog
</span><span class='line'>          12416.png
</span><span class='line'>          ...
</span><span class='line'>  -cats-dogs-testing
</span><span class='line'>      -cat
</span><span class='line'>          11.png
</span><span class='line'>          ...
</span><span class='line'>      -dog
</span><span class='line'>          12.png
</span><span class='line'>          ...</span></code></pre></td></tr></table></div></figure>


<p>The image sizes must also all be resized to match the input of the RESNET50. That means they all have to be 224x224.</p>

<h3>Train the model</h3>

<p>The cortex functions allow you to load the resnet50 model, remove the last layer, freeze all the other layers so that they will not be retrained, and add new layers.</p>

<p>I was surprised that I could actually train the model with all the images at 224x244 with the huge RESNET50 model. I built the uberjar and ran it which helped the performance.</p>

<p><code>lein uberjar</code></p>

<p><code>java -jar target/cats-dogs-cortex-redux.jar</code></p>

<p>Training one epoch took me approximately 6 minutes. Not bad, especially considering that&rsquo;s all the training I really needed to do.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Loss for epoch 1: (current) 0.05875186542016347 (best) null
</span><span class='line'>Saving network to trained-network.nippy</span></code></pre></td></tr></table></div></figure>


<p>The key point is that it saved the fine tuned network to trained-network.nippy</p>

<h3>Run the Kaggle test results and submit the results</h3>

<p>You will need to do a bit more setup for this. First, you need to get the Kaggle test images for classification. There are 12500 of these in the test.zip file from the site. Under the data directory, create a new directory called kaggle-test. Now unzip the contents of test.zip inside that folder. The full directory with all the test images should now be:</p>

<p><code>data/kaggle-test/test</code></p>

<p>This step takes a long time and you might have to tweak the batch size again depending on your memory. There are 12500 predications to be made. The main logic for this is in function called <code>(kaggle-results batch-size)</code>. It will take a long time to run. It will print the results as it goes along to the kaggle-results.csv file. If you want to check progress you can do wc -l kaggle-results.csv</p>

<p>For me locally, with <code>(cats-dogs/kaggle-results 100)</code> it took me 28 minutes locally.</p>

<h3>Compare the results</h3>

<p><img src="http://c1.staticflickr.com/5/4518/26477015609_1af781b8da_b.jpg"></p>

<p>My one epoch of fine tuning beat my best results of going through the Practical Deep Learning exercise with the fine tuning the VGG16 model. Not bad at all.</p>

<h2>Summary</h2>

<p>For those of you that are interested in checking out the code, it&rsquo;s out there on <a href="https://github.com/gigasquid/cats-dogs-cortex-redux">github</a></p>

<p>Even more exciting, there is a <a href="https://github.com/gigasquid/cats-dogs-cortex-redux/blob/master/Cats%20and%20Dogs%20in%20Cortex%20(Redux).ipynb">walkthrough in a jupyter notebook</a> with a lein-jupyter plugin.</p>

<p>The Deep Learning world in Clojure is an exciting place to be and gaining tools and traction more and more.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2017/11/07/cats-and-dogs-with-cortex-redux//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2017/10/22/embedded-interop-between-clojure-r-and-python-with-graalvm/">
		
			Embedded Interop Between Clojure, R, and Python With GraalVM</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2017-10-22T16:02:00-04:00" pubdate data-updated="true">Oct 22<span>nd</span>, 2017</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure,</a>


</div>
    </div>
		<p><img src="https://images-na.ssl-images-amazon.com/images/M/MV5BOTViY2Y0ZGItMTg2OC00YzEzLWJhYjYtZjg4OTMyOWE4YzM1XkEyXkFqcGdeQXVyNTQ1NzU4Njk@._V1_.jpg" title="" ></p>

<p>In my talk at <a href="https://www.youtube.com/watch?v=eLl6_k_fZn4">Clojure Conj</a> I mentioned how a project from Oracle Labs named GraalVM might have to potential for Clojure to interop with Python on the same VM. At the time of the talk, I had just learned about it so I didn&rsquo;t have time to take a look at it. Over the last week, I&rsquo;ve managed to take it for a test drive and I wanted to share what I found.</p>

<h3>Are you ready?</h3>

<p>In this example, we will be using an ordinary Leinengen project and using the REPL we will interop with both R and python.</p>

<p>But first will need a bit of setup.</p>

<p>We will download the <a href="http://www.oracle.com/technetwork/oracle-labs/program-languages/downloads/index.html">Graal project</a> so we can use its <code>java</code> instead of our own.</p>

<p>Once we have it downloaded we will configure our PATH to use Graal&rsquo;s java instead of our own.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># export PATH=/path/to/graalAndTruffle/bin:$PATH</span></code></pre></td></tr></table></div></figure>


<p>Now, we can create a new lein project and run <code>lein repl</code> and begin the fun.</p>

<h3>The Polyglot Context</h3>

<p>In our new namespace, we just need to import the <a href="http://graalvm.github.io/graal/truffle/javadoc/org/graalvm/polyglot/Context.html">Polyglot Context</a> to get started:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">graal-test.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">org.graalvm.polyglot</span> <span class="nv">Context</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; note that is also supports Ruby, LLVM, and JS</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">context</span> <span class="p">(</span><span class="nf">Context/create</span> <span class="p">(</span><span class="nb">into-array </span><span class="p">[</span><span class="s">&quot;python&quot;</span> <span class="s">&quot;R&quot;</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we are ready to actually try to run some R and Python code right in our REPL. Let&rsquo;s start first with R.</p>

<h3>Interoping with R</h3>

<p>The main function we are going to use is the <code>eval</code> function in the context. Let&rsquo;s start small with some basic math.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">3^2 + 2^2</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x7ff40e4d &quot;13.0&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow! It actually did something. It returned something called a <a href="https://github.com/graalvm/graal/blob/master/sdk/src/org.graalvm.polyglot/src/org/graalvm/polyglot/Value.java">Polyglot Value</a> with what looks like the right answer in it.</p>

<p>Emboldened by our early success, let&rsquo;s try something a little more complicated like calling a function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">result1</span> <span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">sum.of.squares &lt;- function(x,y) {</span>
</span><span class='line'><span class="s">  x^2 + y^2</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">sum.of.squares(3,4)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0xc3edd92 &quot;25.0&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, it looks like it worked. Let&rsquo;s try to get the result back into Clojure as a value we can work with. We could ask the result what sort of type it is with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.isNumber</span> <span class="nv">result1</span><span class="p">)</span> <span class="c1">;=&gt; true </span>
</span></code></pre></td></tr></table></div></figure>


<p>but let&rsquo;s just use <code>clojure.edn</code> to read the string and save some time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-&gt;clojure</span> <span class="p">[</span><span class="nv">polyglot-value</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">polyglot-value</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.toString</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">clojure.edn/read-string</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">-&gt;clojure</span> <span class="nv">result1</span><span class="p">)</span> <span class="c1">;=&gt; 25</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would be nice to have a easier way to export symbols and import symbols to and from the guest and host language. In fact, Graal provides a way to do this but to do this in Clojure, we would need something else called <a href="https://github.com/graalvm/graal/tree/master/truffle">Truffle</a>.</p>

<p>Truffle is part of the Graal project and is a framework for implementing languages with the Graal compliler.
There are quite a few languages implemented with the Truffle framework. R is one of them.</p>

<p><img src="https://image.slidesharecdn.com/polyglotonthejvmwithgraalenglish-170521104613/95/polyglot-on-the-jvm-with-graal-english-14-638.jpg?cb=1495364615"></p>

<p>My understanding is that if Clojure was implemented as a truffle lang, then interop could be much more seamless like this example in Ruby</p>

<p><img src="https://image.slidesharecdn.com/polyglotonthejvmwithgraalenglish-170521104613/95/polyglot-on-the-jvm-with-graal-english-37-638.jpg?cb=1495364615"></p>

<p>But let&rsquo;s continue in our exploration. What about doing something more interesting, like importing a useful R library and using it. How about the <a href="https://www.rdocumentation.org/packages/numDeriv/versions/2016.8-1">numDeriv</a> package that supports Accurate Numerical Derivatives?</p>

<p>First we import the package using cran.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">install.packages(\&quot;numDeriv\&quot;, repos = \&quot;http://cran.case.edu/\&quot;)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are doing this at your REPL, you can will see lots of text going on in your <code>lein repl</code> process at this point. It&rsquo;s going out and figuring out what deps you need and installing them in your <code>/graalvm-0.28.2/jre/languages/R</code> directory structure.</p>

<p>After it is done, we can actually use it!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">result2</span> <span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;R&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">library(numDeriv)</span>
</span><span class='line'><span class="s">grad(sin, (0:10)*2*pi/10)</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="nv">result2</span> <span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x76765898 &quot;c(1,</span>
</span><span class='line'>        <span class="c1">;0.809016994367249, 0.309016994372158, -0.309016994373567,</span>
</span><span class='line'>        <span class="c1">;-0.809016994368844, -0.999999999993381, -0.809016994370298,</span>
</span><span class='line'>        <span class="c1">;-0.309016994373312, 0.309016994372042, 0.809016994369185,</span>
</span><span class='line'>        <span class="c1">;0.999999999993381)&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This has a bit more interesting result as an array. But the Context has ways of dealing with it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.hasArrayElements</span> <span class="nv">result2</span><span class="p">)</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">.getArraySize</span> <span class="nv">result2</span><span class="p">)</span> <span class="c1">;=&gt; 11</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="mi">10</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">.getArrayElement</span> <span class="nv">result2</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nf">-&gt;clojure</span><span class="p">)))</span>
</span><span class='line'><span class="c1">;=&gt; (1.0 0.8090169943672489 0.3090169943721585 -0.3090169943735675</span>
</span><span class='line'><span class="c1">;-0.8090169943688436 -0.9999999999933814</span>
</span><span class='line'><span class="c1">; -0.8090169943702977 -0.3090169943733122 0.30901699437204233</span>
</span><span class='line'><span class="c1">; 0.8090169943691851)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, we&rsquo;ve showed basic interop with R &ndash; which is pretty neat. What about Python?</p>

<h3>Interoping with Python</h3>

<p>Truffle is scheduled to fully support Python in 2018, but there is already an early alpha version in the Graal download that we can play with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">.eval</span> <span class="nv">context</span> <span class="s">&quot;python&quot;</span> <span class="s">&quot;</span>
</span><span class='line'><span class="s">import time;</span>
</span><span class='line'><span class="s">time.clock()</span>
</span><span class='line'><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'> <span class="c1">;=&gt; #object[org.graalvm.polyglot.Value 0x4a6b3b70 &quot;1.508202803249E9&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Neat!</p>

<p>It is still a long way for <code>import numpy</code> or <code>import tensorflow</code> but cPython compatibility is the goal. Although the c-extensions are the really tricky part.</p>

<p>So keep an eye on Graal and Truffle for the future and wish the Oracle Labs team the best on their mission to make the JVM Polyglot.</p>

<h3>Footnotes</h3>

<p>If you are interested in playing with the code. I have a github repo here <a href="https://github.com/gigasquid/graal-test">graal-test</a>. If you are interested in watching a video, I really liked <a href="https://www.youtube.com/watch?v=TQMKPRc6cbE">this one</a>. There are also some really nice examples of running in polyglot mode with R and Java and JS here <a href="https://github.com/graalvm/examples">https://github.com/graalvm/examples</a>.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2017/10/22/embedded-interop-between-clojure-r-and-python-with-graalvm//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2017/05/27/self-publishing-for-the-creative-coder/">
		
			Self Publishing for the Creative Coder</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2017-05-27T14:11:00-04:00" pubdate data-updated="true">May 27<span>th</span>, 2017</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>all</a>, <a class='category' href='/blog/categories/self-publising/'>self-publising</a>


</div>
    </div>
		<p>So, you have an idea for a fiction book. First, let me tell you that it&rsquo;s a good idea and it&rsquo;s a great thing that you are a coder. Quite a few successful authors have a background in software development. <a href="http://www.imdb.com/title/tt2543164/">Arrival</a>, (which is a fabulous movie), comes from the book, <a href="https://www.amazon.com/Stories-Your-Life-Others-Chiang/dp/1101972122">Stories of your Life</a>,  written by a fellow programmer <a href="https://en.wikipedia.org/wiki/Ted_Chiang">Ted Chiang</a>. <a href="https://en.wikipedia.org/wiki/Charles_Stross">Charlie Stross</a> is another fine example. One of my favorites is <a href="https://en.wikipedia.org/wiki/Daniel_Suarez_(author">Daniel Suarez</a>, the author of the<a href="https://www.amazon.com/DAEMON-Daniel-Suarez/dp/0451228731"> Daemon</a> and more recently <a href="https://www.amazon.com/Change-Agent-Novel-Daniel-Suarez/dp/110198466X/">Change Agent</a>. So yes, you can write a fiction book and you&rsquo;re in good company. This post is dedicated to help make it happen.</p>

<h2>So how do you know about self publishing?</h2>

<p>Two years ago, I had a semi-crazy idea for a tween/teen scifi book. At the time, my daughter was into all the popular books of time like <em>Hunger Games</em> and <em>Divergent</em>. The thing that I really liked about them was the strong female protagonist. The only thing that I thought was missing was a story that focused on a girl who could code. It would make it even better if she had <em>coding super powers</em>. The idea for <a href="http://www.codeshifterbook.com/">Code Shifter</a> was born. One of the things that I wanted to explore in writing the book was to have real programming code in the book but not have it be a <em>learning how to code</em> book. The code would exist as part of the story and if the reader picked up concepts along the way, great. Even if they didn&rsquo;t, it would lay the positive groundwork to have them be more open to it later.</p>

<p>Books, like software, always take longer than you plan. My daughter and I enjoyed working on it together and over time it grew into a book that we could share with others. Along the way, I learned quite a bit about writing books, publishing, and other things that I wish I had known beforehand.</p>

<h2>What did you use to write the book?</h2>

<p>In the book world, your story is referred to as your <em>manuscript</em>. As a tool to produce it, I cannot speak highly enough of <a href="https://leanpub.com/">Leanpub</a>. I found it easy and productive to work in as a programmer. For example,  my setup was pretty painless.</p>

<p>In the repo, I had a <code>manuscript</code> directory, in which there was a <code>Book.txt</code> file that listed the chapter files.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chapter2.txt
</span><span class='line'>chapter3.txt
</span><span class='line'>chapter4.txt
</span><span class='line'>chapter5.txt</span></code></pre></td></tr></table></div></figure>


<p>Each chapter file in turn was written in markdown. For example, <code>chapter2.txt</code> looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 1
</span><span class='line'>
</span><span class='line'>## Flicker
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Twelve-year-old Eliza knew that the next words were the result of computer program far more intelligent than any one of them. Standing next to her parents, she held her breath and watched as her brother touched his finger to the message on the wall screen.</span></code></pre></td></tr></table></div></figure>


<p>From there, my process looked like:</p>

<ul>
<li>Write a bit in my favorite editor, (Emacs of course), and make a commit.</li>
<li>Push the commit to github, which is registered with the Leanpub project</li>
<li>Log onto the Leanpub project and hit the <em>preview</em> button. This would generate a pdf and ebook that I could share with my daughter for feedback.</li>
</ul>


<p><img src="http://c1.staticflickr.com/5/4274/34768029762_3bbae300f0.jpg"></p>

<h3>Advantages of Leanpub for development.</h3>

<p>As I said earlier, I&rsquo;m a fan. Using git for revisions is incredibly useful. I shudder to think of people writing in Word without version control. The ability to easily create PDF and ebook formats was also very convenient. The markdown format has excellent code support. There is also the option as publishing your work as you go. However, I think that this is more useful with a technical book than with fiction.</p>

<h3>Disadvantages of Leanpub for development</h3>

<p>If you are going to work with an freelance editor or share your work with someone in the mainstream book world, they are not going to want pdf. They usually want a doc version. It took me a bit of research to find a good converter, <a href="http://pandoc.org/">pandoc</a>. With it, you can convert from markdown to Word with things looking pretty good. Don&rsquo;t try to do pdf to Word. I found it a big recipe for fail.</p>

<p>Finally, the book was considered done enough to think about publishing.</p>

<p>There was much rejoicing.</p>

<h2>Didn&rsquo;t you want to get the book into bookstores?</h2>

<p>Of course. That would be incredibly cool. However, that requires getting into what they call <em>traditional publishing</em> and it is a lot more work, time, and luck. If you go this route, you will need to budget at least six months to send out form letters to agencies to have them represent your work. Also, beware of predatory services that take advantage of unsuspecting and wide eyed authors. If you are interested in this, you&rsquo;ll want to start looking for agents that are interested in your type of book. <a href="https://querytracker.net/">Query Tracker</a> is a great place to start.</p>

<h2>Traditional publishing sounds hard. What about self publishing?</h2>

<p>Self publishing is certainly an easier more direct way to bring your book to life. For me, it was the best way forward. Luckily, Leanpub made it pretty painless.</p>

<h3>Publishing the book with Leanpub</h3>

<p>Actually publishing the finished copy was really easy with Leanpub. All I had to do was fill in some fields on the project page and push <em>Publish!</em> The book was immediately ready to share with the world. Putting out an updated edition was as easy as pushing the button again. Leanpub provides online reading as well as all the ebook versions.</p>

<p>That was nice, but I really wanted a print copy too.</p>

<h3>Publishing with CreateSpace</h3>

<p>Amazon&rsquo;s <a href="https://www.createspace.com/">CreateSpace</a> provides and excellent platform for on-demand print copies of books. This is where Leanpub comes in handy again. There is an <code>Export Option</code> that provides and unbranded pdf copy of your manuscript with all the correct formatting and margins required for CreateSpace. I simply exported the file and then uploaded it up to the project.</p>

<p><img src="http://c1.staticflickr.com/5/4203/34121511063_b63d283086_b.jpg"></p>

<p>The other thing that you will want is a nice cover. There are services through CreateSpace for cover creation that you can buy or you can upload your own file. I was lucky enough to have a talented graphic designer as sister, Kristin Allmyer,  who made me an awesome cover.</p>

<p>One of the confusing things was picking an ISBN for the print copy. You don&rsquo;t need to worry about this for ebook versions but you do for a physical copy. Your choices through CreateSpace are using a provided one for free or buying your own for $99. I chose my own so I could have flexibility of working with another publisher other than Amazon if I want. If you choose that option, you can also make up your own publisher name. Mine is <em>Gigasquid Books</em>.</p>

<p><img src="http://c1.staticflickr.com/5/4244/34121511083_15027c4571.jpg"></p>

<p>Once you have completed all the setup, they will send you a physical copy in the mail to approve. The moment you get to hold it in your hands is really magical.</p>

<p><img src="https://pbs.twimg.com/media/C8xBM-nXYAAOmK0.jpg:large"></p>

<p>If it looks alright, you hit the approve button and voilà &ndash; it&rsquo;s for sale on Amazon!</p>

<h3>Publishing with Direct Kindle Publishing</h3>

<p>With CreateSpace, you have the option of porting your book to a Kindle format as well. It will do most of the heavy lifting of converting the files for you and a few button clicks later you have both an Kindle and print version available for your readers.</p>

<p>If you need to update the text of the Kindle version, Leanpub also has an export option available to produce unbranded ebook files. Just take this and upload it to your KDP account and you are good to go.</p>

<h2>Did you run into any problems?</h2>

<p>Of course I did. I was totally new to self publishing and I underestimated how hard copy editing is. Some errors unfortunately made it into the first version. Luckily, I had some really nice people that helped my fix it for later versions. Many thanks to Martin Plumb, Michael Daines, Paul Henrich, and S. Le Callonnec for editing help.</p>

<p>This brings me to my next point. If I had to do it all over again, I would publish the book in a different order. Books are really no different than software. There are going to be bugs when you first release it in the wild. It is best to embrace this. In the future, I would publish the ebook versions first, which are much easier to update and then the print versions after that.</p>

<h2>Did you make lots of money from the book sales?</h2>

<p>Hahaha &hellip;  that&rsquo;s funny. If you are interested in making money, books are not the best way to go. The margins on Leanpub are definitely better than Amazon, but if I really was interested in making money, I would have been much better off using deep learning to make a stock market predictor or code up a startup that I could sell off.</p>

<p>Authors in general, are much harder pressed to make livings than software developers. We should count our blessings.</p>

<h2>Any last words of advice?</h2>

<p>There is a great joy from creating a story and sharing it with others. Take your book idea, nurture it, and bring it to life. Then publish it and we can celebrate together.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2017/05/27/self-publishing-for-the-creative-coder//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/12/27/deep-learning-in-clojure-with-cortex/">
		
			Deep Learning in Clojure With Cortex</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2016-12-27T10:44:00-05:00" pubdate data-updated="true">Dec 27<span>th</span>, 2016</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ai/'>AI</a>, <a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure</a>, <a class='category' href='/blog/categories/machine-learning/'>Machine Learning</a>


</div>
    </div>
		<p><strong>Update: Cortex has moved along since I first wrote this blog post, so if you are looking to run the examples, please go and clone the <a href="https://github.com/thinktopic/cortex">Cortex</a> repo and look for the cats and dogs code in the examples directory.</strong></p>

<p>There is an awesome new <em>Clojure-first</em> machine learning library called <a href="https://github.com/thinktopic/cortex">Cortex</a> that was open sourced recently. I&rsquo;ve been exploring it lately and wanted to share my discoveries so far in this post. In our exploration, we are going to tackle one of the classic classification problems of the internet. How do you tell the difference between a cat and dog pic?</p>

<h2>Where to Start?</h2>

<p><img src="http://kaggle2.blob.core.windows.net/competitions/kaggle/3362/media/woof_meow.jpg"></p>

<p>For any machine learning problem, we&rsquo;re going to need data. For this, we can use Kaggle&rsquo;s data for the <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data">Cats vs Dogs Challenge</a>.  The training data consists of 25,000 images of cats and dogs. That should be more than enough to train our computer to recognize cats from doggies.</p>

<p>We also need some idea of how to train against the data. Luckily, the Cortex project has a very nice set of examples to help you get started. In particular there is a <a href="https://github.com/thinktopic/cortex/tree/master/examples/suite-classification">suite classification example</a> using MNIST, (hand written digit), corpus. This example contains a number cutting edge features that we&rsquo;ll want to use:</p>

<ul>
<li>Uses GPU for <em>fast</em> computation.</li>
<li>Uses a deep, multi-layered, convolutional layered network for feature recognition.</li>
<li>Has &ldquo;forever&rdquo; training by image augmentation.</li>
<li>Saves the network configuration as it trains to an external nippy file so that it can be imported later.</li>
<li>Has a really nice ClojureScript front end to visualize the training progress with a confusion matrix.</li>
<li>Has a way to import the saved nippy network configuration and perform inference on it to classify a new image.</li>
</ul>


<p>Basically, it has everything we need to hit the ground running.</p>

<h2>Data Wrangling</h2>

<p>To use the example&rsquo;s <em>forever</em> training, we need to get the data in the right form. We need all the images to be the same size as well as in a directory structure that is split up into the training and test images. Furthermore, we want all the dog images to be under a &ldquo;dog&rdquo; directory and the cat images under the &ldquo;cat&rdquo; directory so that the all the indexed images under them have the correct &ldquo;label&rdquo;.  It will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- training
</span><span class='line'>  - cat
</span><span class='line'>    - 1.png
</span><span class='line'>    - 2.png
</span><span class='line'>  - dog
</span><span class='line'>    - 1.png
</span><span class='line'>    - 2.png</span></code></pre></td></tr></table></div></figure>


<p>For this task, we are going to use a couple image libraries to help us out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">[</span><span class="nv">mikera.image.core</span> <span class="ss">:as</span> <span class="nv">imagez</span><span class="p">]</span>
</span><span class='line'> <span class="p">[</span><span class="nv">think.image.image</span> <span class="ss">:as</span> <span class="nv">image</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can resize and rewrite the original images into the form we want. For a image size, we&rsquo;re going to go with 52x52. The choice is arbitrary in that I wanted it bigger than the MNIST dataset which is 28x28 so it will be easier to see, but not so big that it kills my CPU. This is even more important since we want to use RGB colors which is 3 channels as opposed to the MNIST grey scale of 1.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-image-size</span> <span class="mi">52</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-num-classes</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-num-channels</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">dataset-datatype</span> <span class="ss">:float</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">resize-and-write-data</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">output-dir</span> <span class="p">[</span><span class="nv">idx</span> <span class="p">[</span><span class="nv">file</span> <span class="nv">label</span><span class="p">]]]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">img-path</span> <span class="p">(</span><span class="nb">str </span><span class="nv">output-dir</span> <span class="s">&quot;/&quot;</span> <span class="nv">label</span> <span class="s">&quot;/&quot;</span> <span class="nv">idx</span> <span class="s">&quot;.png&quot;</span> <span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when-not </span><span class="p">(</span><span class="nf">.exists</span> <span class="p">(</span><span class="nf">io/file</span> <span class="nv">img-path</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">io/make-parents</span> <span class="nv">img-path</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">imagez/load-image</span> <span class="nv">file</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">image/resize</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">imagez/save</span> <span class="nv">img-path</span><span class="p">)))</span>
</span><span class='line'>    <span class="nv">nil</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>As far as the split between training images and testing images, we are going the go for an simple even split between testing and training data.</p>

<h2>Network Configuration</h2>

<p>The Network layer configuration is the meat of the whole thing. We are going to go with the exact same network description as the MNIST example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-basic-network-description</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">[(</span><span class="nf">desc/input</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-image-size</span> <span class="nv">dataset-num-channels</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">5</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/max-pooling</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">5</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/max-pooling</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/convolutional</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/relu</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/linear-&gt;relu</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/dropout</span> <span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">desc/linear-&gt;softmax</span> <span class="nv">dataset-num-classes</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>It uses a series of convolutional layers with max pooling for feature recognition. We&rsquo;ll see if it works for color versions of cats and dogs as well as street numbers.</p>

<p>We&rsquo;ll also keep the image augmentation the same as in the example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">max-image-rotation-degrees</span> <span class="mi">25</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">img-aug-pipeline</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">img</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">img</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">image-aug/rotate</span> <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">* </span><span class="mi">2</span> <span class="nv">max-image-rotation-degrees</span><span class="p">))</span>
</span><span class='line'>                           <span class="nv">max-image-rotation-degrees</span><span class="p">)</span>
</span><span class='line'>                        <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">image-aug/inject-noise</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.25</span> <span class="p">(</span><span class="nf">rand</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*num-augmented-images-per-file*</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It injects one augmented image into our training data by slightly rotating it and adding noise.</p>

<h3>Running it!</h3>

<p>It&rsquo;s time to test it out. Using <code>lein run</code>, we&rsquo;ll launch the <code>train-forever</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">train-forever</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">dataset</span> <span class="p">(</span><span class="nf">create-dataset</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">initial-description</span> <span class="p">(</span><span class="nf">create-basic-network-description</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">confusion-matrix-atom</span> <span class="p">(</span><span class="nf">display-dataset-and-model</span> <span class="nv">dataset</span> <span class="nv">initial-description</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">classification/train-forever</span> <span class="nv">dataset</span> <span class="nv">observation-&gt;image</span>
</span><span class='line'>                                  <span class="nv">initial-description</span>
</span><span class='line'>                                  <span class="ss">:confusion-matrix-atom</span> <span class="nv">confusion-matrix-atom</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This opens a port to a localhost webpage where we can view the progress <code>http://localhost:8091/</code></p>

<p><img src="http://c3.staticflickr.com/1/599/31877481106_ab49402b71_b.jpg"></p>

<p>Below the confusion matrix is shown. This tracks the progress of the training in the classification. In particular, how many times it thought a cat was really a cat and how many times it got it wrong.</p>

<p><img src="http://c7.staticflickr.com/1/371/31541533750_69d80cc7fa.jpg"></p>

<p>As we are training the data, the loss for each epoch is shown on the console as well as when it saves the network to the external file.</p>

<p>After only thirty minutes of training on my Mac Book Pro, we get to some pretty good results, with the correct percentage in the 99s :</p>

<p><img src="http://c1.staticflickr.com/1/707/31541538600_8e61134375.jpg"></p>

<p>It&rsquo;s time to do some inference on our trained network.</p>

<h2>Inference</h2>

<p>Firing up a REPL we can connect to our namespace and use the <code>label-one</code> function from the cortex example to spot check our classification. It reads in the external nippy file that contains the trained network description, takes a random image from the testing directory, and classifies it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">label-one</span>
</span><span class='line'>  <span class="s">&quot;Take an arbitrary image and label it.&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-label-pairs</span> <span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">classification/directory-&gt;file-label-seq</span> <span class="nv">testing-dir</span>
</span><span class='line'>                                                                            <span class="nv">false</span><span class="p">))</span>
</span><span class='line'>        <span class="p">[</span><span class="nv">test-file</span> <span class="nv">test-label</span><span class="p">]</span> <span class="p">(</span><span class="nb">first </span><span class="nv">file-label-pairs</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">test-img</span> <span class="p">(</span><span class="nf">imagez/load-image</span> <span class="nv">test-file</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">observation</span> <span class="p">(</span><span class="nf">png-&gt;observation</span> <span class="nv">dataset-datatype</span> <span class="nv">false</span> <span class="nv">test-img</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">imagez/show</span> <span class="nv">test-img</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">infer/classify-one-observation</span> <span class="p">(</span><span class="ss">:network-description</span>
</span><span class='line'>                                     <span class="p">(</span><span class="nf">suite-io/read-nippy-file</span> <span class="s">&quot;trained-network.nippy&quot;</span><span class="p">))</span>
</span><span class='line'>                                    <span class="nv">observation</span>
</span><span class='line'>                                    <span class="p">(</span><span class="nf">ds/create-image-shape</span> <span class="nv">dataset-num-channels</span>
</span><span class='line'>                                                           <span class="nv">dataset-image-size</span>
</span><span class='line'>                                                           <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>                                    <span class="nv">dataset-datatype</span>
</span><span class='line'>                                    <span class="p">(</span><span class="nf">classification/get-class-names-from-directory</span> <span class="nv">testing-dir</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running <code>(label-one)</code> gives us the picture:</p>

<p><img src="http://c2.staticflickr.com/1/423/31105658073_b6143b2f00.jpg"></p>

<p>and classifies it as a cat. Yipee!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:probability-map</span> <span class="p">{</span><span class="s">&quot;cat&quot;</span> <span class="mf">0.9995587468147278</span>, <span class="s">&quot;dog&quot;</span> <span class="mf">4.4119369704276323</span><span class="nv">E-4</span><span class="p">}</span>, <span class="ss">:classification</span> <span class="s">&quot;cat&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not bad, but let&rsquo;s try it with something harder. Personally, I&rsquo;m not even sure whether this is a cat or a dog.</p>

<p><img src="http://c6.staticflickr.com/1/596/31105666133_223dc2f04e_c.jpg"></p>

<p>Feeding it through the program &ndash; it says it is a cat.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">{</span><span class="ss">:probability-map</span> <span class="p">{</span><span class="s">&quot;cat&quot;</span> <span class="mf">0.9942012429237366</span>, <span class="s">&quot;dog&quot;</span> <span class="mf">0.005798777565360069</span><span class="p">}</span>, <span class="ss">:classification</span> <span class="s">&quot;cat&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After much <a href="http://www.today.com/pets/cat-or-dog-wild-eyed-cutie-has-us-all-confused-t104835">debate on the internet</a>, I think that is the best answer the humans got too :)</p>

<h2>Kaggle it</h2>

<p>So it seems like we have a pretty good model, why don&rsquo;t we submit our results to the Kaggle competition and see how it rates. All they need is to have us run the classification against their test data of 12,500 images and classify them as 1 = dog or 0 = cat in a csv format.</p>

<p>We will take each image and resize it, then feed it into cortex&rsquo;s <code>infer-n-observations</code> function, to do all our classification as a batch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">(</span><span class="nf">infer/infer-n-observations</span> <span class="p">(</span><span class="ss">:network-description</span>
</span><span class='line'>                                             <span class="p">(</span><span class="nf">suite-io/read-nippy-file</span> <span class="s">&quot;trained-network.nippy&quot;</span><span class="p">))</span>
</span><span class='line'>                                            <span class="nv">observations</span>
</span><span class='line'>                                            <span class="p">(</span><span class="nf">ds/create-image-shape</span> <span class="nv">dataset-num-channels</span>
</span><span class='line'>                                                                   <span class="nv">dataset-image-size</span>
</span><span class='line'>                                                                   <span class="nv">dataset-image-size</span><span class="p">)</span>
</span><span class='line'>                                            <span class="nv">dataset-datatype</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we just need to format our results to a csv file and export it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">write-kaggle-results</span> <span class="p">[</span><span class="nv">results</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">out-file</span> <span class="p">(</span><span class="nf">io/writer</span> <span class="s">&quot;kaggle-results.csv&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">csv/write-csv</span> <span class="nv">out-file</span>
</span><span class='line'>                   <span class="p">(</span><span class="nb">into </span><span class="p">[[</span><span class="s">&quot;id&quot;</span> <span class="s">&quot;label&quot;</span><span class="p">]]</span>
</span><span class='line'>                         <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">mapv</span> <span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">id</span> <span class="nv">class</span><span class="p">]]</span> <span class="p">[(</span><span class="nf">Integer/parseInt</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">&quot;dog&quot;</span> <span class="nv">class</span><span class="p">)</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">)])</span> <span class="nv">results</span><span class="p">)</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">sort</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>After uploading the file to the Kaggle, I was pleased that the answer got in the top 91%! It made it on the <a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/leaderboard">Leaderboard</a>.</p>

<h2>Conclusion</h2>

<p>Using an example setup from the Cortex project and 30 minutes of processing time on my laptop, we were able to crunch through some significant data and come up with a trained classification model that was good enough to make the charts in the Kaggle competition. On top of it all, it is in pure Clojure.</p>

<p>In my mind, this is truely impressive and even though the Cortex library is in it&rsquo;s early phases, it puts it on track to be as useful a tool as Tensor Flow for Machine Learning.</p>

<p>Earlier this month, I watched an ACM Learning webcast with Peter Norvig speaking on AI. In it, he spoke of one of the next challenges of AI which is to combine <a href="https://twitter.com/gigasquid/status/806916856040689664?lang=en">symbolic with neural</a>. I can think of no better language than Clojure with it&rsquo;s simplicity, power, and rich LISP heritage to take on the challenge for the future. With the Cortex library, it&rsquo;s off to a great start.</p>

<p><em>If want to see all the cats vs dog  Kaggle Code, it&rsquo;s out on github here <a href="https://github.com/gigasquid/kaggle-cats-dogs">https://github.com/gigasquid/kaggle-cats-dogs</a></em></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/12/27/deep-learning-in-clojure-with-cortex//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/07/18/genetic-programming-with-clojure-dot-spec/">
		
			Genetic Programming With clojure.spec</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2016-07-18T09:40:00-04:00" pubdate data-updated="true">Jul 18<span>th</span>, 2016</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure</a>


</div>
    </div>
		<p><img src="http://c1.staticflickr.com/9/8815/28320682816_44780d1b75.jpg"></p>

<p><a href="http://blog.cognitect.com/blog/2016/5/23/introducing-clojurespec">Clojure.spec</a> is a new library for Clojure that enables you to write specifications for your program.  In an earlier <a href="http://gigasquidsoftware.com/blog/2016/05/29/one-fish-spec-fish/">post</a>, I showed off some of it&rsquo;s power to generate test data from your specifications.  It&rsquo;s a pretty cool feature.  Given some clojure.spec code, you can generate sample data for you based off of the specifications.  But what if you could write a program that would <em>generate</em> your clojure.spec program based off of data so that you could generate more test data?</p>

<h2>Genetic programming</h2>

<p>Here is where we embark for fun.  We are going to use genetic programming to generate clojure.spec <em>creatures</em> that contain a program.  Through successive generations, those creatures will breed, mutate, and evolve to fit the data that we are going to give it.  Going with our creature theme, we can say that it <em>eats</em> a sequence of data like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="s">&quot;hi&quot;</span> <span class="nv">true</span> <span class="mi">5</span> <span class="mi">10</span> <span class="s">&quot;boo&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each creature will be represented by a map that has information about two key pieces, its program and the <em>fitness</em> score.  Each program is going to start with a <a href="https://clojure.github.io/clojure/branch-master/clojure.spec-api.html#clojure.spec/cat">clojure.spec/cat</a>, (which is the spec to describe a sequence).  From here on out, I&rsquo;m going to refer to the clojure.spec namespace as <code>s/</code>.  So, a simple creature would look like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>
</span><span class='line'> <span class="ss">:score</span> <span class="mi">0</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>How do we figure out a score from the creature&rsquo;s spec?  We run the spec and see how much of the data that it can successfully consume.</p>

<h3>Scoring a creature</h3>

<p>To score a creature, we&rsquo;re going to use the clojure.spec <code>explain-data</code> function. It enables us to run a spec against some data and get back the problems in a data format that we can inspect.  If there are no problems and the spec passes, the result is nil.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>  <span class="p">[</span><span class="mi">1</span> <span class="s">&quot;hi&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, if there is a problem, we can get information about what went wrong.  In particular, we can see <em>where</em> it went wrong in the sequence.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)</span>  <span class="p">[</span><span class="mi">1</span> <span class="nv">true</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; #:clojure.spec{:problems [{:path [:1], :pred string?, :val true, :via [], :in [1]}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above example, the <code>:in</code> key tells us that it fails at index 1. This gives us all the information we need to write a score function for our creature.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">score</span> <span class="p">[</span><span class="nv">creature</span> <span class="nv">test-data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">try</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">problems</span> <span class="p">(</span><span class="ss">:clojure.spec/problems</span> <span class="p">(</span><span class="nf">s/explain-data</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="ss">:program</span> <span class="nv">creature</span><span class="p">))</span> <span class="nv">test-data</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="nv">problems</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">problems</span> <span class="p">[</span><span class="mi">0</span> <span class="ss">:in</span> <span class="mi">0</span><span class="p">]))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="mi">100</span><span class="p">)))</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">catch</span> <span class="nv">Throwable</span> <span class="nv">e</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:score</span> <span class="mi">0</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This function tries to run the spec against the data.  If there are no problems, the creature gets a 100 score.  Otherwise, it records the farthest point in the sequence that it got.  Creatures with a higher score are considered more <em>fit</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">score</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:0</span> <span class="nv">int?</span> <span class="ss">:1</span> <span class="nv">string?</span><span class="p">)}</span> <span class="p">[</span><span class="mi">1</span> <span class="nv">true</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; {:program (s/cat :0 int? :1 string?), :score 1}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a fitness function to evaluate our creatures, we need a way to generate a random clojure.spec creature.</p>

<p><img src="http:////c1.staticflickr.com/9/8781/28071856800_0477b25fcc.jpg"></p>

<h3>Create a random creature</h3>

<p>This is where I really love Clojure.  Code is data, so we can create the programs as lists and they are just themselves.  To run the programs, we just need to call <code>eval</code> on them.  We are going to constrain the creatures somewhat.  They are all going to start out with <code>s/cat</code> and have a certain length of items in the sequence.  Also, we are going to allow the parts of the spec to be created with certain predicates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">preds</span> <span class="p">[</span><span class="ss">&#39;integer?</span> <span class="ss">&#39;string?</span> <span class="ss">&#39;boolean?</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">even?</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also allowing, composition with ands and ors and other sequences.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">seqs</span> <span class="p">[</span><span class="ss">&#39;s/+</span> <span class="ss">&#39;s/*</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">and-ors</span> <span class="p">[</span><span class="ss">&#39;s/and</span> <span class="ss">&#39;s/or</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are also going to have some probability knobs to control how the random creature is constructed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">seq-prob</span> <span class="mf">0.3</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nest-prob</span> <span class="mf">0.00</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">max-depth</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">and-or-prob</span> <span class="mf">0.85</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>seq-prob</code> is the probability that a new spec sub sequence will be constructed.  The <code>nest-prob</code> is set to zero right now, to keep things simple, but if turned up with increase the chance that a nested spec sequence would occur.  We are going to be writing a recursive function for generation, so we&rsquo;ll keep things to a limited depth with <code>max-depth</code>.  Finally, we have the chance that when constructing a spec sub sequence, that it will be an and/or with <code>and-or-prob</code>.  Putting it all together with code to construct a random arg.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-arg</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">pos? </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">seq-prob</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">make-random-seq</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">preds</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also creating a random sub sequence.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-seq</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">cond</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">nest-prob</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">s/spec</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">seqs</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">and-or-prob</span><span class="p">)</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">and-ors</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">))</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="ss">:else</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">seqs</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">make-random-arg</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we can create a random <code>s/cat</code> spec with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-random-cat</span> <span class="p">[</span><span class="nv">len</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">args</span> <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">r</span> <span class="nv">i</span><span class="p">]</span>
</span><span class='line'>                       <span class="p">(</span><span class="nb">conj </span><span class="nv">r</span> <span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nb">str </span><span class="nv">i</span><span class="p">))</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">make-random-arg</span> <span class="nv">max-depth</span><span class="p">)))</span>
</span><span class='line'>                     <span class="p">[]</span>
</span><span class='line'>                     <span class="p">(</span><span class="nb">range </span><span class="nv">len</span><span class="p">))]</span>
</span><span class='line'>    <span class="o">`</span><span class="p">(</span><span class="nf">s/cat</span> <span class="o">~@</span><span class="nv">args</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see it in action.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">make-random-cat</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="c1">;=&gt; (clojure.spec/cat :0 (s/and integer? odd?) :1 integer? :2 boolean?)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can make a batch of new creatures for our initial population using this function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">initial-population</span> <span class="p">[</span><span class="nv">popsize</span> <span class="nv">max-cat-length</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="nv">popsize</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">make-random-cat</span> <span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="nb">rand-int </span><span class="nv">max-cat-length</span><span class="p">)))}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great! Now we have a way to make new random spec creatures.  But, we need a way to alter them and let them evolve.  The first way to do this is with <em>mutation</em>.</p>

<p><img src="http://c2.staticflickr.com/9/8807/28275661121_94361d2fc4.jpg"></p>

<h3>Mutating a creature</h3>

<p>Mutation in our case, means changing part of the code tree of the creature&rsquo;s program.  To keep the program runnable, we don&rsquo;t want to be able to mutate every node, only specific ones.  We&rsquo;re going to control this by defining a <code>mutable</code> function that will only change nodes that start with our sequences or predicates.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">mutable?</span> <span class="p">[</span><span class="nv">node</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">seq? </span><span class="nv">node</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nf">set/union</span> <span class="p">(</span><span class="nb">set </span><span class="nv">seqs</span><span class="p">)</span> <span class="o">#</span><span class="p">{</span><span class="ss">&#39;clojure.spec/spec</span><span class="p">})</span> <span class="p">(</span><span class="nb">first </span><span class="nv">node</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">contains? </span><span class="p">(</span><span class="nb">set </span><span class="nv">preds</span><span class="p">)</span> <span class="nv">node</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we can use <code>postwalk</code> to walk the code tree and alter a node by a mutation probability factor</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mutate-prob</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">mutate</span> <span class="p">[</span><span class="nv">creature</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">program</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">mutated-program</span> <span class="p">(</span><span class="nf">walk/postwalk</span>
</span><span class='line'>                         <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">mutable?</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">mutate-prob</span><span class="p">))</span>
</span><span class='line'>                                  <span class="p">(</span><span class="nf">make-random-arg</span> <span class="nv">max-depth</span><span class="p">)</span>
</span><span class='line'>                                  <span class="nv">x</span><span class="p">))</span> <span class="nv">program</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">creature</span> <span class="ss">:program</span> <span class="nv">mutated-program</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trying it on one of our creatures.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">mutate</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)</span> <span class="ss">:1</span> <span class="nv">integer?</span><span class="p">)})</span>
</span><span class='line'><span class="c1">;=&gt; {:program (clojure.spec/cat :0 (s/or (s/and integer? even?)) :1 integer?)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can change our creatures via mutation, but what about breeding it with other creatures?</p>

<p><img src="http://c8.staticflickr.com/9/8670/28354279095_25661401c0_z.jpg"></p>

<h3>Crossovers with creatures</h3>

<p>Crossover is another way to modify programs.  It takes two creatures and swaps a node from one creature to another. To accomplish this, we&rsquo;re going to use the <code>walk</code> function to select at a random probability the crossover node from the first node, then insert it into the second&rsquo;s creatures program at another random spot.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">crossover-prob</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">crossover</span> <span class="p">[</span><span class="nv">creature1</span> <span class="nv">creature2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">program1</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature1</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">program2</span> <span class="p">(</span><span class="ss">:program</span> <span class="nv">creature2</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">chosen-node</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">walk/walk</span>
</span><span class='line'>                            <span class="o">#</span><span class="p">(</span><span class="nf">when</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">crossover-prob</span><span class="p">)</span>
</span><span class='line'>                                      <span class="p">(</span><span class="nf">mutable?</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>                               <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                            <span class="o">#</span><span class="p">(</span><span class="nb">remove nil? </span><span class="nv">%</span><span class="p">)</span> <span class="nv">program1</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">crossed-over?</span> <span class="p">(</span><span class="nf">atom</span> <span class="nv">false</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">crossover-program</span> <span class="p">(</span><span class="k">if </span><span class="nv">chosen-node</span>
</span><span class='line'>                             <span class="p">(</span><span class="nf">walk/postwalk</span>
</span><span class='line'>                              <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>                                <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">mutable?</span> <span class="nv">x</span><span class="p">)</span>
</span><span class='line'>                                         <span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">crossover-prob</span><span class="p">)</span>
</span><span class='line'>                                         <span class="p">(</span><span class="nb">not </span><span class="err">@</span><span class="nv">crossed-over?</span><span class="p">))</span>
</span><span class='line'>                                  <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">reset!</span> <span class="nv">crossed-over?</span> <span class="nv">true</span><span class="p">)</span> <span class="nv">chosen-node</span><span class="p">)</span>
</span><span class='line'>                                  <span class="nv">x</span><span class="p">))</span>
</span><span class='line'>                              <span class="nv">program2</span><span class="p">)</span>
</span><span class='line'>                             <span class="nv">program2</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">{</span><span class="ss">:program</span> <span class="nv">crossover-program</span><span class="p">}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Taking two creatures and putting them together.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">crossover</span> <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="p">(</span><span class="nf">s/and</span> <span class="nv">integer?</span> <span class="nv">odd?</span><span class="p">)</span> <span class="ss">:1</span> <span class="nv">integer?</span><span class="p">)}</span>
</span><span class='line'>           <span class="p">{</span><span class="ss">:program</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">clojure.spec/cat</span> <span class="ss">:0</span> <span class="nb">string? </span><span class="ss">:1</span> <span class="nv">boolean?</span><span class="p">)})</span>
</span><span class='line'><span class="c1">;=&gt; {:program (clojure.spec/cat :0 (s/and integer? odd?) :1 boolean?)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have our ways to change our creatures to let them evolve and we have a way to rank them.  What we need now is to put it together in a way that will let them evolve to the solution.</p>

<p><img src="http://c5.staticflickr.com/9/8570/28320682956_2a301eea70_z.jpg"></p>

<h3>Evolving creatures</h3>

<p>The process will be in general terms:</p>

<ul>
<li>Create initial population</li>
<li>Rank them</li>
<li>Take the top two best ones and carry them over (this is known as <em>elitism</em>)</li>
<li>Create the next generation from by <em>selecting</em> creatures for crossover and mutation</li>
<li>Repeat!</li>
</ul>


<p>So how do we select the best creatures for our next population?  This is an interesting question, there are many approaches.  The one that we&rsquo;re going to use is called <a href="https://en.wikipedia.org/wiki/Tournament_selection">tournament selection</a>.  It involves picking n creatures from the whole population and then, among those, picking the best scored one.  This will allow diversity in our population that is needed for proper evolution.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">select-best</span> <span class="p">[</span><span class="nv">creatures</span> <span class="nv">tournament-size</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">selected</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">tournament-size</span> <span class="o">#</span><span class="p">(</span><span class="nf">rand-nth</span> <span class="nv">creatures</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">selected</span><span class="p">)</span> <span class="nb">reverse </span><span class="nv">first</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re now ready to write our evolve function.  In it, we pass in the population size, how many generations we want, the tournament size, and of course, our test data that our creatures are going to feed on.  The loop ends when it reaches a perfect fitting solution, (a creature with a score of 100), or the max generations.</p>

<p>Note that we have a chance for a completely random creature to appear in the generations, to further encourage diversity.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">perfect-fit</span> <span class="p">[</span><span class="nv">creatures</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="mi">100</span> <span class="p">(</span><span class="ss">:score</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">creatures</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">evolve</span> <span class="p">[</span><span class="nv">pop-size</span> <span class="nv">max-gen</span> <span class="nv">tournament-size</span> <span class="nv">test-data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">n</span> <span class="nv">max-gen</span>
</span><span class='line'>         <span class="nv">creatures</span> <span class="p">(</span><span class="nf">initial-population</span> <span class="nv">pop-size</span> <span class="p">(</span><span class="nb">count </span><span class="nv">test-data</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;generation &quot;</span> <span class="p">(</span><span class="nb">- </span><span class="nv">max-gen</span> <span class="nv">n</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">scored-creatures</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">creature</span><span class="p">]</span> <span class="p">(</span><span class="nf">score</span> <span class="nv">creature</span> <span class="nv">test-data</span><span class="p">))</span> <span class="nv">creatures</span><span class="p">)]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">scored-creatures</span><span class="p">))</span>
</span><span class='line'>       <span class="nv">scored-creatures</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">elites</span> <span class="p">(</span><span class="nb">take </span><span class="mi">2</span> <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">scored-creatures</span><span class="p">)))</span>
</span><span class='line'>             <span class="nv">new-creatures</span> <span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">i</span> <span class="p">(</span><span class="nb">range </span><span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nb">count </span><span class="nv">creatures</span><span class="p">)</span> <span class="mi">2</span><span class="p">))]</span>
</span><span class='line'>                             <span class="c1">;; add a random node to improve diversity</span>
</span><span class='line'>                             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nf">rand</span><span class="p">)</span> <span class="nv">new-node-prob</span><span class="p">)</span>
</span><span class='line'>                               <span class="p">{</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">make-random-cat</span> <span class="p">(</span><span class="nb">count </span><span class="nv">test-data</span><span class="p">))}</span>
</span><span class='line'>                               <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">creature1</span> <span class="p">(</span><span class="nf">select-best</span> <span class="nv">scored-creatures</span> <span class="nv">tournament-size</span><span class="p">)</span>
</span><span class='line'>                                     <span class="nv">creature2</span> <span class="p">(</span><span class="nf">select-best</span> <span class="nv">scored-creatures</span> <span class="nv">tournament-size</span><span class="p">)]</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nf">mutate</span> <span class="p">(</span><span class="nf">crossover</span> <span class="nv">creature1</span> <span class="nv">creature2</span><span class="p">)))))]</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">println </span><span class="s">&quot;best-scores&quot;</span> <span class="p">(</span><span class="nb">map </span><span class="ss">:score</span> <span class="nv">elites</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">dec </span><span class="nv">n</span><span class="p">)</span> <span class="p">(</span><span class="nb">into </span><span class="nv">new-creatures</span> <span class="nv">elites</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trying it out. We get a perfect clojure.spec creature!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">creature-specs</span> <span class="p">(</span><span class="nf">evolve</span> <span class="mi">100</span> <span class="mi">100</span> <span class="mi">7</span> <span class="p">[</span><span class="s">&quot;hi&quot;</span> <span class="nv">true</span> <span class="mi">5</span> <span class="mi">10</span> <span class="s">&quot;boo&quot;</span><span class="p">]))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">creature-specs</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;=&gt;{:program (clojure.spec/cat :0 string? :1 boolean? :2 (s/and integer? odd?) :3 integer? :4 string?)</span>
</span><span class='line'>      <span class="ss">:score</span> <span class="mi">100</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, our clojure.spec creature can generate data on its own with the <code>exercise</code> function.  Let&rsquo;s have it generate 5 more examples of data that conform to its spec.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">(</span><span class="nf">s/exercise</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="ss">:program</span> <span class="p">(</span><span class="nf">perfect-fit</span> <span class="nv">creature-specs</span><span class="p">)))</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(&quot;&quot; true -1 -1 &quot;&quot;) {:0 &quot;&quot;, :1 true, :2 -1, :3 -1, :4 &quot;&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;D&quot; false -1 -1 &quot;G&quot;) {:0 &quot;D&quot;, :1 false, :2 -1, :3 -1, :4 &quot;G&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;12&quot; false -1 0 &quot;l0&quot;) {:0 &quot;12&quot;, :1 false, :2 -1, :3 0, :4 &quot;l0&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;&quot; false -1 -2 &quot;&quot;) {:0 &quot;&quot;, :1 false, :2 -1, :3 -2, :4 &quot;&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(&quot;2&quot; false 1 0 &quot;Jro&quot;) {:0 &quot;2&quot;, :1 false, :2 1, :3 0, :4 &quot;Jro&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we wanted to, we could adjust our evolve function and let it continue to evolve creatures and lots of different solutions to choose from. We could even take the generated data from the <code>exercise function</code> and let it generate more creatures who generate more data&hellip;&hellip;</p>

<p>The mind boggles.</p>

<p>We&rsquo;ll leave with a quick summary of Genetic Programming.</p>

<ul>
<li>Start with a way to generate random creatures</li>
<li>Have a way to evaluate their fitness</li>
<li>Create a way to change them for the next generations using

<ul>
<li>Mutation</li>
<li>Crossover</li>
</ul>
</li>
<li>Have an evolution process

<ul>
<li>Create an initial population</li>
<li>Rank them</li>
<li>Create the next generation using selection techniques and mutation/ crossovers</li>
<li>Don&rsquo;t forget about diversity</li>
</ul>
</li>
</ul>


<p>Most importantly, have fun!</p>

<p>If you want to play with the code, it&rsquo;s on github here <a href="https://github.com/gigasquid/genetic-programming-spec">https://github.com/gigasquid/genetic-programming-spec</a></p>

<p>If you want to learn more about clojure.spec this <a href="https://www.youtube.com/watch?v=nqY4nUMfus8">video</a> is a great place to start.  The <a href="http://clojure.org/guides/spec">guide</a> is also a great reference with examples.</p>

<p>If you want to learn more about genetic programming, there are a couple of books I would recommend: <a href="https://www.amazon.com/Programming-Collective-Intelligence-Building-Applications/dp/0596529325">Collective Intelligence</a> and <a href="https://www.amazon.com/Genetic-Algorithms-Structures-Evolution-Programs/dp/3540606769/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1468862704&amp;sr=1-1&amp;keywords=genetic+algorithms+data+structures">Genetic Algorithms + Data Structures = Evolution Programs</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/07/18/genetic-programming-with-clojure-dot-spec//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/07/03/hello-world/">
		
			Hello World for the Next Generation</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2016-07-03T15:01:00-04:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2016</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>


</div>
    </div>
		<p>I sit next to my daughter, showing her programming for the first time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;Now press enter.&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ldquo;Pretty cool, huh?&rdquo;</p>

<p>She looks unimpressed.  I fear I&rsquo;m losing her.  How can I explain that this is just a small tip of something so much bigger?</p>

<h3>You can make the code sing to you.</h3>

<p>You can take these numbers, turn them into notes, and line them up with the beat of your heart. Bring in the melody and chorus and build them up to a crescendo. Let it crash in waves and then</p>

<h3>You can make the code dance for you.</h3>

<p>You can create delicate swirls and patterns with mathematical expressions.  Have them pulse to the music in a never ending prism of fractals, flexing your control with confidence because</p>

<h3>You can make the code lift you up.</h3>

<p>It doesn&rsquo;t matter if you don&rsquo;t look like them.  It doesn&rsquo;t matter if they think you don&rsquo;t belong. They can&rsquo;t hold you back. You&rsquo;re smart and strong and</p>

<h3>You can make the code create your life.</h3>

<p>You can solve problems for people.  Make things work better and faster.  Keep the data flowing.  Make a company for yourself.  Watch that company and your power and influence in the world grow until nothing feels out of reach and then, if you&rsquo;re not careful</p>

<h3>You can make the code hard and cruel.</h3>

<p>You can automate hate.  Use the latest AI to keep them in control.  Watch them with never sleeping eyes.  Steal their money and point guns at them with armed robots.  Then, late at night, you can think how</p>

<h3>You can let the code control you.</h3>

<p>You can forget the important things in life.  Turn away from family and friends.  Lose yourself in some self created digital representation of yourself that never feels smart enough and leaves you grasping for more.  Until that day, when you walk the streets with a deadened heart and you see the sad faces all around and you remember that</p>

<h3>You can let the code make them smile.</h3>

<p>You can use your skills to brighten dark days.  Use your programs to make them laugh.  When you have their attention, inspire them to dream with you of a better world and next</p>

<h3>You can make the code save lives.</h3>

<p>You can turn those algorithms to heal.  Dive in and join the battle against death and disease.  Make sense of all the data.  Then lift your head to the sky and</p>

<h3>You can make the code reach the stars.</h3>

<p>You can see the surface of Mars.  Pick up a rock from a planet that was unimaginable generations before.  Look out at what is beyond our solar system and peer into the mysteries of the beginning of time.</p>

<h3>You can.</h3>

<p>All these things are yours now.  The terrible and beautiful power of it.</p>

<p>I reach down to type the code that distills my hopes and fears for the next generation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">println </span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I slide the keyboard over to her, a tear sliding down my cheek, and lean over to whisper the only advice that I can form into words,</p>

<p>&ldquo;Don&rsquo;t forget the closing parens.&rdquo;</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/07/03/hello-world//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/06/19/book-writing-for-the-busy-programmer/">
		
			Book Writing for the Busy Programmer</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2016-06-19T09:22:00-04:00" pubdate data-updated="true">Jun 19<span>th</span>, 2016</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>


</div>
    </div>
		<p><img src="http://c5.staticflickr.com/8/7302/27492453220_eecdf6dee1.jpg"></p>

<p>So you want to write a book?  Awesome.  I&rsquo;ve been working on one too for the last year.</p>

<p>No, it&rsquo;s not really a programming book, but it does have code in it.  It&rsquo;s a sci-fi/fantasy book written for my ten year daughter, but this post isn&rsquo;t about that.  It&rsquo;s about sharing the tools and setup that I&rsquo;ve found work best for me.</p>

<h2>Tools for Writing</h2>

<p>If the first thing you think of when you want to write a book is creating some really cool tools to help you, I can totally relate.  It&rsquo;s a programmer thing.</p>

<p>Hold on though, there&rsquo;s another way.</p>

<p>Starting out with only my book idea, I spent some time looking at the best authoring tools out there.  I knew that I wanted to able to write in an editor that I was comfortable in and in a terse format like Markdown.  I also wanted to be able to use git for revision management.  After searching, I settled on <a href="https://leanpub.com/">Leanpub</a></p>

<p>Leanpub is a free service for authoring that has <a href="https://leanpub.com/help/getting_started_sync_github">Git integration</a> in <a href="https://leanpub.com/help">Markdown format</a>.  With it, I was able to write in my favorite text editor, (Emacs of course), commit and push my changes to my git repo, and then generate PDF and e-book formats.  The multiple formats were important to me because it allowed me to share my chapters and get feedback.</p>

<h2>Tools for Feedback</h2>

<p>Since I was writing a book with my daughter in mind, the most important feedback was from her.  After every chapter was done.  I would either print her out a copy or download it to her Kindle for review.  She actually really enjoyed reading it on her Kindle because it made it for more <em>real</em> to her.  My son also got interested in the story and before long, I had them both getting in heated debates about which direction the story should go.</p>

<p>After my kids reviewed the chapters, I also sought some professional writing advice from a free-lance editor.  I highly recommend getting this sort of feedback from an editor, writing group, or trusted friend to help you grow and improve. The one catch is that most of the writing world works with Microsoft Word, so I needed to convert my chapters to that format.</p>

<p>From my experience, all PDF to Word converters are full of fail.  The formatting goes all over the place and your writing ends up looking like some horrible abstract text art experiment gone wrong.  So far, the best converter I&rsquo;ve found is <a href="http://pandoc.org/">pandoc</a>.  It allows you to take your Markdown files and turn them into quite presentable Word documents.</p>

<p>If you have a Mac, it&rsquo;s as simple as <code>brew install pandoc</code>.  Then, you can create a simple script to convert all your chapters,(or a selection) into a properly formatted Word Doc.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>rm ./all.md
</span><span class='line'>for i in `cat ./Book.txt`; do  cat $i &gt;&gt; all.md; echo "  " &gt;&gt; all.md ; done
</span><span class='line'>pandoc -o all.docx -f markdown -t docx ./all.md</span></code></pre></td></tr></table></div></figure>


<p>Once you write your manuscript, (what the publishing world calls your book text), revise it, copy edit it, and walk backwards in a circle three times, you&rsquo;re ready to publish.</p>

<h2>Tools for Publishing</h2>

<p>I don&rsquo;t have any real firm advice in this area yet since I&rsquo;m still in the midst of it, but I&rsquo;ll share the two options that I&rsquo;m looking at &ndash; traditional publishing and self publishing.</p>

<p>Self publishing is more easily understood of the two.  You can put your book up for sale at any time through Leanpub or Amazon.  For better or worse, you have complete control of the content, display, marketing, and revenue of your book.</p>

<p>Traditional publishing involves finding an literary agent and/or publisher to work with.  This route involves pitching your manuscript to someone to represent it through a <a href="http://nybookeditors.com/2015/12/how-to-write-a-darn-good-query-letter/">query</a>.  The advantages of this are that, (if you find a good match), you will have a team of people helping you make your book the best it can be and have the possibility of getting it on the shelf in a bookstore.  One of the downsides is that the traditional publishing world takes a lot longer than pushing the self publish button.</p>

<p>With any luck, I&rsquo;ll have a clearer picture of this all in a bit and be able to share my experiences.  In the meantime, I encourage you to grab your keyboard and bring your book ideas to life.</p>

<p>No matter the outcome, it&rsquo;s a rewarding journey.</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/06/19/book-writing-for-the-busy-programmer//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/05/29/one-fish-spec-fish/">
		
			One Fish Spec Fish</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2016-05-29T16:29:00-04:00" pubdate data-updated="true">May 29<span>th</span>, 2016</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/all/'>All</a>, <a class='category' href='/blog/categories/clojure/'>Clojure</a>


</div>
    </div>
		<p><img src="https://upload.wikimedia.org/wikipedia/en/9/9a/One_Fish_Two_Fish_Red_Fish_Blue_Fish_%28cover_art%29.jpg"></p>

<p><a href="http://blog.cognitect.com/blog/2016/5/23/introducing-clojurespec">Clojure.spec</a> is an exciting, new core library for Clojure.  It enables pragmatic specifications for functions and brings a new level of robustness to building software in Clojure, along with unexpected side benefits.  One of which is the ability to write specifications that generate Dr. Seuss inspired rhymes.</p>

<p>In this blog post, we&rsquo;ll take a tour of writing specifications for a clojure function, as well as the power of data generation.  First, some inspirational words:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>One fish
</span><span class='line'>Two fish
</span><span class='line'>Red fish
</span><span class='line'>Blue fish</span></code></pre></td></tr></table></div></figure>


<p>The mere shape of these words brings a function to mind.  One that would take in a vector:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>and give us back a string of transformed items with the word <em>fish</em> added, of course.</p>

<p>But, let us turn our attention the parameters of this function and see how we can further specify them.  Before we get started, make sure you use the latest version of clojure, currently <code>[org.clojure/clojure "1.9.0-alpha13"]</code>,  test.check <code>[org.clojure/test.check "0.9.0"]</code>, and add clojure.spec to your namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">one-fish.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.spec</span> <span class="ss">:as</span> <span class="nv">s</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Specifying the values of the parameters</h3>

<p>Back to the parameters. The first two are integers, that&rsquo;s pretty easy, but we want to say more about them.  For example, we don&rsquo;t want them to be very big.  Having a child&rsquo;s poem with the <em>One Hundred Thousand and Thirty Three fish</em> really won&rsquo;t do.  In fact, what we really want is to say is there is finite notion of <em>fish-numbers</em> and it&rsquo;s a map of integer to string representation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">fish-numbers</span> <span class="p">{</span><span class="mi">0</span> <span class="s">&quot;Zero&quot;</span>
</span><span class='line'>                   <span class="mi">1</span> <span class="s">&quot;One&quot;</span>
</span><span class='line'>                   <span class="mi">2</span> <span class="s">&quot;Two&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, we can use the <code>s/def</code> to register the spec we are going to define for global reuse.  We&rsquo;ll use a namespaced keyword <code>::fish-number</code> to express that our specification for a valid number is the keys of the <code>fish-numbers</code> map.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::fish-number</span> <span class="p">(</span><span class="nb">set </span><span class="p">(</span><span class="nb">keys </span><span class="nv">fish-numbers</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have the specification, we can ask it if it&rsquo;s valid for a given value.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::fish-number</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::fish-number</span> <span class="mi">5</span><span class="p">)</span> <span class="c1">;=&gt; false</span>
</span></code></pre></td></tr></table></div></figure>


<p>So <code>5</code> is not a valid number for us.  We can ask it to explain why not.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::fish-number</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;;val: 5 fails spec: :one-fish.core/fish-number predicate: (set (keys fish-numbers))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which, of course,  totally makes sense because <code>5</code> is not in our <code>fish-numbers</code> map.  Now that we&rsquo;ve covered the numbers, let&rsquo;s look at the colors.  We&rsquo;ll use a finite set of colors for our specification.  In addition to the classic red and blue, we&rsquo;ll also add the color <em>dun</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::color</span> <span class="o">#</span><span class="p">{</span><span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span> <span class="s">&quot;Dun&quot;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>You may be asking yourself, &ldquo;Is dun really a color?&rdquo;.  The author can assure you that it is in fact a real color, like a <a href="http://www.dictionary.com/browse/dun">dun colored horse</a>.  Furthermore, the word has the very important characteristic of rhyming with number one, which the author spent way too much time trying to think of.</em></p>

<h3>Specifying the sequences of the values</h3>

<p>We&rsquo;re at the point where we can start specifying things about the sequence of values in the parameter vector.  We&rsquo;ll have two numbers followed by two colors.  Using the <code>s/cat</code>, which is a concatentation of predicates/patterns, we can specify it as the <code>::first-line</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What the spec is doing here is associating each <em>part</em> with a <em>tag</em>, to identify what was matched or not, and its predicate/pattern.  So, if we try to explain a failing spec, it will tell us where it went wrong.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span>  <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Black&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;; In: [3] val: &quot;Black&quot; fails spec: :one-fish.core/color</span>
</span><span class='line'><span class="c1">;;   at: [:c2] predicate: #{&quot;Blue&quot; &quot;Dun&quot; &quot;Red&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s great, but there&rsquo;s more we can express about the sequence of values.  For example, the second number should be one bigger than the first number.  The input to the function is going to be the map of the destructured tag keys from the <code>::first-line</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">one-bigger?</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">n1</span> <span class="nv">n2</span><span class="p">]}]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="nv">n2</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">n1</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, the colors should not be the same value.  We can add these additional specifications with <code>s/and</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/and</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">)</span>
</span><span class='line'>                           <span class="nv">one-bigger?</span>
</span><span class='line'>                           <span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:c1</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c2</span> <span class="nv">%</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can test if our data is valid.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to get the destructured, conformed values, we can use <code>s/conform</code>.  It will return the tags along with the values.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/conform</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;=&gt; {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Failing values for the specification can be easily identified.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; false</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;; val: {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}</span>
</span><span class='line'><span class="c1">;; fails spec: :one-fish.core/first-line predicate: one-bigger?</span>
</span></code></pre></td></tr></table></div></figure>


<p>With our specifications for both the values and the sequences of values in hand, we can now use the power of data generation to actually create data.</p>

<h3>Generating test data &ndash; and poetry with specification</h3>

<p>The <code>s/exercise</code> function will generate data for your specifications.  It does 10 items by default, but we can tell it to do only 5.  Let&rsquo;s see what it comes up with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/exercise</span> <span class="ss">::first-line</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(0 1 &quot;Dun&quot; &quot;Red&quot;) {:n1 0, :n2 1, :c1 &quot;Dun&quot;, :c2 &quot;Red&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Red&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Red&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Blue&quot; &quot;Dun&quot;) {:n1 1, :n2 2, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Red&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Red&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hmmm&hellip; something&rsquo;s not quite right.  Looking at the first result <code>[0 1 "Dun" Red"]</code>, it would result in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Zero</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">One</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Dun</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Red</span> <span class="nv">fish</span>
</span></code></pre></td></tr></table></div></figure>


<p>Although, it meets our criteria, it&rsquo;s missing one essential ingredient &ndash; rhyming!</p>

<p>Let&rsquo;s fix this by adding an extra predicate <code>number-rhymes-with-color?</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fish-number-rhymes-with-color?</span> <span class="p">[{</span><span class="nv">n</span> <span class="ss">:n2</span> <span class="nv">c</span> <span class="ss">:c2</span><span class="p">}]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">or</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">= </span><span class="p">[</span><span class="nv">n</span> <span class="nv">c</span><span class="p">]</span> <span class="p">[</span><span class="mi">2</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span>
</span><span class='line'>   <span class="p">(</span><span class="nb">= </span><span class="p">[</span><span class="nv">n</span> <span class="nv">c</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span> <span class="s">&quot;Dun&quot;</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll add this to our definition of <code>::first-line</code>, stating that the second number parameter should rhyme with the second color parameter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/def</span> <span class="ss">::first-line</span> <span class="p">(</span><span class="nf">s/and</span> <span class="p">(</span><span class="nf">s/cat</span> <span class="ss">:n1</span> <span class="ss">::fish-number</span> <span class="ss">:n2</span> <span class="ss">::fish-number</span> <span class="ss">:c1</span> <span class="ss">::color</span> <span class="ss">:c2</span> <span class="ss">::color</span><span class="p">)</span>
</span><span class='line'>                           <span class="nv">one-bigger?</span>
</span><span class='line'>                           <span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:c1</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c2</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>                           <span class="nv">fish-number-rhymes-with-color?</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">s/valid?</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">])</span> <span class="c1">;=&gt; true</span>
</span><span class='line'><span class="p">(</span><span class="nf">s/explain</span> <span class="ss">::first-line</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Dun&quot;</span><span class="p">])</span>
</span><span class='line'><span class="c1">;;  {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;} fails spec:</span>
</span><span class='line'><span class="c1">;;  :one-fish.core/first-line predicate: fish-number-rhymes-with-color?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s try the data generation again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/exercise</span> <span class="ss">::first-line</span><span class="p">)</span>
</span><span class='line'><span class="c1">;; ([(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Dun&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Dun&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(1 2 &quot;Red&quot; &quot;Blue&quot;) {:n1 1, :n2 2, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Red&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Red&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Dun&quot;}]</span>
</span><span class='line'><span class="c1">;;  [(0 1 &quot;Blue&quot; &quot;Dun&quot;) {:n1 0, :n2 1, :c1 &quot;Blue&quot;, :c2 &quot;Dun&quot;}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much better.  To finish things off, let&rsquo;s finally create a function to create a string for our mini-poem from our data.  While  we&rsquo;re at it, we can use our spec with <code>s/fdef</code>, to validate that the parameters are indeed in the form of <code>::first-line</code>.</p>

<h3>Using spec with functions</h3>

<p>Here&rsquo;s our function <code>fish-line</code> that takes in our values as a parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fish-line</span> <span class="p">[</span><span class="nv">n1</span> <span class="nv">n2</span> <span class="nv">c1</span> <span class="nv">c2</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">clojure.string/join</span> <span class="s">&quot; &quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">str </span><span class="nv">%</span> <span class="s">&quot; fish.&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">[(</span><span class="nb">get </span><span class="nv">fish-numbers</span> <span class="nv">n1</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">get </span><span class="nv">fish-numbers</span> <span class="nv">n2</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">c1</span>
</span><span class='line'>       <span class="nv">c2</span><span class="p">])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can specify that the args for this function be validated with <code>::first-line</code> and the return value is a string.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">s/fdef</span> <span class="nv">fish-line</span>
</span><span class='line'>        <span class="ss">:args</span> <span class="ss">::first-line</span>
</span><span class='line'>        <span class="ss">:ret</span>  <span class="nv">string?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, we turn on the instrumentation of the validation for functions and see what happens. To enable this, we need to add the <code>spec.test</code> namespace to our requires:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">one-fish.core</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.spec</span> <span class="ss">:as</span> <span class="nv">s</span><span class="p">]</span>
</span><span class='line'>            <span class="p">[</span><span class="nv">clojure.spec.test</span> <span class="ss">:as</span> <span class="nv">stest</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The instrument function takes a fully-qualified symbol so add ` before the function name  to resolve it in the context of the current namespace.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">stest/instrument</span> <span class="o">`</span><span class="nv">fish-line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fish-line</span> <span class="mi">1</span> <span class="mi">2</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">;-&gt; &quot;One fish. Two fish. Red fish. Blue fish.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But what about with bad data?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fish-line</span> <span class="mi">2</span> <span class="mi">1</span> <span class="s">&quot;Red&quot;</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">;; Call to #&#39;one-fish.core/fish-line did not conform to spec: val:</span>
</span><span class='line'> <span class="c1">;;   {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;} fails at: [:args] predicate:</span>
</span><span class='line'> <span class="c1">;;   one-bigger? :clojure.spec/args (2 1 &quot;Red&quot; &quot;Blue&quot;)</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">;;   {:clojure.spec/problems</span>
</span><span class='line'> <span class="c1">;;    {[:args]</span>
</span><span class='line'> <span class="c1">;;     {:pred one-bigger?,</span>
</span><span class='line'> <span class="c1">;;      :val {:n1 2, :n2 1, :c1 &quot;Red&quot;, :c2 &quot;Blue&quot;},</span>
</span><span class='line'> <span class="c1">;;      :via [],</span>
</span><span class='line'> <span class="c1">;;      :in []}},</span>
</span><span class='line'> <span class="c1">;;    :clojure.spec/args (2 1 &quot;Red&quot; &quot;Blue&quot;)}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ah, yes &ndash; the first number must be one smaller than the second number.</p>

<h3>Wrap up</h3>

<p>I hope you&rsquo;ve enjoyed this brief tour of clojure.spec.  If you&rsquo;re interested in learning more, you should check out the <a href="http://clojure.org/guides/spec">spec.guide</a>.  It really is an exciting, new feature to Clojure.</p>

<p>In the meantime, I&rsquo;ll leave you with one of our generated lines, sure to be a big hit with future generations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">Zero</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">One</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Red</span> <span class="nv">fish</span>
</span><span class='line'><span class="nv">Dun</span> <span class="nv">fish</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/05/29/one-fish-spec-fish//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2018

    Carin Meier
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'squidsblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
